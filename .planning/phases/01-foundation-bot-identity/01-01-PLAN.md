---
phase: 01-foundation-bot-identity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - Cargo.lock
  - turbo.json
  - package.json
  - pnpm-workspace.yaml
  - .gitignore
  - rust-toolchain.toml
  - crates/boternity-types/Cargo.toml
  - crates/boternity-types/src/lib.rs
  - crates/boternity-types/src/bot.rs
  - crates/boternity-types/src/soul.rs
  - crates/boternity-types/src/identity.rs
  - crates/boternity-types/src/secret.rs
  - crates/boternity-types/src/error.rs
  - crates/boternity-core/Cargo.toml
  - crates/boternity-core/src/lib.rs
  - crates/boternity-core/src/repository/mod.rs
  - crates/boternity-core/src/repository/bot.rs
  - crates/boternity-core/src/repository/soul.rs
  - crates/boternity-core/src/repository/secret.rs
  - crates/boternity-core/src/service/mod.rs
  - crates/boternity-infra/Cargo.toml
  - crates/boternity-infra/src/lib.rs
  - crates/boternity-api/Cargo.toml
  - crates/boternity-api/src/main.rs
autonomous: true

must_haves:
  truths:
    - "cargo build compiles all four crates without errors"
    - "boternity-core has zero dependencies on boternity-infra (cargo tree confirms)"
    - "boternity-types contains domain types for Bot, Soul, Identity, Secret with serde derives"
    - "boternity-core contains repository trait definitions (BotRepository, SoulRepository, SecretRepository)"
    - "Turborepo config exists alongside Cargo workspace without conflicts"
  artifacts:
    - path: "Cargo.toml"
      provides: "Workspace root with all four crates"
      contains: "[workspace]"
    - path: "crates/boternity-types/src/bot.rs"
      provides: "Bot domain type with BotId, BotStatus, BotCategory"
      contains: "pub struct Bot"
    - path: "crates/boternity-types/src/soul.rs"
      provides: "Soul domain types with SoulVersion, SoulHash"
      contains: "pub struct Soul"
    - path: "crates/boternity-core/src/repository/bot.rs"
      provides: "BotRepository trait definition"
      contains: "pub trait BotRepository"
    - path: "turbo.json"
      provides: "Turborepo config for JS/TS packages only"
  key_links:
    - from: "crates/boternity-core/Cargo.toml"
      to: "crates/boternity-types"
      via: "dependency"
      pattern: 'boternity-types.*workspace.*true'
    - from: "crates/boternity-infra/Cargo.toml"
      to: "crates/boternity-core"
      via: "dependency"
      pattern: 'boternity-core.*workspace.*true'
    - from: "crates/boternity-api/Cargo.toml"
      to: "crates/boternity-core"
      via: "dependency"
      pattern: 'boternity-core.*workspace.*true'
---

<objective>
Scaffold the Turborepo + Cargo workspace monorepo with all four Rust crates (boternity-types, boternity-core, boternity-infra, boternity-api) and establish the foundational domain types and repository trait definitions.

Purpose: Every other plan in Phase 1 depends on the crate structure existing. This is the skeleton that all business logic, storage, and API code will live in.
Output: A compiling workspace with domain types in boternity-types, repository traits in boternity-core, and empty shells for boternity-infra and boternity-api.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-bot-identity/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create monorepo scaffold with Cargo workspace and Turborepo config</name>
  <files>
    Cargo.toml
    rust-toolchain.toml
    turbo.json
    package.json
    pnpm-workspace.yaml
    .gitignore
    crates/boternity-types/Cargo.toml
    crates/boternity-core/Cargo.toml
    crates/boternity-infra/Cargo.toml
    crates/boternity-api/Cargo.toml
  </files>
  <action>
    Create the root Cargo.toml as a workspace with resolver = "3" and edition = "2024":
    - members: crates/boternity-types, crates/boternity-core, crates/boternity-infra, crates/boternity-api
    - [workspace.package]: version = "0.1.0", edition = "2024", license = "MIT"
    - [workspace.dependencies]: Define ALL shared dependencies from RESEARCH.md (axum 0.8, sqlx 0.8, clap 4.5, tokio 1, serde 1, serde_json 1, uuid 1.20, chrono 0.4, tracing 0.1, tracing-subscriber 0.3, tower-http 0.6, keyring 3.6, aes-gcm 0.10, argon2 0.5, sha2 0.10, thiserror 1, anyhow 1). Use exact feature flags from RESEARCH.md.

    Create rust-toolchain.toml pinning to stable channel with edition 2024 support.

    Create individual crate Cargo.toml files with STRICT dependency rules:
    - boternity-types: serde, serde_json, uuid, chrono, thiserror ONLY (zero infra deps)
    - boternity-core: boternity-types (workspace), thiserror, tracing ONLY (zero infra deps, zero sqlx)
    - boternity-infra: boternity-types (workspace), boternity-core (workspace), sqlx, keyring, aes-gcm, argon2, sha2, tokio, tracing, thiserror, anyhow, chrono
    - boternity-api: boternity-types (workspace), boternity-core (workspace), boternity-infra (workspace), axum, tokio, clap, serde, serde_json, tower-http, tracing, tracing-subscriber, anyhow, uuid, chrono

    Create Turborepo files (turbo.json, package.json, pnpm-workspace.yaml):
    - turbo.json: minimal config with "build" and "lint" pipelines. The pipelines reference ONLY packages in apps/ and packages/ (future JS/TS). Do NOT include crates/.
    - package.json: name "boternity", private true, scripts including "build:rust": "cargo build", "test:rust": "cargo test", "check": "cargo check"
    - pnpm-workspace.yaml: packages: ["apps/*", "packages/*"]

    Create .gitignore with: target/, node_modules/, .env, *.db, *.db-wal, *.db-shm, .sqlx/ (but NOT .planning/)

    CRITICAL: boternity-core's Cargo.toml must NOT contain boternity-infra, sqlx, or any database/IO crate as a dependency. This is the clean architecture boundary.
  </action>
  <verify>
    Run `cargo check` from workspace root -- must compile with zero errors.
    Run `cargo tree -p boternity-core | grep boternity-infra` -- must return empty (no infra dependency).
    Verify turbo.json exists and does not reference crates/ directory.
  </verify>
  <done>
    All four crates exist with correct dependency hierarchy. cargo check passes. boternity-core has zero dependencies on boternity-infra. Turborepo config coexists with Cargo workspace.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define domain types and repository traits</name>
  <files>
    crates/boternity-types/src/lib.rs
    crates/boternity-types/src/bot.rs
    crates/boternity-types/src/soul.rs
    crates/boternity-types/src/identity.rs
    crates/boternity-types/src/secret.rs
    crates/boternity-types/src/error.rs
    crates/boternity-core/src/lib.rs
    crates/boternity-core/src/repository/mod.rs
    crates/boternity-core/src/repository/bot.rs
    crates/boternity-core/src/repository/soul.rs
    crates/boternity-core/src/repository/secret.rs
    crates/boternity-core/src/service/mod.rs
    crates/boternity-infra/src/lib.rs
    crates/boternity-api/src/main.rs
  </files>
  <action>
    In boternity-types, create domain types per CONTEXT.md decisions:

    bot.rs:
    - BotId(Uuid) newtype with ::new() using Uuid::now_v7()
    - Bot struct: id (BotId), slug (String), name (String), description (String), status (BotStatus), category (BotCategory), tags (Vec&lt;String&gt;), user_id (Option&lt;String&gt; for future multi-user), conversation_count (i64), total_tokens_used (i64), version_count (i32), created_at (DateTime&lt;Utc&gt;), updated_at (DateTime&lt;Utc&gt;), last_active_at (Option&lt;DateTime&lt;Utc&gt;&gt;)
    - BotStatus enum: Active, Disabled, Archived (with Display, FromStr implementations)
    - BotCategory enum: Assistant, Creative, Research, Utility (system categories per CONTEXT.md)
    - CreateBotRequest struct: name (String), description (Option&lt;String&gt;), category (Option&lt;BotCategory&gt;), tags (Option&lt;Vec&lt;String&gt;&gt;)
    - Implement slug generation: slugify name ("Research Assistant" -> "research-assistant"), lowercase, replace non-alphanumeric with hyphens, collapse multiple hyphens
    - All types derive: Debug, Clone, Serialize, Deserialize. Do NOT derive sqlx::FromRow (that belongs in infra).

    soul.rs:
    - SoulId(Uuid) newtype
    - Soul struct: id (SoulId), bot_id (BotId), content (String), hash (String -- SHA-256 hex), version (i32), created_at (DateTime&lt;Utc&gt;)
    - SoulFrontmatter struct: name (String), traits (Vec&lt;String&gt;), tone (String) -- parsed from YAML frontmatter
    - SoulVersion struct: version (i32), hash (String), content (String), created_at (DateTime&lt;Utc&gt;), message (Option&lt;String&gt;)

    identity.rs:
    - Identity struct: bot_id (BotId), display_name (String), avatar (Option&lt;String&gt;), accent_color (Option&lt;String&gt;), emoji (Option&lt;String&gt;), model (String -- default "claude-sonnet-4-20250514"), provider (String -- default "anthropic"), temperature (f64 -- default 0.7), max_tokens (i32 -- default 4096), category (BotCategory), tags (Vec&lt;String&gt;)

    secret.rs:
    - SecretKey(String) newtype
    - SecretEntry struct: key (SecretKey), provider (SecretProvider), scope (SecretScope), created_at (DateTime&lt;Utc&gt;), updated_at (DateTime&lt;Utc&gt;)
    - SecretProvider enum: Vault, Keychain, Environment
    - SecretScope enum: Global, Bot(BotId)
    - Implement custom Debug for any type that might hold secret values -- redact with "***"

    error.rs:
    - BotError enum using thiserror: NotFound, SlugConflict, InvalidStatus, InvalidName, StorageError(String)
    - SoulError enum: NotFound, HashMismatch { expected, actual }, IntegrityViolation, StorageError(String)
    - SecretError enum: NotFound, ProviderUnavailable, EncryptionError, StorageError(String)
    - RepositoryError enum: Connection, Query(String), NotFound, Conflict(String)

    In boternity-core, create repository traits:

    repository/bot.rs:
    - pub trait BotRepository: Send + Sync with async methods returning Result&lt;_, RepositoryError&gt;:
      create(&self, bot: &Bot) -> Bot
      get_by_id(&self, id: &BotId) -> Option&lt;Bot&gt;
      get_by_slug(&self, slug: &str) -> Option&lt;Bot&gt;
      list(&self, filter: Option&lt;BotFilter&gt;) -> Vec&lt;Bot&gt;
      update(&self, bot: &Bot) -> Bot
      delete(&self, id: &BotId) -> ()
    - BotFilter struct: status (Option&lt;BotStatus&gt;), category (Option&lt;BotCategory&gt;), sort_by (Option&lt;String&gt;), sort_order (Option&lt;SortOrder&gt;), limit (Option&lt;i64&gt;), offset (Option&lt;i64&gt;)
    - Use native async fn in traits (Rust 2024 edition, no async_trait macro)

    repository/soul.rs:
    - pub trait SoulRepository: Send + Sync:
      save_version(&self, soul: &Soul) -> Soul
      get_current(&self, bot_id: &BotId) -> Option&lt;Soul&gt;
      get_version(&self, bot_id: &BotId, version: i32) -> Option&lt;Soul&gt;
      list_versions(&self, bot_id: &BotId) -> Vec&lt;SoulVersion&gt;
      get_stored_hash(&self, bot_id: &BotId) -> Option&lt;String&gt;

    repository/secret.rs:
    - pub trait SecretProvider: Send + Sync:
      get(&self, key: &str, scope: &SecretScope) -> Option&lt;String&gt;
      set(&self, key: &str, value: &str, scope: &SecretScope) -> ()
      delete(&self, key: &str, scope: &SecretScope) -> ()
      list(&self, scope: &SecretScope) -> Vec&lt;SecretEntry&gt;

    service/mod.rs: Empty module declarations for future BotService, SoulService, SecretService (just pub mod declarations, implementations come in Plan 03/04).

    In boternity-infra/src/lib.rs: Empty module with doc comment about being the infrastructure layer.
    In boternity-api/src/main.rs: Minimal main function that prints "Boternity starting..." and exits (placeholder).
  </action>
  <verify>
    Run `cargo build` -- must compile all four crates without errors.
    Run `cargo test` -- must pass (even if no tests yet, no compile errors in test mode).
    Run `cargo tree -p boternity-core` -- verify only boternity-types appears as a dependency, no sqlx/infra crates.
  </verify>
  <done>
    All domain types defined with correct fields per CONTEXT.md decisions. Repository traits defined in boternity-core using native async fn (no async_trait). boternity-core depends only on boternity-types. Entire workspace compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cargo check` passes for entire workspace
2. `cargo build` succeeds
3. `cargo tree -p boternity-core | grep -q boternity-infra` returns exit code 1 (no match = dependency boundary enforced)
4. `ls crates/boternity-types/src/ crates/boternity-core/src/repository/` shows all expected files
5. `cat turbo.json` shows no reference to crates/
</verification>

<success_criteria>
- Four Rust crates compile in a workspace with correct dependency hierarchy
- Domain types cover Bot, Soul, Identity, Secret with all fields from CONTEXT.md
- Repository traits exist for all three domains (Bot, Soul, Secret) using native async
- Turborepo config coexists without conflicting with Cargo workspace
- boternity-core has ZERO dependencies on boternity-infra or any database crate
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-bot-identity/01-01-SUMMARY.md`
</output>
