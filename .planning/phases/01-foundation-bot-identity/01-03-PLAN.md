---
phase: 01-foundation-bot-identity
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - crates/boternity-core/src/service/bot.rs
  - crates/boternity-core/src/service/soul.rs
  - crates/boternity-core/src/service/mod.rs
  - crates/boternity-infra/src/filesystem/mod.rs
  - crates/boternity-infra/src/filesystem/soul.rs
  - crates/boternity-infra/src/filesystem/identity.rs
  - crates/boternity-infra/src/filesystem/user.rs
  - crates/boternity-infra/src/crypto/mod.rs
  - crates/boternity-infra/src/crypto/hash.rs
  - crates/boternity-infra/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Creating a bot with just a name produces a complete bot with SOUL.md, IDENTITY.md, and USER.md files on disk"
    - "Default SOUL.md has a human-like personality template (not generic bot/assistant persona)"
    - "SOUL.md has YAML frontmatter (name, traits, tone) plus markdown body"
    - "Bot slug is auto-generated from name and enforced unique"
    - "SHA-256 hash of SOUL.md content is computed and stored alongside the soul version"
  artifacts:
    - path: "crates/boternity-core/src/service/bot.rs"
      provides: "BotService orchestrating bot creation with identity files"
      contains: "pub struct BotService"
    - path: "crates/boternity-core/src/service/soul.rs"
      provides: "SoulService managing soul content and hashing"
      contains: "pub struct SoulService"
    - path: "crates/boternity-infra/src/filesystem/soul.rs"
      provides: "SOUL.md file read/write operations"
      contains: "write_soul"
    - path: "crates/boternity-infra/src/filesystem/identity.rs"
      provides: "IDENTITY.md file read/write operations"
      contains: "write_identity"
    - path: "crates/boternity-infra/src/crypto/hash.rs"
      provides: "SHA-256 hashing for SOUL.md integrity"
      contains: "compute_hash"
  key_links:
    - from: "crates/boternity-core/src/service/bot.rs"
      to: "crates/boternity-core/src/repository/bot.rs"
      via: "BotRepository trait usage"
      pattern: "BotRepository"
    - from: "crates/boternity-core/src/service/bot.rs"
      to: "crates/boternity-core/src/service/soul.rs"
      via: "SoulService for initial soul creation"
      pattern: "SoulService"
    - from: "crates/boternity-infra/src/crypto/hash.rs"
      to: "sha2::Sha256"
      via: "SHA-256 digest computation"
      pattern: "Sha256::digest"
---

<objective>
Implement the bot identity system: BotService and SoulService in boternity-core, filesystem operations for SOUL.md/IDENTITY.md/USER.md, and SHA-256 hashing. Creating a bot with just a name produces a fully-formed bot with all three identity files on disk.

Purpose: This is the heart of Phase 1 -- bots are defined by their identity files. Every subsequent feature (CLI, API, versioning) operates on the bot + identity system built here.
Output: Working BotService that creates bots with identity files, SoulService that manages soul content with SHA-256 integrity, filesystem module for file I/O.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-bot-identity/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation-bot-identity/01-01-SUMMARY.md
@.planning/phases/01-foundation-bot-identity/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BotService and SoulService in boternity-core</name>
  <files>
    crates/boternity-core/src/service/bot.rs
    crates/boternity-core/src/service/soul.rs
    crates/boternity-core/src/service/mod.rs
  </files>
  <action>
    Implement BotService (service/bot.rs):
    - pub struct BotService with fields: bot_repo (Arc&lt;dyn BotRepository&gt;), soul_repo (Arc&lt;dyn SoulRepository&gt;), data_dir (PathBuf)
    - IMPORTANT: BotService is in boternity-core, so it uses trait objects (dyn BotRepository), NOT concrete SqliteBotRepository. This is the dependency inversion.
    - The data_dir field requires a trait abstraction. Define a FileSystem trait in boternity-core:
      pub trait FileSystem: Send + Sync {
          async fn write_file(&self, path: &Path, content: &str) -> Result&lt;(), std::io::Error&gt;;
          async fn read_file(&self, path: &Path) -> Result&lt;String, std::io::Error&gt;;
          async fn create_dir_all(&self, path: &Path) -> Result&lt;(), std::io::Error&gt;;
          async fn exists(&self, path: &Path) -> bool;
          async fn remove_dir_all(&self, path: &Path) -> Result&lt;(), std::io::Error&gt;;
      }
    - Add fs: Arc&lt;dyn FileSystem&gt; to BotService instead of data_dir directly.
    - create_bot(request: CreateBotRequest) -> Result&lt;Bot, BotError&gt;:
      1. Generate slug from name (slugify: lowercase, replace spaces/special chars with hyphens, collapse multiples, trim leading/trailing hyphens)
      2. Check slug uniqueness via bot_repo.get_by_slug() -- if conflict, append -2, -3, etc.
      3. Create Bot struct with defaults: status=Active, category=request.category.unwrap_or(Assistant), tags=request.tags.unwrap_or_default()
      4. Save bot to database via bot_repo.create()
      5. Create bot directory: {data_dir}/bots/{slug}/
      6. Generate default SOUL.md content via SoulService::generate_default_soul(name)
      7. Write SOUL.md to disk
      8. Generate and write default IDENTITY.md
      9. Generate and write default USER.md
      10. Compute SHA-256 hash of SOUL.md content
      11. Save initial soul version to database via soul_repo.save_version()
      12. Return created bot
    - get_bot(id: &BotId) -> Result&lt;Option&lt;Bot&gt;, BotError&gt;
    - get_bot_by_slug(slug: &str) -> Result&lt;Option&lt;Bot&gt;, BotError&gt;
    - list_bots(filter: Option&lt;BotFilter&gt;) -> Result&lt;Vec&lt;Bot&gt;, BotError&gt;
    - update_bot(id: &BotId, updates: UpdateBotRequest) -> Result&lt;Bot, BotError&gt;
    - delete_bot(id: &BotId) -> Result&lt;(), BotError&gt;: Delete from database (cascades) AND remove bot directory from filesystem
    - clone_bot(source_id: &BotId, new_name: String) -> Result&lt;Bot, BotError&gt;: Copy soul + identity files, not history per CONTEXT.md

    Add UpdateBotRequest to boternity-types: name (Option), description (Option), status (Option&lt;BotStatus&gt;), category (Option), tags (Option&lt;Vec&lt;String&gt;&gt;)

    Implement SoulService (service/soul.rs):
    - pub struct SoulService with: soul_repo (Arc&lt;dyn SoulRepository&gt;), fs (Arc&lt;dyn FileSystem&gt;), hasher (Arc&lt;dyn ContentHasher&gt;)
    - Define ContentHasher trait in boternity-core:
      pub trait ContentHasher: Send + Sync {
          fn compute_hash(&self, content: &[u8]) -> String;
      }
    - generate_default_soul(name: &str) -> String:
      Return a SOUL.md template with YAML frontmatter + markdown body. The default personality should be HUMAN-LIKE, not a generic bot persona (per CONTEXT.md: "bots should feel like people, not tools"). Example:
      ```
      ---
      name: {name}
      traits:
        - curious
        - thoughtful
        - direct
      tone: warm and conversational
      ---

      # {name}

      I'm {name}. I approach conversations with genuine curiosity and care about getting things right.

      ## Boundaries

      <!-- Uncomment and customize sections below -->
      <!-- - I won't do X because Y -->

      ## Expertise

      <!-- What am I particularly good at? -->

      ## Backstory

      <!-- What's my story? What shaped who I am? -->
      ```
    - generate_default_identity(name: &str, category: &BotCategory) -> String:
      Return an IDENTITY.md with all config fields and sensible defaults. Include avatar placeholder, random accent color from a palette, random emoji from a curated list of personality emojis.
    - generate_default_user() -> String:
      Return a USER.md template:
      ```
      # About Me

      <!-- Tell your bot about yourself here -->
      <!-- This file is for YOUR context -- preferences, standing instructions, important details -->
      <!-- Your bot reads this at the start of every conversation -->

      ## Preferences

      ## Standing Instructions

      ## Important Context
      ```
    - get_current_soul(bot_id: &BotId) -> Result&lt;Option&lt;Soul&gt;, SoulError&gt;
    - get_soul_versions(bot_id: &BotId) -> Result&lt;Vec&lt;SoulVersion&gt;, SoulError&gt;
    - verify_soul_integrity(bot_id: &BotId, soul_path: &Path) -> Result&lt;bool, SoulError&gt;:
      1. Read SOUL.md from disk
      2. Compute SHA-256 hash
      3. Compare with stored hash from soul_repo.get_stored_hash()
      4. Return true if match, false if mismatch

    Update service/mod.rs to declare pub mod bot; pub mod soul;
  </action>
  <verify>
    Run `cargo build -p boternity-core` -- compiles without errors.
    Run `cargo tree -p boternity-core | grep -E "sqlx|boternity-infra"` -- must return empty (no infra leakage).
    Verify BotService and SoulService use only trait objects, no concrete types from infra.
  </verify>
  <done>
    BotService creates bots with slug generation, uniqueness enforcement, and delegates to SoulService for identity files. SoulService generates human-like default SOUL.md, IDENTITY.md, and USER.md templates. ContentHasher and FileSystem traits defined in core. boternity-core still has zero infra dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement filesystem and hashing adapters in boternity-infra</name>
  <files>
    crates/boternity-infra/src/filesystem/mod.rs
    crates/boternity-infra/src/filesystem/soul.rs
    crates/boternity-infra/src/filesystem/identity.rs
    crates/boternity-infra/src/filesystem/user.rs
    crates/boternity-infra/src/crypto/mod.rs
    crates/boternity-infra/src/crypto/hash.rs
    crates/boternity-infra/src/lib.rs
  </files>
  <action>
    Implement LocalFileSystem in filesystem/mod.rs:
    - pub struct LocalFileSystem { base_dir: PathBuf }
    - impl FileSystem (from boternity-core trait) for LocalFileSystem
    - ::new(base_dir: PathBuf) constructor
    - write_file: tokio::fs::write
    - read_file: tokio::fs::read_to_string
    - create_dir_all: tokio::fs::create_dir_all
    - exists: tokio::fs::try_exists
    - remove_dir_all: tokio::fs::remove_dir_all
    - Helper: pub fn bot_dir(&self, slug: &str) -> PathBuf { self.base_dir.join("bots").join(slug) }
    - Helper: pub fn soul_path(&self, slug: &str) -> PathBuf { self.bot_dir(slug).join("SOUL.md") }
    - Helper: pub fn identity_path(&self, slug: &str) -> PathBuf { self.bot_dir(slug).join("IDENTITY.md") }
    - Helper: pub fn user_path(&self, slug: &str) -> PathBuf { self.bot_dir(slug).join("USER.md") }

    Implement soul/identity/user file operations:
    - filesystem/soul.rs: Functions for reading/writing/parsing SOUL.md files
      - parse_soul_frontmatter(content: &str) -> Result&lt;SoulFrontmatter, ParseError&gt;: Parse YAML between --- delimiters
      - extract_body(content: &str) -> &str: Everything after the second ---
    - filesystem/identity.rs: Functions for reading/writing/parsing IDENTITY.md
      - parse_identity(content: &str) -> Result&lt;Identity, ParseError&gt;: Parse YAML frontmatter for config fields
    - filesystem/user.rs: Functions for reading/writing USER.md (simple read/write, no parsing needed)

    Implement Sha256ContentHasher in crypto/hash.rs:
    - pub struct Sha256ContentHasher;
    - impl ContentHasher (from boternity-core trait) for Sha256ContentHasher
    - compute_hash(&self, content: &[u8]) -> String: Use sha2::Sha256::digest, format as lowercase hex
    - Also provide: pub async fn compute_file_hash(path: &Path) -> Result&lt;String, std::io::Error&gt; as a standalone function for verifying files on disk

    Update lib.rs to declare pub mod filesystem; pub mod crypto;

    Add required dependencies to boternity-infra/Cargo.toml if not already present: sha2, tokio (with fs feature).

    Support BOTERNITY_DATA_DIR env var (per Claude's discretion): Create a helper function:
    pub fn resolve_data_dir() -> PathBuf {
        std::env::var("BOTERNITY_DATA_DIR")
            .map(PathBuf::from)
            .unwrap_or_else(|_| dirs::home_dir().unwrap().join(".boternity"))
    }
    Add `dirs` crate to dependencies for cross-platform home directory resolution.
  </action>
  <verify>
    Run `cargo build -p boternity-infra` -- compiles without errors.
    Run `cargo test -p boternity-infra` -- write tests that:
    1. Create a LocalFileSystem with a temp directory
    2. Write a SOUL.md file and read it back
    3. Parse SOUL.md frontmatter from a sample file
    4. Compute SHA-256 hash and verify it matches expected value
    5. Verify bot_dir/soul_path/identity_path helpers return correct paths
    Run `cargo build` for the whole workspace to ensure integration.
  </verify>
  <done>
    LocalFileSystem implements the FileSystem trait from core. SOUL.md/IDENTITY.md/USER.md read/write operations work. SHA-256 hashing implemented via Sha256ContentHasher. BOTERNITY_DATA_DIR environment variable respected for data directory location. All adapters tested.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` passes for entire workspace
2. `cargo test -p boternity-core -p boternity-infra` -- all tests pass
3. `cargo tree -p boternity-core | grep -E "sqlx|boternity-infra"` returns empty
4. Creating a BotService with mock implementations would work (traits are properly defined)
5. Default SOUL.md content has YAML frontmatter with name/traits/tone and a human-like personality
6. SHA-256 hash of known content matches expected hex value
</verification>

<success_criteria>
- BotService orchestrates full bot creation: slug generation, database save, identity file creation
- SoulService generates human-like default souls (not generic bot/assistant persona)
- SOUL.md format: YAML frontmatter (name, traits, tone) + free-form markdown body
- IDENTITY.md contains model config with sensible defaults
- USER.md is a clean template (never auto-populated)
- SHA-256 hashing works for soul integrity verification
- FileSystem trait in core, LocalFileSystem adapter in infra (dependency inversion maintained)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-bot-identity/01-03-SUMMARY.md`
</output>
