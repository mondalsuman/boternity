---
phase: 02-single-agent-chat-llm
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/boternity-observe/Cargo.toml
  - crates/boternity-observe/src/lib.rs
  - crates/boternity-observe/src/tracing_setup.rs
  - crates/boternity-observe/src/genai_attrs.rs
autonomous: true

must_haves:
  truths:
    - "Tracing subscriber initializes with structured logging and optional OTel export"
    - "GenAI semantic convention constants are available for LLM call instrumentation"
    - "All new Phase 2 workspace dependencies are declared and resolve correctly"
  artifacts:
    - path: "crates/boternity-observe/src/tracing_setup.rs"
      provides: "init_tracing() function with OTel layer support"
      contains: "pub fn init_tracing"
    - path: "crates/boternity-observe/src/genai_attrs.rs"
      provides: "OTel GenAI semantic convention attribute constants"
      contains: "GEN_AI_OPERATION_NAME"
    - path: "Cargo.toml"
      provides: "All Phase 2 workspace dependencies"
      contains: "reqwest-eventsource"
  key_links:
    - from: "crates/boternity-observe/src/tracing_setup.rs"
      to: "tracing-opentelemetry"
      via: "OTel bridge layer"
      pattern: "tracing_opentelemetry::layer"
---

<objective>
Create the boternity-observe crate for structured logging and OpenTelemetry integration, and add all Phase 2 workspace dependencies.

Purpose: Observability is a cross-cutting concern needed by every other plan. Adding workspace deps now unblocks all downstream plans. The observe crate provides the tracing setup that will be wired into the CLI and API entry points.

Output: New boternity-observe crate with tracing initialization and GenAI attribute constants. Updated workspace Cargo.toml with all Phase 2 dependencies.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-single-agent-chat-llm/02-RESEARCH.md
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add all Phase 2 workspace dependencies</name>
  <files>
    Cargo.toml
  </files>
  <action>
Add the following new dependencies to the `[workspace.dependencies]` section of the root Cargo.toml. Keep existing deps untouched. Group new deps with comments.

```toml
# LLM provider HTTP + streaming
reqwest = { version = "0.12", features = ["json", "stream"] }
reqwest-eventsource = "0.6"
eventsource-stream = "0.2"
async-stream = "0.3"
futures-util = "0.3"

# Terminal rendering
termimad = "0.34"
syntect = { version = "5", default-features = false, features = ["default-fancy"] }

# Async CLI input
rustyline-async = "0.4"

# Crossterm (terminal manipulation)
crossterm = "0.28"

# Secret wrapping for API keys
secrecy = { version = "0.10", features = ["serde"] }

# Pin projection for custom stream types
pin-project-lite = "0.2"

# OpenTelemetry
opentelemetry = "0.31"
opentelemetry_sdk = "0.31"
opentelemetry-stdout = "0.31"
tracing-opentelemetry = "0.32"
```

Also add the new crate to the workspace members:
```toml
members = [
    "crates/boternity-types",
    "crates/boternity-core",
    "crates/boternity-infra",
    "crates/boternity-api",
    "crates/boternity-observe",
]
```

And add the workspace reference:
```toml
boternity-observe = { path = "crates/boternity-observe" }
```
  </action>
  <verify>
Run `cargo check --workspace` (may fail until observe crate exists -- that's fine, verify the Cargo.toml parses with `cargo metadata --format-version 1 | head -1` or just proceed to Task 2).
  </verify>
  <done>All Phase 2 workspace dependencies are declared in root Cargo.toml. The boternity-observe crate is listed as a workspace member.</done>
</task>

<task type="auto">
  <name>Task 2: Create boternity-observe crate with tracing setup and GenAI attributes</name>
  <files>
    crates/boternity-observe/Cargo.toml
    crates/boternity-observe/src/lib.rs
    crates/boternity-observe/src/tracing_setup.rs
    crates/boternity-observe/src/genai_attrs.rs
  </files>
  <action>
Create a new crate `boternity-observe` for observability infrastructure.

**Cargo.toml:**
```toml
[package]
name = "boternity-observe"
version.workspace = true
edition.workspace = true
license.workspace = true

[dependencies]
tracing = { workspace = true }
tracing-subscriber = { workspace = true }
tracing-opentelemetry = { workspace = true }
opentelemetry = { workspace = true }
opentelemetry_sdk = { workspace = true }
opentelemetry-stdout = { workspace = true }
```

**lib.rs:**
```rust
pub mod tracing_setup;
pub mod genai_attrs;
```

**tracing_setup.rs:**
Create `init_tracing(enable_otel: bool) -> Result<(), Box<dyn std::error::Error>>`:
- Always install a `tracing_subscriber::fmt::layer()` with:
  - `.with_target(true)` for module path visibility
  - `.with_span_events(FmtSpan::CLOSE)` for span timing
- When `enable_otel` is true:
  - Create an `SdkTracerProvider` with `opentelemetry_stdout::SpanExporter` (for local dev -- traces go to stdout/file)
  - Create a `tracing_opentelemetry::layer()` with the tracer
  - Compose both layers with `tracing_subscriber::registry()` + `EnvFilter::from_default_env()`
- When `enable_otel` is false:
  - Just the fmt layer + EnvFilter
- Follow the code example from RESEARCH.md (Pattern 6: OpenTelemetry GenAI Semantic Conventions, tracing setup section)

Also create `pub fn shutdown_tracing()` that calls `opentelemetry::global::shutdown_tracer_provider()` for clean exit.

**genai_attrs.rs:**
Define constants following OTel GenAI Semantic Conventions (documented in RESEARCH.md):
```rust
// Span naming convention: "{operation} {model}"
// e.g., "chat claude-sonnet-4-20250514"

// Required attributes
pub const GEN_AI_OPERATION_NAME: &str = "gen_ai.operation.name";
pub const GEN_AI_PROVIDER_NAME: &str = "gen_ai.provider.name";

// Recommended attributes
pub const GEN_AI_REQUEST_MODEL: &str = "gen_ai.request.model";
pub const GEN_AI_REQUEST_TEMPERATURE: &str = "gen_ai.request.temperature";
pub const GEN_AI_REQUEST_MAX_TOKENS: &str = "gen_ai.request.max_tokens";
pub const GEN_AI_USAGE_INPUT_TOKENS: &str = "gen_ai.usage.input_tokens";
pub const GEN_AI_USAGE_OUTPUT_TOKENS: &str = "gen_ai.usage.output_tokens";
pub const GEN_AI_RESPONSE_FINISH_REASONS: &str = "gen_ai.response.finish_reasons";
pub const GEN_AI_RESPONSE_ID: &str = "gen_ai.response.id";

// Agent-specific attributes
pub const GEN_AI_AGENT_ID: &str = "gen_ai.agent.id";
pub const GEN_AI_AGENT_NAME: &str = "gen_ai.agent.name";

// Operation name values
pub const OP_CHAT: &str = "chat";
pub const OP_INVOKE_AGENT: &str = "invoke_agent";
pub const OP_EXTRACT_MEMORY: &str = "extract_memory";
pub const OP_GENERATE_TITLE: &str = "generate_title";
pub const OP_SUMMARIZE_CONTEXT: &str = "summarize_context";

// Provider name values
pub const PROVIDER_ANTHROPIC: &str = "anthropic";
```

All constants are `pub const` string slices, usable in `tracing::span!` and `tracing::info_span!` field names.
  </action>
  <verify>
Run `cargo check -p boternity-observe` -- the crate compiles. Run `cargo check --workspace` -- no workspace-level errors.
  </verify>
  <done>boternity-observe crate exists with init_tracing() supporting structured logging and optional OTel export. GenAI semantic convention constants are defined for consistent LLM call instrumentation across the codebase.</done>
</task>

</tasks>

<verification>
1. `cargo check --workspace` passes
2. boternity-observe crate exists at crates/boternity-observe/
3. All Phase 2 dependencies resolve (reqwest, reqwest-eventsource, termimad, syntect, rustyline-async, crossterm, secrecy, opentelemetry stack)
4. init_tracing(false) compiles (basic structured logging)
5. init_tracing(true) compiles (with OTel layer)
6. GenAI attribute constants match OTel specification names
</verification>

<success_criteria>
- New boternity-observe crate compiles and is a workspace member
- All Phase 2 workspace deps are declared and resolve
- init_tracing() provides structured logging with optional OTel
- GenAI semantic convention constants are accessible
- `cargo check --workspace` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-single-agent-chat-llm/02-02-SUMMARY.md`
</output>
