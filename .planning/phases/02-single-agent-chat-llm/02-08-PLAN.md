---
phase: 02-single-agent-chat-llm
plan: 08
type: execute
wave: 4
depends_on: ["02-04"]
files_modified:
  - crates/boternity-api/src/cli/session.rs
  - crates/boternity-api/src/cli/memory.rs
  - crates/boternity-api/src/cli/mod.rs
  - crates/boternity-api/src/main.rs
autonomous: true

must_haves:
  truths:
    - "User can list past sessions for a bot with date, duration, title, and message preview"
    - "User can export a session as Markdown or JSON"
    - "User can delete a session with confirmation"
    - "User can list all memories for a bot with provenance"
    - "User can manually inject a memory via CLI"
    - "User can delete individual memories or wipe all memories for a bot"
  artifacts:
    - path: "crates/boternity-api/src/cli/session.rs"
      provides: "Session browser, export, and delete commands"
      contains: "pub async fn list_sessions"
    - path: "crates/boternity-api/src/cli/memory.rs"
      provides: "Memory browser, inject, and wipe commands"
      contains: "pub async fn list_memories"
  key_links:
    - from: "crates/boternity-api/src/cli/session.rs"
      to: "crates/boternity-core/src/chat/service.rs"
      via: "uses ChatService for session queries"
      pattern: "chat_service"
    - from: "crates/boternity-api/src/cli/memory.rs"
      to: "crates/boternity-core/src/memory/store.rs"
      via: "uses MemoryRepository for memory queries"
      pattern: "memory_repo|MemoryRepository"
    - from: "crates/boternity-api/src/main.rs"
      to: "crates/boternity-api/src/cli/session.rs"
      via: "Commands::Sessions dispatches to session module"
      pattern: "Commands::Sessions|list_sessions"
---

<objective>
Add CLI commands for browsing sessions, exporting conversations, and managing bot memories.

Purpose: These commands complete the session lifecycle and memory management experience. Users can review past conversations, export them for reference, and manage the bot's accumulated knowledge. Per locked decisions: session browser, session export, session delete, memory browser, manual memory injection, and memory wipe.

Output: `bnity sessions <bot>`, `bnity export session <id>`, `bnity delete session <id>`, `bnity memories <bot>`, `bnity remember <bot> 'fact'`, `bnity forget <bot>` CLI commands.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-single-agent-chat-llm/02-RESEARCH.md
@.planning/phases/02-single-agent-chat-llm/02-CONTEXT.md
@.planning/phases/02-single-agent-chat-llm/02-04-SUMMARY.md
@crates/boternity-api/src/main.rs
@crates/boternity-api/src/cli/mod.rs
@crates/boternity-api/src/cli/bot.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement session browser, export, and delete commands</name>
  <files>
    crates/boternity-api/src/cli/session.rs
  </files>
  <action>
Follow the patterns from cli/bot.rs for consistent CLI styling (console crate, comfy-table, JSON output support).

**list_sessions(state, bot_slug, json):**
Per locked decision: "bnity sessions <bot> lists past sessions with date, duration, title, and preview of first/last messages"
- Resolve bot by slug
- Fetch sessions from chat_service.list_sessions(bot_id, None, None)
- If --json: output JSON array
- Else: display styled table with columns: Title (or "Untitled"), Started, Duration, Messages, Status
  - Duration: calculate from started_at to ended_at (or "active" if no ended_at)
  - Truncate title to 40 chars
  - Show first 3-4 sessions' first message preview (fetch first message for each)
  - Use comfy-table for consistent layout with Phase 1

**export_session(state, session_id, json_format):**
Per locked decision: "Both Markdown (human-readable, default) and JSON (--json flag, full metadata)"
- Fetch session by ID
- Fetch all messages for session
- If --json: output full JSON with session metadata + messages array
- Else (Markdown default):
  ```markdown
  # {title or "Untitled Session"}
  **Bot:** {bot_name}  **Model:** {model}  **Date:** {date}
  **Duration:** {duration}  **Messages:** {count}  **Tokens:** {total}

  ---

  **You** ({timestamp}):
  {user message}

  **{bot_name}** ({timestamp}):
  {assistant message}

  ...
  ```
- Print to stdout (user can redirect to file with `>`)

**delete_session(state, session_id, force):**
Per locked decision: "bnity delete session <id> with confirmation prompt, consistent with bot delete pattern from Phase 1"
- Fetch session to verify it exists
- If not --force: prompt confirmation with dialoguer::Confirm
- Delete session (CASCADE deletes messages and memories linked to session)
- Print success message
  </action>
  <verify>
Run `cargo check -p boternity-api` -- session commands compile. Verify the output format matches Phase 1 CLI styling patterns (console colors, comfy-table).
  </verify>
  <done>Session browser lists past sessions in a styled table. Export produces Markdown or JSON. Delete has confirmation consistent with bot delete.</done>
</task>

<task type="auto">
  <name>Task 2: Implement memory browser, inject, and wipe commands + wire all new commands</name>
  <files>
    crates/boternity-api/src/cli/memory.rs
    crates/boternity-api/src/cli/mod.rs
    crates/boternity-api/src/main.rs
  </files>
  <action>
**memory.rs:**

**list_memories(state, bot_slug, json):**
Per locked decision: "bnity memories <bot> lists all extracted memories with full provenance: content, source session title, date extracted, and the message that triggered it"
- Resolve bot by slug
- Fetch memories from memory_repo.get_memories(bot_id, None)
- For provenance: fetch the session title for each unique session_id (batch fetch sessions first)
- If --json: output JSON array with all fields
- Else: styled table with columns: Fact (truncated 60 chars), Category, Importance (stars), Session, Date
  - Importance: render as stars (e.g., "****" for 4)
  - Category: colored (preference=blue, fact=green, decision=yellow, correction=red, context=dim)
  - Session: show session title (truncated) or "Manual" for is_manual entries

**remember(state, bot_slug, fact):**
Per locked decision: "bnity remember <bot> 'fact' -- explicit knowledge injection supported"
- Resolve bot by slug
- Create MemoryEntry: id = UUIDv7, bot_id, session_id = Uuid::nil() (no session), fact from argument, category = Fact, importance = 3 (medium), is_manual = true, created_at = now
- Save via memory_repo.save_memory()
- Print confirmation: "Remembered: {fact}"

**forget(state, bot_slug):**
Per locked decision: "bnity forget <bot> wipes all memories with confirmation -- clean slate"
- Resolve bot by slug
- Count existing memories first
- Prompt confirmation: "This will delete {N} memories for {bot_name}. Are you sure?"
- Call memory_repo.delete_all_memories(bot_id)
- Print: "Deleted {N} memories for {bot_name}"

**delete_memory(state, memory_id):**
Per locked decision: "user can delete individual entries"
- Fetch memory to verify it exists
- Delete via memory_repo.delete_memory(id)
- Print confirmation

**Wire all new commands into main.rs:**
Add to the Commands enum:
```rust
/// List past chat sessions for a bot
Sessions { slug: String },

/// Export a chat session
Export {
    #[command(subcommand)]
    resource: ExportResource,
},

/// Inject a memory into a bot
Remember { slug: String, fact: String },

/// Wipe all memories for a bot
Forget { slug: String },

/// List memories for a bot
Memories { slug: String },
```

Add ExportResource enum:
```rust
enum ExportResource {
    Session { id: String },
}
```

Also extend the existing DeleteResource enum to include Session:
```rust
DeleteResource::Session { id: String, #[arg(short, long)] force: bool }
```

Add match arms in main.rs for all new commands, dispatching to the appropriate cli module functions.

**Update cli/mod.rs:** Add `pub mod session; pub mod memory;`

Pass `cli.json` flag to all commands for consistent JSON output support.
  </action>
  <verify>
Run `cargo check -p boternity-api` -- all new commands compile. Run `cargo run -p boternity-api -- --help` and verify the new commands appear: sessions, memories, remember, forget, export.
  </verify>
  <done>Full session and memory management CLI: session browser with provenance, Markdown/JSON export, session delete, memory browser, manual injection, and memory wipe. All commands follow Phase 1 CLI patterns.</done>
</task>

</tasks>

<verification>
1. `cargo check -p boternity-api` passes
2. `bnity sessions <bot>` lists sessions in styled table
3. `bnity export session <id>` outputs Markdown by default, JSON with --json
4. `bnity delete session <id>` prompts for confirmation
5. `bnity memories <bot>` lists memories with provenance
6. `bnity remember <bot> 'fact'` saves a manual memory
7. `bnity forget <bot>` wipes all memories with confirmation
8. All commands support --json flag
9. Output styling matches Phase 1 CLI conventions
</verification>

<success_criteria>
- Session browser shows date, duration, title, message count
- Export produces clean Markdown with full conversation
- Memory browser shows fact, category, importance, provenance
- Manual memory injection works via CLI
- Memory wipe requires confirmation
- All commands handle bot-not-found gracefully
- Consistent styling with Phase 1 CLI
</success_criteria>

<output>
After completion, create `.planning/phases/02-single-agent-chat-llm/02-08-SUMMARY.md`
</output>
