---
phase: 03-multi-provider-memory
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - Cargo.toml
  - crates/boternity-infra/Cargo.toml
  - crates/boternity-infra/src/vector/mod.rs
  - crates/boternity-infra/src/vector/lance.rs
  - crates/boternity-infra/src/vector/embedder.rs
  - crates/boternity-infra/src/vector/schema.rs
  - crates/boternity-infra/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "LanceDB connection opens successfully at ~/.boternity/vector_store"
    - "FastEmbedEmbedder generates 384-dimensional embeddings using BGESmallENV15"
    - "Embedding is performed via tokio::task::spawn_blocking (not on async runtime)"
    - "Arrow schema definitions match LanceDB's transitive arrow version"
  artifacts:
    - path: "crates/boternity-infra/src/vector/lance.rs"
      provides: "LanceVectorStore with connection management and table operations"
      contains: "LanceVectorStore"
    - path: "crates/boternity-infra/src/vector/embedder.rs"
      provides: "FastEmbedEmbedder implementing Embedder trait"
      contains: "FastEmbedEmbedder"
    - path: "crates/boternity-infra/src/vector/schema.rs"
      provides: "Arrow schemas for bot memory, shared memory, and file chunks"
      contains: "bot_memory_schema"
  key_links:
    - from: "crates/boternity-infra/src/vector/embedder.rs"
      to: "crates/boternity-core/src/memory/embedder.rs"
      via: "implements Embedder trait"
      pattern: "impl Embedder for FastEmbedEmbedder"
    - from: "crates/boternity-infra/src/vector/lance.rs"
      to: "crates/boternity-infra/src/vector/schema.rs"
      via: "uses Arrow schemas for table creation"
      pattern: "bot_memory_schema"
---

<objective>
Set up LanceDB vector database and fastembed local embedding infrastructure.

Purpose: Establish the vector store and embedding foundation that all memory features depend on (INFR-02, MEMO-02). LanceDB stores embeddings; fastembed generates them locally without API keys.
Output: LanceVectorStore wrapper, FastEmbedEmbedder, and Arrow schema definitions for all Phase 3 vector tables.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-provider-memory/03-RESEARCH.md
@.planning/phases/03-multi-provider-memory/03-CONTEXT.md
@.planning/phases/03-multi-provider-memory/03-01-SUMMARY.md
@crates/boternity-core/src/memory/embedder.rs
@Cargo.toml
@crates/boternity-infra/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add vector dependencies and create schema definitions</name>
  <files>
    Cargo.toml
    crates/boternity-infra/Cargo.toml
    crates/boternity-infra/src/vector/schema.rs
    crates/boternity-infra/src/vector/mod.rs
    crates/boternity-infra/src/lib.rs
  </files>
  <action>
Add to workspace `Cargo.toml` `[workspace.dependencies]`:
```toml
lancedb = "0.26"
fastembed = "5"
text-splitter = { version = "0.29", features = ["markdown"] }
```
Do NOT add arrow-schema/arrow-array directly. After adding lancedb, run `cargo tree -p lancedb -d 1 2>/dev/null | grep arrow` to find the exact arrow version lancedb uses. Then add:
```toml
arrow-schema = "{discovered_version}"
arrow-array = "{discovered_version}"
```
Per RESEARCH.md Pitfall 10: Arrow version MUST match lancedb's transitive dep. Expected: 57.x for lancedb 0.26.2.

Add to `crates/boternity-infra/Cargo.toml`:
```toml
lancedb = { workspace = true }
fastembed = { workspace = true }
text-splitter = { workspace = true }
arrow-schema = { workspace = true }
arrow-array = { workspace = true }
```

Create `crates/boternity-infra/src/vector/schema.rs`:

1. `pub fn bot_memory_schema() -> Schema` -- per RESEARCH.md Pattern 5:
   - Fields: id (Utf8), bot_id (Utf8), fact (Utf8), category (Utf8), importance (Int32), session_id (Utf8 nullable), created_at (Utf8), last_accessed_at (Utf8 nullable), access_count (Int32), embedding_model (Utf8), vector (FixedSizeList of Float32, size 384)

2. `pub fn shared_memory_schema() -> Schema` -- per RESEARCH.md Pattern 8:
   - Fields: id (Utf8), fact (Utf8), category (Utf8), importance (Int32), author_bot_id (Utf8), author_bot_name (Utf8), trust_level (Utf8), created_at (Utf8), write_hash (Utf8), embedding_model (Utf8), vector (FixedSizeList of Float32, size 384)

3. `pub fn file_chunks_schema() -> Schema` -- per RESEARCH.md Pattern 9:
   - Fields: chunk_id (Utf8), file_id (Utf8), bot_id (Utf8), filename (Utf8), chunk_index (Int32), chunk_text (Utf8), embedding_model (Utf8), vector (FixedSizeList of Float32, size 384)

4. `pub const EMBEDDING_DIMENSION: i32 = 384;` -- BGESmallENV15 dimension

Create `crates/boternity-infra/src/vector/mod.rs`: `pub mod lance; pub mod embedder; pub mod schema;`
Update `crates/boternity-infra/src/lib.rs`: add `pub mod vector;`
  </action>
  <verify>`cargo check -p boternity-infra` compiles. Arrow versions match lancedb transitive dep (check with `cargo tree -p lancedb | grep arrow-schema`).</verify>
  <done>Vector dependencies added. Arrow schemas defined for bot memory, shared memory, and file chunks.</done>
</task>

<task type="auto">
  <name>Task 2: Implement LanceVectorStore and FastEmbedEmbedder</name>
  <files>
    crates/boternity-infra/src/vector/lance.rs
    crates/boternity-infra/src/vector/embedder.rs
  </files>
  <action>
Create `crates/boternity-infra/src/vector/embedder.rs`:

1. `FastEmbedEmbedder` struct:
   - `model: Arc<TextEmbedding>` (shared across calls via Arc)
   - `model_name: String` (e.g., "bge-small-en-v1.5")
   - `dimension: usize` (384)

2. `FastEmbedEmbedder::new() -> Result<Self, ...>`:
   - Set cache directory: `dirs::data_dir().join("boternity").join("models")`
   - Create `TextEmbedding::try_new(InitOptions { model_name: EmbeddingModel::BGESmallENV15, show_download_progress: true, cache_dir, ..Default::default() })`
   - Wrap in Arc, set model_name and dimension

3. Implement `Embedder` for `FastEmbedEmbedder`:
   - `embed(&self, texts: &[String])`:
     - CRITICAL per RESEARCH.md Pitfall 1: Use `tokio::task::spawn_blocking`
     - Clone Arc<TextEmbedding> into the blocking task
     - Convert texts to Vec<&str> for fastembed API
     - Call `model.embed(texts_ref, None)?`
     - Return Vec<Vec<f32>>
   - `model_name()` -> &self.model_name
   - `dimension()` -> self.dimension

Create `crates/boternity-infra/src/vector/lance.rs`:

1. `LanceVectorStore` struct:
   - `db: lancedb::Connection`
   - `base_path: PathBuf`

2. `LanceVectorStore::new(base_path: PathBuf) -> Result<Self, ...>`:
   - Create directory if not exists
   - `lancedb::connect(base_path.to_str()?).execute().await?`

3. Helper methods (not trait methods -- general LanceDB utilities):
   - `pub async fn ensure_table(&self, table_name: &str, schema: Arc<Schema>) -> Result<lancedb::Table, ...>`:
     - Try `self.db.open_table(table_name).execute().await`
     - If table doesn't exist (NotFound error): create with `RecordBatch::new_empty(schema)` or a dummy initial record that gets deleted
     - Per RESEARCH.md Open Question 2: try empty batch first, fallback to single-row-then-delete
   - `pub async fn table_exists(&self, table_name: &str) -> bool`
   - `pub async fn drop_table(&self, table_name: &str) -> Result<(), ...>`

4. `pub fn bot_table_name(bot_id: &Uuid) -> String` -> format!("bot_memory_{}", bot_id.simple())
5. `pub fn shared_table_name() -> &'static str` -> "shared_memory"
6. `pub fn file_chunks_table_name(bot_id: &Uuid) -> String` -> format!("file_chunks_{}", bot_id.simple())

Note: The actual VectorMemoryStore and SharedMemoryStore trait implementations go in Plan 03-07 and 03-09. This plan sets up the infrastructure layer only.

Add a basic integration test:
- Create a temporary LanceVectorStore
- Verify table creation works
- Verify connection opens without error
  </action>
  <verify>`cargo check -p boternity-infra` compiles. `cargo test -p boternity-infra -- vector` passes.</verify>
  <done>LanceVectorStore manages LanceDB connection and table lifecycle. FastEmbedEmbedder generates embeddings via spawn_blocking. Arrow schemas defined for all vector tables.</done>
</task>

</tasks>

<verification>
- `cargo check --workspace` compiles
- `cargo test -p boternity-infra -- vector` passes
- Arrow version matches lancedb transitive dep
- fastembed model downloads and generates 384-dim vectors
- LanceDB creates tables from Arrow schemas
</verification>

<success_criteria>
LanceDB and fastembed infrastructure is operational. Table creation works. Embedding generates 384-dimensional vectors via spawn_blocking. Arrow versions are compatible.
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-provider-memory/03-04-SUMMARY.md`
</output>
