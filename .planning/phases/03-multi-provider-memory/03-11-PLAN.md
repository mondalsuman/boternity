---
phase: 03-multi-provider-memory
plan: 11
type: execute
wave: 5
depends_on: ["03-06"]
files_modified:
  - crates/boternity-api/src/cli/mod.rs
  - crates/boternity-api/src/cli/provider.rs
  - crates/boternity-api/src/cli/chat/loop_runner.rs
  - crates/boternity-api/src/cli/chat/commands.rs
autonomous: true

must_haves:
  truths:
    - "bnity provider status shows all providers with circuit state, last error, uptime"
    - "bnity provider add configures a new provider and tests the connection"
    - "bnity provider remove removes a provider from the chain"
    - "bnity provider list shows the current fallback chain order"
    - "Failover events appear on stderr during chat"
    - "Cost warning shown when fallback costs >3x primary"
    - "Capability warning shown when fallback model is weaker"
  artifacts:
    - path: "crates/boternity-api/src/cli/provider.rs"
      provides: "Provider CLI subcommands (status, add, remove, list)"
      contains: "ProviderCommand"
  key_links:
    - from: "crates/boternity-api/src/cli/provider.rs"
      to: "crates/boternity-core/src/llm/fallback.rs"
      via: "reads health_status() for display"
      pattern: "health_status"
    - from: "crates/boternity-api/src/cli/provider.rs"
      to: "crates/boternity-infra/src/llm/mod.rs"
      via: "uses create_provider() and test_provider_connection()"
      pattern: "test_provider_connection"
---

<objective>
Build the provider management CLI and finalize failover chat integration.

Purpose: Users can configure, monitor, and manage LLM providers via CLI (LLMP-09, LLMP-10). The `bnity provider status` command shows circuit breaker state. Failover is visible in chat via stderr notices.
Output: Provider CLI subcommands (status/add/remove/list), stderr failover notices in chat, cost and capability warnings.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-provider-memory/03-RESEARCH.md
@.planning/phases/03-multi-provider-memory/03-CONTEXT.md
@.planning/phases/03-multi-provider-memory/03-06-SUMMARY.md
@crates/boternity-api/src/cli/mod.rs
@crates/boternity-api/src/cli/chat/loop_runner.rs
@crates/boternity-api/src/cli/chat/commands.rs
@crates/boternity-api/src/state.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement provider CLI subcommands</name>
  <files>
    crates/boternity-api/src/cli/provider.rs
    crates/boternity-api/src/cli/mod.rs
  </files>
  <action>
Create `crates/boternity-api/src/cli/provider.rs`:

1. `ProviderCommand` enum (clap derive):
   ```
   #[derive(Subcommand)]
   enum ProviderCommand {
       /// Show health status of all configured providers
       Status,
       /// Add a new LLM provider to the fallback chain
       Add {
           /// Provider type: openai, gemini, mistral, glm, bedrock, claude_subscription
           #[arg(long)]
           provider_type: String,
           /// Model name (e.g., gpt-4o, gemini-2.5-pro)
           #[arg(long)]
           model: String,
           /// Priority in fallback chain (lower = higher priority)
           #[arg(long, default_value = "10")]
           priority: u32,
           /// API key secret name in vault (e.g., "openai-api-key")
           #[arg(long)]
           secret: Option<String>,
           /// Custom base URL override
           #[arg(long)]
           base_url: Option<String>,
           /// Mark as experimental (required for claude_subscription)
           #[arg(long)]
           experimental: bool,
       },
       /// Remove a provider from the fallback chain
       Remove {
           /// Provider name to remove
           name: String,
       },
       /// List all providers in the fallback chain with priority order
       List,
   }
   ```

2. `pub async fn handle_provider_command(cmd: ProviderCommand, state: &AppState) -> anyhow::Result<()>`:

   - **Status**: per user decision "dedicated CLI command `bnity provider status` showing circuit breaker state, last error, uptime"
     - Read fallback_chain.health_status()
     - Display using comfy-table:
       | Provider | Model | State | Last Error | Uptime | Calls | Failures |
       - State colored: green for "closed", red for "open", yellow for "half_open"
       - Show priority number
       - Show cost per 1M tokens if available

   - **Add**:
     - Parse provider_type to ProviderType enum
     - If claude_subscription and !experimental: error "Claude subscription requires --experimental flag. This provider violates Anthropic's ToS and may stop working."
     - Resolve API key from vault using secret name
     - Create ProviderConfig
     - Create provider via create_provider()
     - Test connection per user decision: "Always test connection when a new provider is configured"
     - If test succeeds: print green "Provider connected successfully"
     - If test fails: print error, ask if user wants to add anyway
     - Save provider config to persistent storage (write to a providers.json in data_dir, or add to bot config)
     - Rebuild fallback chain

   - **Remove**:
     - Remove provider from config
     - Rebuild fallback chain
     - Print confirmation

   - **List**:
     - Show providers in priority order
     - Use comfy-table: | Priority | Name | Type | Model | Status |

Update `cli/mod.rs`:
- Add `Provider(ProviderCommand)` variant to main CLI enum
- Route to `handle_provider_command()`

Provider configuration persistence:
- Store in `~/.boternity/providers.json` as a JSON array of ProviderConfig
- Load on startup in AppState::init()
- Write after add/remove operations
  </action>
  <verify>`cargo check --workspace` compiles. `bnity provider status` runs without error. `bnity provider list` shows configured providers.</verify>
  <done>Provider CLI subcommands operational: status shows circuit breaker health, add configures and tests new providers, remove drops providers, list shows fallback chain order.</done>
</task>

<task type="auto">
  <name>Task 2: Finalize failover visibility in chat</name>
  <files>
    crates/boternity-api/src/cli/chat/loop_runner.rs
    crates/boternity-api/src/cli/chat/commands.rs
  </files>
  <action>
Update chat loop runner to properly surface failover information:

1. After each message exchange that uses FallbackChain:
   - If failover_warning is Some: print to stderr using console crate's yellow styling
   - Format: `eprintln!("{}", style("[failover]").yellow().bold()); eprintln!("  {}", warning);`
   - Per user decision: "Failover events visible in CLI output (print to stderr during chat)"

2. When all providers are down:
   - Display error clearly: "All providers in the fallback chain are currently unavailable."
   - Suggest: "Run `bnity provider status` to check provider health."
   - Per user decision: "Clear error message when ALL providers in chain are down"

3. Add `--verbose` flag support to `bnity chat` command:
   - Per user decision: "Verbose mode (`bnity chat --verbose`) shows which memories were injected into system prompt"
   - When verbose: after memory retrieval (Plan 03-08), print to stderr:
     - "[memory] {N} memories recalled:"
     - For each: "  - {category}: {fact} (score: {relevance_score:.2})"
   - This integrates with the verbose flag added to AgentContext in Plan 03-08

4. Provider name in stats footer:
   - Per discretion decision: include provider name in the stats footer that shows after each message
   - Existing stats show token count. Add: "via {provider_name}"
   - If fallback happened: show "via {provider_name} (fallback from {primary_name})"
  </action>
  <verify>`cargo check --workspace` compiles. Chat loop properly displays failover warnings on stderr.</verify>
  <done>Failover events visible in CLI chat via stderr. Verbose mode shows recalled memories. Provider name in stats footer. All-providers-down error suggests `bnity provider status`.</done>
</task>

</tasks>

<verification>
- `cargo check --workspace` compiles
- `cargo test --workspace` passes
- `bnity provider status` displays provider health table
- `bnity provider add --provider-type openai --model gpt-4o --secret openai-key` configures and tests
- Failover warnings appear on stderr in yellow during chat
- `bnity chat --verbose` shows memory injection details
</verification>

<success_criteria>
Full provider CLI with status/add/remove/list. Failover visible in chat stderr. Verbose mode shows memory recall. Clear error when all providers down. Provider name in stats footer.
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-provider-memory/03-11-SUMMARY.md`
</output>
