---
phase: 03-multi-provider-memory
plan: 12
type: execute
wave: 5
depends_on: ["03-08", "03-09"]
files_modified:
  - crates/boternity-api/src/cli/memory.rs
  - crates/boternity-api/src/cli/shared_memory.rs
  - crates/boternity-api/src/cli/mod.rs
autonomous: true

must_haves:
  truths:
    - "bnity memory search shows similarity scores alongside results"
    - "bnity memory export outputs JSON to stdout"
    - "bnity memory add stores in both SQLite and LanceDB"
    - "bnity memory delete removes from both SQLite and LanceDB, logs to audit"
    - "bnity shared-memory is a separate subcommand (not mixed into bnity memory)"
    - "bnity shared-memory search filters by trust level"
    - "bnity shared-memory list shows provenance (author bot name)"
  artifacts:
    - path: "crates/boternity-api/src/cli/memory.rs"
      provides: "Enhanced memory CLI with similarity scores, export, audit"
      contains: "similarity"
    - path: "crates/boternity-api/src/cli/shared_memory.rs"
      provides: "Dedicated shared memory CLI subcommand"
      contains: "SharedMemoryCommand"
  key_links:
    - from: "crates/boternity-api/src/cli/memory.rs"
      to: "crates/boternity-infra/src/vector/memory.rs"
      via: "uses LanceVectorMemoryStore for search"
      pattern: "vector_memory.*search"
    - from: "crates/boternity-api/src/cli/shared_memory.rs"
      to: "crates/boternity-infra/src/vector/shared.rs"
      via: "uses LanceSharedMemoryStore for shared memory operations"
      pattern: "shared_memory.*search"
---

<objective>
Enhance the memory CLI with vector search features and create the shared memory CLI.

Purpose: Users can manage memories with semantic search, export, and similarity scores (MEMO-02). Shared memory has its own dedicated CLI subcommand (MEMO-03). This completes the memory management user interface.
Output: Enhanced `bnity memory` with search scores and export, new `bnity shared-memory` subcommand.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-provider-memory/03-RESEARCH.md
@.planning/phases/03-multi-provider-memory/03-CONTEXT.md
@.planning/phases/03-multi-provider-memory/03-08-SUMMARY.md
@.planning/phases/03-multi-provider-memory/03-09-SUMMARY.md
@crates/boternity-api/src/cli/memory.rs
@crates/boternity-api/src/cli/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance memory CLI with vector search and export</name>
  <files>crates/boternity-api/src/cli/memory.rs</files>
  <action>
Update existing `memory.rs` to integrate vector memory features:

1. **Update `search` subcommand** (or add if not existing):
   ```
   Search {
       /// Bot to search memories for
       #[arg(long)]
       bot: String,
       /// Search query (semantic search)
       query: String,
       /// Maximum results
       #[arg(long, default_value = "10")]
       limit: usize,
       /// Filter by category
       #[arg(long)]
       category: Option<String>,
       /// Minimum similarity threshold (0.0-1.0)
       #[arg(long, default_value = "0.3")]
       min_similarity: f32,
   }
   ```
   - Embed query text via embedder
   - Search vector memory store
   - Display results in table format with columns: | Score | Category | Fact | Created |
   - Per user decision: "Memory search CLI shows similarity scores alongside results"
   - Score displayed as percentage: "87%" for 0.87 similarity
   - Color code scores: green >= 0.7, yellow >= 0.4, red < 0.4

2. **Update `add` subcommand**:
   - After saving to SQLite (existing behavior), also:
     - Embed the fact text
     - Check for semantic duplicates
     - Store in LanceDB vector store
     - Log to audit trail (AuditAction::Add, actor: "user")
   - Per user decision: "Full CRUD CLI: `bnity memory list/search/delete/add`"

3. **Update `delete` subcommand**:
   - After deleting from SQLite (existing behavior), also:
     - Delete from LanceDB vector store
     - Log to audit trail (AuditAction::Delete, actor: "user")

4. **Add `export` subcommand**:
   ```
   Export {
       /// Bot to export memories for
       #[arg(long)]
       bot: String,
       /// Output format
       #[arg(long, default_value = "json")]
       format: String,
   }
   ```
   - Per user decision: "JSON export via `bnity memory export`"
   - Load all memories from SQLite (the authoritative store)
   - Serialize to JSON array
   - Print to stdout (pipeable)

5. **Update `list` subcommand**:
   - Add category column to output table
   - Show importance as stars: "***" for 3/5
   - Show whether memory has vector embedding (checkmark if in LanceDB)

6. **Add `audit` subcommand** (bonus -- per user decision: "Audit log for memory additions and deletions"):
   ```
   Audit {
       /// Bot to show audit log for
       #[arg(long)]
       bot: String,
       /// Maximum entries
       #[arg(long, default_value = "20")]
       limit: usize,
   }
   ```
   - Read from SqliteAuditLog
   - Display: | Time | Action | Actor | Memory (truncated) | Details |
  </action>
  <verify>`cargo check --workspace` compiles. `bnity memory search --bot mybot "query"` returns results with scores.</verify>
  <done>Memory CLI enhanced with semantic search (similarity scores), export (JSON to stdout), audit log viewing, and dual-store operations (SQLite + LanceDB).</done>
</task>

<task type="auto">
  <name>Task 2: Create shared memory CLI subcommand</name>
  <files>
    crates/boternity-api/src/cli/shared_memory.rs
    crates/boternity-api/src/cli/mod.rs
  </files>
  <action>
Create `crates/boternity-api/src/cli/shared_memory.rs`:

Per user decision: "Dedicated `bnity shared-memory` CLI subcommand"

1. `SharedMemoryCommand` enum:
   ```
   #[derive(Subcommand)]
   enum SharedMemoryCommand {
       /// Search shared memories accessible to a bot
       Search {
           /// Bot performing the search (determines trust access)
           #[arg(long)]
           bot: String,
           /// Search query
           query: String,
           #[arg(long, default_value = "10")]
           limit: usize,
       },
       /// List all shared memories (optionally filtered by author)
       List {
           /// Filter by author bot
           #[arg(long)]
           author: Option<String>,
           /// Filter by trust level
           #[arg(long)]
           trust_level: Option<String>,
       },
       /// Share a memory from a bot's private memories
       Share {
           /// Memory ID to share
           memory_id: String,
           /// Trust level: public or trusted
           #[arg(long)]
           level: String,
       },
       /// Revoke a previously shared memory (set back to private)
       Revoke {
           /// Memory ID to revoke
           memory_id: String,
       },
       /// Show details of a specific shared memory
       Details {
           /// Memory ID
           memory_id: String,
       },
   }
   ```

2. `pub async fn handle_shared_memory_command(cmd: SharedMemoryCommand, state: &AppState) -> anyhow::Result<()>`:

   - **Search**:
     - Resolve bot -> bot_id
     - Load bot's trusted_bots list from config
     - Embed query
     - Call shared_memory_store.search(bot_id, trusted_bot_ids, embedding, limit, min_similarity)
     - Display with provenance: | Score | Author | Trust | Category | Fact |
     - Per user decision: "Provenance always shown -- memory includes 'Written by BotX'"

   - **List**:
     - Query shared memories with optional filters
     - Display: | ID (short) | Author | Trust Level | Category | Fact (truncated) | Created |

   - **Share**:
     - Parse memory_id UUID
     - Parse trust level (public/trusted)
     - Call shared_memory_store.share(memory_id, trust_level)
     - Log to audit (AuditAction::Share)
     - Per user decision: "Sharing via CLI (`bnity memory share <id> --level public/trusted`)"

   - **Revoke**:
     - Per user decision: "Author can revoke previously shared memories"
     - Call shared_memory_store.revoke(memory_id, author_bot_id)
     - Log to audit (AuditAction::Revoke)
     - Print confirmation

   - **Details**:
     - Load specific shared memory entry
     - Show all fields: author, trust level, category, importance, fact (full text), created_at, write_hash

Update `cli/mod.rs`:
- Add `SharedMemory(SharedMemoryCommand)` variant to main CLI enum
- Register as `#[command(name = "shared-memory")]` for hyphenated CLI name
- Route to `handle_shared_memory_command()`
  </action>
  <verify>`cargo check --workspace` compiles. `bnity shared-memory search --bot mybot "query"` runs without error.</verify>
  <done>Dedicated `bnity shared-memory` CLI with search (trust-filtered), list, share, revoke, and details subcommands. Provenance shown in all outputs.</done>
</task>

</tasks>

<verification>
- `cargo check --workspace` compiles
- `cargo test --workspace` passes
- `bnity memory search --bot test "query"` shows results with similarity scores
- `bnity memory export --bot test` outputs JSON to stdout
- `bnity shared-memory search --bot test "query"` shows trust-filtered results with provenance
- `bnity shared-memory share MEMORY_ID --level public` changes trust level
</verification>

<success_criteria>
Memory CLI shows similarity scores, supports JSON export, and operates on both SQLite and LanceDB. Shared memory has dedicated CLI with trust-filtered search, sharing, revoking, and provenance display.
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-provider-memory/03-12-SUMMARY.md`
</output>
