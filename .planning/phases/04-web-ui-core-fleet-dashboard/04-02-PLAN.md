---
phase: 04-web-ui-core-fleet-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/web/package.json
  - apps/web/tsconfig.json
  - apps/web/tsconfig.app.json
  - apps/web/vite.config.ts
  - apps/web/index.html
  - apps/web/components.json
  - apps/web/src/main.tsx
  - apps/web/src/index.css
  - apps/web/src/routes/__root.tsx
  - apps/web/src/routes/index.tsx
  - apps/web/src/routes/settings.tsx
  - apps/web/src/lib/api-client.ts
  - apps/web/src/lib/query-client.ts
  - apps/web/src/lib/utils.ts
  - apps/web/src/stores/theme-store.ts
  - apps/web/src/stores/sidebar-store.ts
  - apps/web/src/types/api.ts
  - apps/web/src/types/bot.ts
  - apps/web/src/types/chat.ts
  - apps/web/src/types/soul.ts
  - apps/web/src/components/layout/app-sidebar.tsx
  - apps/web/src/components/layout/command-palette.tsx
  - apps/web/src/components/layout/breadcrumbs.tsx
  - apps/web/src/components/ui/
autonomous: true

must_haves:
  truths:
    - "Running pnpm dev in apps/web starts a Vite dev server that proxies /api to the Rust backend"
    - "App renders with a dark-themed sidebar containing Dashboard, Bots, Chat, Settings navigation"
    - "Sidebar collapses to icon-only rail and on mobile becomes a hamburger-triggered drawer"
    - "Cmd+K opens a command palette that can search bots and navigate pages"
    - "Toast notifications appear at bottom-right via Sonner"
    - "Dark theme is active by default with a working light mode toggle in Settings"
    - "File-based routing works — navigating to / shows dashboard, /settings shows settings page"
    - "API client correctly unwraps ApiResponse envelopes from the Rust backend"
  artifacts:
    - path: "apps/web/package.json"
      provides: "Web app dependencies and scripts"
      contains: "react"
    - path: "apps/web/vite.config.ts"
      provides: "Vite configuration with proxy, TanStack Router, Tailwind v4, PWA"
      contains: "TanStackRouterVite"
    - path: "apps/web/src/routes/__root.tsx"
      provides: "Root layout with sidebar, toaster, command palette, theme"
      contains: "SidebarProvider"
    - path: "apps/web/src/lib/api-client.ts"
      provides: "Typed fetch wrapper with envelope unwrapping"
      exports: ["apiFetch", "ApiError"]
    - path: "apps/web/src/stores/theme-store.ts"
      provides: "Dark/light theme state with persistence"
      exports: ["useThemeStore"]
  key_links:
    - from: "apps/web/vite.config.ts"
      to: "http://localhost:3000"
      via: "Vite proxy /api"
      pattern: "proxy.*api.*3000"
    - from: "apps/web/src/lib/api-client.ts"
      to: "/api/v1"
      via: "fetch base URL"
      pattern: "/api/v1"
    - from: "apps/web/src/routes/__root.tsx"
      to: "apps/web/src/components/layout/app-sidebar.tsx"
      via: "import"
      pattern: "import.*AppSidebar"
---

<objective>
Scaffold the React web application with Vite, TanStack Router, TanStack Query, shadcn/ui, and the full app shell (sidebar, command palette, toaster, theme system, breadcrumbs).

Purpose: This is the foundation all other frontend plans build on. Every UI feature needs the app shell, routing, state management, API client, and component library.
Output: A running React app at localhost:5173 with the complete navigation shell, dark theme, and API connectivity.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-RESEARCH.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-CONTEXT.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold React app with Vite, install all dependencies, configure build tooling</name>
  <files>
    apps/web/package.json
    apps/web/tsconfig.json
    apps/web/tsconfig.app.json
    apps/web/vite.config.ts
    apps/web/index.html
    apps/web/components.json
    apps/web/src/main.tsx
    apps/web/src/index.css
    apps/web/src/lib/utils.ts
    apps/web/src/lib/api-client.ts
    apps/web/src/lib/query-client.ts
    apps/web/src/types/api.ts
    apps/web/src/types/bot.ts
    apps/web/src/types/chat.ts
    apps/web/src/types/soul.ts
    apps/web/src/stores/theme-store.ts
    apps/web/src/stores/sidebar-store.ts
  </files>
  <action>
**Step 1: Create the app directory and initialize:**
```bash
mkdir -p apps/web
cd apps/web
pnpm init
```

**Step 2: Install all dependencies:**
```bash
# Core framework
pnpm add react react-dom @tanstack/react-router @tanstack/react-query zustand

# Build tooling (dev)
pnpm add -D vite @vitejs/plugin-react typescript @types/react @types/react-dom @types/node
pnpm add -D @tanstack/router-plugin tailwindcss @tailwindcss/vite
pnpm add -D vite-plugin-pwa
pnpm add -D @tanstack/react-query-devtools @tanstack/router-devtools

# Chat & streaming (installed now, used by later plans)
pnpm add react-markdown remark-gfm rehype-highlight date-fns

# Soul editor (installed now, used by later plans)
pnpm add @monaco-editor/react

# Icons + app shell
pnpm add lucide-react

# Initialize shadcn/ui (creates components.json, utils.ts, index.css with theme vars)
pnpm dlx shadcn@latest init --defaults
```

If `shadcn init` is interactive, use these options: Style = "New York", Base color = "Neutral", CSS variables = yes. Alternatively, create `components.json` manually with the correct config for Tailwind v4.

**Step 3: Add shadcn components needed for the app shell:**
```bash
pnpm dlx shadcn@latest add sidebar command button input badge avatar dropdown-menu separator scroll-area tooltip skeleton breadcrumb tabs dialog sheet card
```
Also add Sonner: `pnpm dlx shadcn@latest add sonner`

**Step 4: Configure vite.config.ts:**
- Plugin order: `[TanStackRouterVite({ target: 'react', autoCodeSplitting: true }), tailwindcss(), react(), VitePWA({ registerType: 'autoUpdate' })]` — CRITICAL: TanStack Router MUST come first
- Path alias: `@` -> `./src`
- Dev server proxy: `/api` -> `http://localhost:3000` (Rust backend)
- Port: 5173

**Step 5: Configure TypeScript:**
- tsconfig.json: paths alias `@/*` -> `./src/*`
- tsconfig.app.json: strict mode, React JSX, ES2022 target

**Step 6: Create index.html:**
- Title: "Boternity"
- `<div id="root"></div>`
- Script src: `/src/main.tsx`

**Step 7: Create src/main.tsx:**
- Create QueryClient with default staleTime 10_000 (10s)
- Create Router from generated routeTree
- Render `<QueryClientProvider>` + `<RouterProvider>`
- Import `./index.css`

**Step 8: Create src/index.css:**
- `@import 'tailwindcss';` (Tailwind v4 — NO @tailwind directives, NO tailwind.config.js)
- ShadCN CSS variables for dark and light themes
- Dark theme as default via `:root` having dark variables

**Step 9: Create TypeScript types (src/types/):**

`api.ts` — API envelope types matching `crates/boternity-api/src/http/response.rs`:
```typescript
interface ApiEnvelope<T> {
  data?: T;
  meta: { request_id: string; timestamp: string; response_time_ms: number };
  errors?: Array<{ code: string; message: string; details?: unknown }>;
  _links?: Record<string, string>;
}
```

`bot.ts` — Bot types matching boternity-types:
```typescript
interface Bot {
  id: string;
  name: string;
  slug: string;
  description: string | null;
  status: 'active' | 'disabled' | 'archived';
  emoji: string | null;
  category: string | null;
  created_at: string;
  updated_at: string;
  version_count: number;
}
```

`chat.ts` — Session and message types:
```typescript
interface ChatSession { id: string; bot_id: string; title: string | null; started_at: string; ended_at: string | null; total_input_tokens: number; total_output_tokens: number; message_count: number; model: string; status: 'active' | 'completed'; }
interface ChatMessage { id: string; session_id: string; role: 'user' | 'assistant'; content: string; created_at: string; input_tokens: number | null; output_tokens: number | null; model: string | null; }
```

`soul.ts` — Soul and version types matching existing soul API.

**Step 10: Create src/lib/api-client.ts:**
- `apiFetch<T>(path, init?)` function that calls `fetch('/api/v1' + path, ...)` and unwraps the ApiEnvelope
- `ApiError` class extending Error with `code` property
- Throw ApiError if envelope has errors
- Return `envelope.data as T`

**Step 11: Create src/lib/query-client.ts:**
- Export a configured QueryClient with defaults: `staleTime: 10_000`, `retry: 2`, `refetchOnWindowFocus: true`

**Step 12: Create Zustand stores:**

`theme-store.ts`:
- State: `theme: 'dark' | 'light' | 'system'` (default: `'dark'` per user decision)
- `setTheme(theme)` action
- Persisted to localStorage via zustand/persist with key `boternity-theme`

`sidebar-store.ts`:
- State: `collapsed: boolean` (default: false)
- `toggle()`, `setCollapsed(value)` actions
- Not persisted (resets on page load)

**Step 13: Add package.json scripts:**
```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview",
    "lint": "tsc --noEmit"
  }
}
```
  </action>
  <verify>
Run `cd apps/web && pnpm dev` — Vite dev server starts on port 5173 without errors. Visit http://localhost:5173 — renders without crashes (may be blank page initially). Run `pnpm build` — builds successfully without TypeScript errors.
  </verify>
  <done>
React app scaffolded with all dependencies installed, Vite configured with TanStack Router plugin + Tailwind v4 + proxy, TypeScript types defined, API client created, Zustand stores created, shadcn/ui initialized with components.
  </done>
</task>

<task type="auto">
  <name>Task 2: App shell — sidebar, command palette, breadcrumbs, theme, routing</name>
  <files>
    apps/web/src/routes/__root.tsx
    apps/web/src/routes/index.tsx
    apps/web/src/routes/settings.tsx
    apps/web/src/routes/bots/$botId/index.tsx
    apps/web/src/routes/bots/$botId/chat.tsx
    apps/web/src/routes/bots/$botId/soul.tsx
    apps/web/src/routes/bots/$botId/settings.tsx
    apps/web/src/routes/chat/index.tsx
    apps/web/src/routes/chat/$sessionId.tsx
    apps/web/src/components/layout/app-sidebar.tsx
    apps/web/src/components/layout/command-palette.tsx
    apps/web/src/components/layout/breadcrumbs.tsx
  </files>
  <action>
Build the complete app shell with navigation, command palette, breadcrumbs, and all route skeletons.

**__root.tsx — Root layout:**
- Wrap everything in `<SidebarProvider>`
- Layout: `<div className="flex min-h-screen w-full">` containing `<AppSidebar />` and `<main className="flex-1 overflow-auto">` with `<Outlet />`
- Add `<Toaster position="bottom-right" />` from shadcn Sonner
- Add `<CommandPalette />` component
- Add `<ThemeEffect />` component that reads from useThemeStore and applies `dark`/`light` class to `document.documentElement`
- In development, add TanStack Router Devtools and Query Devtools (lazy loaded, only in dev)

**app-sidebar.tsx — Sidebar navigation per user decision:**
- Use shadcn `Sidebar` with `collapsible="icon"` for VS Code-style rail collapse
- Four sections: Dashboard, Bots, Chat, Settings (per user decision)
- Dashboard: icon LayoutDashboard, links to `/`
- Bots: icon Bot, links to `/bots` — show last 5 bots inline using `useBots()` query (per user decision: "Bots section shows last 5 bots inline in sidebar for quick access")
- Chat: icon MessageCircle, links to `/chat`
- Settings: icon Settings, links to `/settings`
- Each bot in the inline list links to `/bots/$botId` and shows emoji + name
- SidebarHeader: Boternity logo/text + SidebarTrigger for collapse
- Mobile: sidebar automatically becomes a sheet/drawer (shadcn Sidebar handles this with `collapsible="icon"` + built-in mobile behavior via Sheet)

**command-palette.tsx — Global Cmd+K per user decision:**
- Use shadcn `CommandDialog` wrapping `Command`
- Register `Cmd+K` / `Ctrl+K` keyboard shortcut via useEffect + keydown listener
- Groups: "Navigation" (Dashboard, Chat, Settings), "Bots" (dynamically loaded), "Actions" (New Bot, New Chat)
- Bots group: fetch bots on open, show emoji + name, navigate to bot detail on select
- Navigation items use `router.navigate()` from TanStack Router
- Close dialog on selection

**breadcrumbs.tsx — Navigation breadcrumbs per user decision:**
- Use shadcn `Breadcrumb` component
- Derive breadcrumbs from current route matches (TanStack Router's `useMatches()`)
- Format: "Dashboard > Bot Name > Soul" style
- Each segment is a link except the last (current page)
- Render at top of main content area (inside each route, or in __root.tsx above Outlet)

**Route files — create skeleton pages:**
- `routes/index.tsx` — Dashboard placeholder: `<h1>Fleet Dashboard</h1>` with breadcrumb
- `routes/settings.tsx` — Settings page with theme toggle (use useThemeStore, three buttons for dark/light/system) and backend API URL config input
- `routes/bots/$botId/index.tsx` — Bot detail overview tab placeholder
- `routes/bots/$botId/chat.tsx` — Bot-specific chat tab placeholder
- `routes/bots/$botId/soul.tsx` — Soul editor tab placeholder
- `routes/bots/$botId/settings.tsx` — Bot settings tab placeholder
- `routes/chat/index.tsx` — Chat hub placeholder
- `routes/chat/$sessionId.tsx` — Specific session placeholder

For bot detail routes, create a shared layout that renders the tab navigation (Overview | Chat | Soul | Settings) using shadcn Tabs component. The bot detail layout loads bot data via TanStack Query and passes it down.

All route files export a `Route` using `createFileRoute()` from TanStack Router. Each placeholder page shows a centered heading with skeleton content to indicate it's wired up.
  </action>
  <verify>
Run `cd apps/web && pnpm dev`. Visit http://localhost:5173:
1. Dark themed sidebar visible with Dashboard, Bots, Chat, Settings sections
2. Click sidebar items — routes change, content area updates
3. Collapse sidebar — becomes icon-only rail
4. Press Cmd+K — command palette opens
5. Navigate to /settings — theme toggle works (switches between dark/light)
6. Breadcrumbs show correct navigation path
7. No console errors
  </verify>
  <done>
Complete app shell with collapsible sidebar (4 sections + inline bot list), command palette (Cmd+K), breadcrumbs, Sonner toaster, dark theme by default with toggle, all route skeletons wired with TanStack Router. App loads and navigates correctly.
  </done>
</task>

</tasks>

<verification>
1. `pnpm dev` starts without errors in apps/web
2. `pnpm build` produces a dist/ directory with valid HTML/JS/CSS
3. Sidebar renders with all 4 sections and collapses to icon rail
4. Cmd+K opens command palette
5. Theme toggle switches between dark and light mode
6. API client correctly proxies to backend (test with a real bot list fetch)
7. All route paths resolve without 404
</verification>

<success_criteria>
- React app fully scaffolded with all dependencies
- File-based routing generates correct route tree
- App shell matches user decisions: 4-section sidebar, collapsible rail, hamburger on mobile, Cmd+K palette, bottom-right toasts, dark default theme, breadcrumbs
- API client unwraps ApiResponse envelopes
- TypeScript types mirror Rust domain types
- Vite proxies /api to Rust backend
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-ui-core-fleet-dashboard/04-02-SUMMARY.md`
</output>
