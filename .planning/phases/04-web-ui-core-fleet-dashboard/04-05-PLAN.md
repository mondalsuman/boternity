---
phase: 04-web-ui-core-fleet-dashboard
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - apps/web/src/components/chat/markdown-renderer.tsx
  - apps/web/src/components/chat/message-bubble.tsx
  - apps/web/src/components/chat/message-list.tsx
autonomous: true

must_haves:
  truths:
    - "Assistant messages render full markdown: headers, bold, italic, lists, tables"
    - "Code blocks have syntax highlighting and a copy-to-clipboard button"
    - "Messages have relative timestamps that update"
    - "Streaming content renders markdown progressively as tokens arrive"
  artifacts:
    - path: "apps/web/src/components/chat/markdown-renderer.tsx"
      provides: "Markdown rendering with GFM, syntax highlighting, and code copy"
      contains: "ReactMarkdown"
    - path: "apps/web/src/components/chat/message-bubble.tsx"
      provides: "Message bubble using markdown renderer for assistant messages"
      contains: "MarkdownRenderer"
  key_links:
    - from: "apps/web/src/components/chat/markdown-renderer.tsx"
      to: "react-markdown"
      via: "import"
      pattern: "import.*ReactMarkdown"
    - from: "apps/web/src/components/chat/message-bubble.tsx"
      to: "apps/web/src/components/chat/markdown-renderer.tsx"
      via: "import"
      pattern: "import.*MarkdownRenderer"
---

<objective>
Add full markdown rendering with syntax highlighting and code copy to chat messages, completing the chat experience polish.

Purpose: Chat messages from LLMs contain rich markdown (headers, code blocks, tables, lists). Without proper rendering, the chat is barely usable. This covers the user decision for "full markdown rendering: headers, bold, lists, code blocks with syntax highlighting and copy button, tables."
Output: Rich markdown rendering in all assistant messages, including during streaming.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-RESEARCH.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-CONTEXT.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-04-SUMMARY.md

@apps/web/src/components/chat/message-bubble.tsx
@apps/web/src/components/chat/message-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Markdown renderer with syntax highlighting and code copy</name>
  <files>
    apps/web/src/components/chat/markdown-renderer.tsx
    apps/web/src/components/chat/message-bubble.tsx
    apps/web/src/components/chat/message-list.tsx
  </files>
  <action>
**markdown-renderer.tsx — Full markdown rendering component:**

Create a `MarkdownRenderer` component using react-markdown + remark-gfm + rehype-highlight (all already installed in Plan 02).

```typescript
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import rehypeHighlight from 'rehype-highlight';
```

Custom component overrides:
- `pre`: Wrap in a `relative group` div. Add a copy button (shadcn Button ghost variant, Copy icon from lucide-react) positioned absolute top-right, opacity-0 group-hover:opacity-100 transition. The copy button extracts text content from the nested `code` element and copies to clipboard via `navigator.clipboard.writeText()`. Show toast "Copied to clipboard" via Sonner on copy.
- `code` (inline): Styled with `bg-muted px-1.5 py-0.5 rounded text-sm font-mono`
- `code` (block, inside `pre`): Styled with `overflow-x-auto rounded-lg bg-muted p-4 text-sm`. rehype-highlight auto-adds `hljs` class for syntax coloring.
- `table`: Styled with `w-full border-collapse` and proper th/td borders matching shadcn aesthetic
- `a`: Styled links with underline and primary color, `target="_blank"` for external links
- `ul`/`ol`: Proper list styling with bullets/numbers and left padding
- `blockquote`: Left border accent, muted text

Import a highlight.js CSS theme that works with dark mode. Use a dark theme like `github-dark` or `atom-one-dark`. Import it in the component: `import 'highlight.js/styles/github-dark.css'` (or add to index.css).

Prop: `content: string` — the markdown string to render.

Memoize with `React.memo` to prevent unnecessary re-renders when parent re-renders but content hasn't changed.

**message-bubble.tsx updates:**
- For assistant messages: replace plain text rendering with `<MarkdownRenderer content={message.content} />`
- For user messages: keep as plain text (users don't write markdown)
- For the streaming message component: render streaming content through `<MarkdownRenderer>` too, so markdown renders progressively as tokens arrive. This means the markdown re-parses on each token — react-markdown handles this efficiently for incremental content.
- Ensure the streaming message component is still isolated (its own component, receives `streamedContent` as prop) so re-renders from token deltas only affect this one component, not the entire message list.

**message-list.tsx updates:**
- Import and use the updated MessageBubble with markdown support
- No structural changes needed — the markdown rendering is encapsulated in MessageBubble

**Performance consideration:**
- For the streaming message, markdown parsing runs on every token update. This is acceptable for chat-length content. If jank appears, buffer tokens with `requestAnimationFrame` and flush at 60fps (but start without this optimization — only add if needed).
- `React.memo` on static MessageBubble components prevents them from re-rendering during streaming.

**Styling:**
- Ensure all markdown elements have proper spacing (margins between paragraphs, lists, code blocks)
- Code blocks: rounded corners, subtle background, monospace font
- Tables: bordered cells, header row with bold text
- All styling via Tailwind classes in the custom component overrides (no separate CSS except highlight.js theme)
  </action>
  <verify>
1. Send a message that generates markdown response (e.g., "Write a Python function to sort a list and explain it with code")
2. Verify: headers render as headers, code blocks have syntax highlighting, lists have bullets
3. Hover over code block — copy button appears, click it — code copied to clipboard, toast shows
4. Tables render with borders
5. During streaming, markdown renders progressively
6. No visible jank during streaming with markdown rendering
7. Inline code renders with monospace background
  </verify>
  <done>
Full markdown rendering in assistant messages: headers, bold, italic, lists, tables, code blocks with syntax highlighting (rehype-highlight) and copy-to-clipboard button. Streaming messages render markdown progressively. Performance is acceptable.
  </done>
</task>

</tasks>

<verification>
1. All markdown elements render correctly in assistant messages
2. Code blocks have syntax highlighting with correct theme colors
3. Copy button works on code blocks
4. Streaming markdown renders without jank
5. User messages remain plain text
6. Timestamps show correctly on all messages
</verification>

<success_criteria>
- Markdown rendering covers all user-specified elements: headers, bold, lists, code blocks with syntax highlighting and copy button, tables
- Code copy works with toast feedback
- Streaming markdown is progressive and smooth
- Dark theme compatible highlight.js styles
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-ui-core-fleet-dashboard/04-05-SUMMARY.md`
</output>
