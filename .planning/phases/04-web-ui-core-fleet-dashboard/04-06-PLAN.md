---
phase: 04-web-ui-core-fleet-dashboard
plan: 06
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - apps/web/src/routes/bots/$botId/index.tsx
  - apps/web/src/routes/bots/$botId/soul.tsx
  - apps/web/src/components/soul/soul-editor.tsx
  - apps/web/src/components/soul/identity-form.tsx
  - apps/web/src/components/soul/markdown-preview.tsx
  - apps/web/src/hooks/use-soul-queries.ts
  - apps/web/src/hooks/use-debounce.ts
autonomous: true

must_haves:
  truths:
    - "User can edit SOUL.md, IDENTITY.md, and USER.md via tabs on the bot detail page"
    - "IDENTITY.md has a form view with model dropdown, temperature slider, max_tokens input and a toggle to raw text editor"
    - "Changes auto-save after 2 seconds of inactivity with debounce"
    - "Editor shows split preview: editor left, rendered markdown preview right"
    - "Bot detail page has tab layout (Overview | Chat | Soul | Settings)"
  artifacts:
    - path: "apps/web/src/components/soul/soul-editor.tsx"
      provides: "Monaco editor wrapper for soul files"
      contains: "Monaco"
    - path: "apps/web/src/components/soul/identity-form.tsx"
      provides: "Form view for IDENTITY.md with model, temperature, max_tokens"
      contains: "temperature"
    - path: "apps/web/src/hooks/use-soul-queries.ts"
      provides: "TanStack Query hooks for soul, identity, and user file CRUD"
      exports: ["useSoul", "useSoulVersions", "useUpdateSoul", "useIdentity", "useUpdateIdentity", "useUserContext", "useUpdateUserContext"]
    - path: "apps/web/src/hooks/use-debounce.ts"
      provides: "Debounced callback hook for auto-save"
      exports: ["useDebouncedCallback"]
  key_links:
    - from: "apps/web/src/components/soul/soul-editor.tsx"
      to: "/api/v1/bots/{id}/soul"
      via: "useUpdateSoul mutation"
      pattern: "useUpdateSoul"
    - from: "apps/web/src/components/soul/identity-form.tsx"
      to: "/api/v1/bots/{id}/identity"
      via: "useUpdateIdentity mutation"
      pattern: "useUpdateIdentity"
    - from: "apps/web/src/components/soul/soul-editor.tsx"
      to: "@monaco-editor/react"
      via: "import"
      pattern: "import.*Editor.*monaco"
---

<objective>
Build the soul editor with Monaco, file tabs (SOUL.md/IDENTITY.md/USER.md), auto-save, identity form view, and split markdown preview. Wire up the bot detail page with tab navigation.

Purpose: The soul editor is how users shape their bots' personalities. This covers requirements WEBU-03 (soul/config editor with version history) — the editor and auto-save part. Version history comes in Plan 07.
Output: A functional soul editor at `/bots/$botId/soul` with real-time editing and auto-save.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-RESEARCH.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-CONTEXT.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-02-SUMMARY.md

@apps/web/src/lib/api-client.ts
@apps/web/src/types/soul.ts
@apps/web/src/types/bot.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bot detail page tabs + soul/identity/user query hooks + debounce</name>
  <files>
    apps/web/src/routes/bots/$botId/index.tsx
    apps/web/src/routes/bots/$botId/soul.tsx
    apps/web/src/routes/bots/$botId/chat.tsx
    apps/web/src/routes/bots/$botId/settings.tsx
    apps/web/src/hooks/use-soul-queries.ts
    apps/web/src/hooks/use-debounce.ts
  </files>
  <action>
**use-soul-queries.ts — Query hooks for soul, identity, and user files:**

Soul API hooks (existing endpoints):
- `useSoul(botIdOrSlug)` — `queryKey: ['soul', botIdOrSlug]`, calls `GET /bots/{id}/soul`, returns soul content string
- `useSoulVersions(botIdOrSlug)` — `queryKey: ['soul-versions', botIdOrSlug]`, calls `GET /bots/{id}/soul/versions`
- `useSoulVersion(botIdOrSlug, version)` — `queryKey: ['soul-version', botIdOrSlug, version]`, calls `GET /bots/{id}/soul/versions/{version}`
- `useUpdateSoul()` — mutation calling `PUT /bots/{id}/soul` with body `{ content: string, message?: string }`, invalidates `['soul']` and `['soul-versions']`. Auto-generates version label: "Edited {date} at {time}" (per user decision — no commit message prompt). Shows toast "Soul saved".
- `useRollbackSoul()` — mutation calling `POST /bots/{id}/soul/rollback` with body `{ version: number }`, invalidates `['soul']` and `['soul-versions']`. Shows toast "Rolled back to version {N}".

Identity/User file hooks (new endpoints from Plan 01):
- `useIdentity(botIdOrSlug)` — `queryKey: ['identity', botIdOrSlug]`, calls `GET /bots/{id}/identity`, returns `{ raw: string, parsed?: { model, temperature, max_tokens } }`
- `useUpdateIdentity()` — mutation calling `PUT /bots/{id}/identity` with body `{ content: string }`, invalidates `['identity']`. Shows toast "Identity saved".
- `useUserContext(botIdOrSlug)` — `queryKey: ['user-context', botIdOrSlug]`, calls `GET /bots/{id}/user`, returns `{ content: string }`
- `useUpdateUserContext()` — mutation calling `PUT /bots/{id}/user` with body `{ content: string }`, invalidates `['user-context']`. Shows toast "User context saved".

**use-debounce.ts — Debounced callback hook (per user decision: auto-save with 2s debounce):**
```typescript
export function useDebouncedCallback<T extends (...args: any[]) => any>(
  callback: T, delay: number
) {
  const timeoutRef = useRef<ReturnType<typeof setTimeout>>();
  useEffect(() => () => { if (timeoutRef.current) clearTimeout(timeoutRef.current); }, []);
  return useCallback((...args: Parameters<T>) => {
    if (timeoutRef.current) clearTimeout(timeoutRef.current);
    timeoutRef.current = setTimeout(() => callback(...args), delay);
  }, [callback, delay]);
}
```

**Bot detail page — routes/bots/$botId/index.tsx:**
- Load bot data using `useBot(botId)` from use-bot-queries
- Tab layout using shadcn `Tabs` component: Overview | Chat | Soul | Settings (per user decision)
- Each tab links to the corresponding sub-route: `/bots/$botId`, `/bots/$botId/chat`, `/bots/$botId/soul`, `/bots/$botId/settings`
- Breadcrumbs: Dashboard > {Bot Name} > {Tab Name}
- Overview tab (this file): show bot info card — name, description, status, model, creation date, version count, stats
- The tab component should detect the active tab from the current route

**Other bot detail routes (placeholders with correct tab selection):**
- `routes/bots/$botId/chat.tsx` — Bot-specific chat (can embed the chat interface filtered to this bot, or redirect to `/chat` with bot filter). Placeholder for now.
- `routes/bots/$botId/settings.tsx` — Bot settings: rename, change description, change emoji, disable/archive, delete. Use form with bot data populated. Use `useUpdateBot` mutation on save.
  </action>
  <verify>
1. Navigate to `/bots/{botId}` — bot detail page loads with tab navigation
2. Click tabs — URL changes, content switches
3. Overview tab shows bot information
4. Query hooks return data when backend is running
5. Settings tab allows updating bot name/description
  </verify>
  <done>
Bot detail page with tab navigation (Overview, Chat, Soul, Settings). All soul/identity/user query hooks created. Debounce hook ready for auto-save. Bot settings allow editing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Soul editor with Monaco, file tabs, auto-save, identity form, split preview</name>
  <files>
    apps/web/src/routes/bots/$botId/soul.tsx
    apps/web/src/components/soul/soul-editor.tsx
    apps/web/src/components/soul/identity-form.tsx
    apps/web/src/components/soul/markdown-preview.tsx
  </files>
  <action>
**soul-editor.tsx — Monaco-based editor with auto-save:**

Use `@monaco-editor/react` (already installed). The component:
- Accepts `content: string`, `onChange: (value: string) => void`, and `language: string` props
- Renders Monaco Editor with settings:
  - theme: `vs-dark` (matches app dark theme)
  - language: `markdown` for SOUL.md/USER.md, `yaml` for IDENTITY.md raw mode
  - minimap: disabled (`minimap: { enabled: false }`)
  - wordWrap: `on`
  - lineNumbers: `off` (per research recommendation)
  - fontSize: 14
  - padding: `{ top: 16 }`
- Height: fill available container space (use CSS flex-1 or explicit height)
- On change: call `onChange` which triggers debounced save

The Monaco Editor component from `@monaco-editor/react` lazy-loads from CDN by default (Pitfall 8 — avoids bundling 5MB+). No additional configuration needed for CDN loading.

**identity-form.tsx — Form view for IDENTITY.md (per user decision):**
- Default view: structured form with:
  - Model dropdown (shadcn Select): options include known models — "claude-sonnet-4-20250514", "claude-opus-4-20250514", "gpt-4o", "gpt-4o-mini", etc. Pre-populated from parsed identity data.
  - Temperature slider (shadcn Slider): 0.0 to 1.0 in 0.1 steps. Shows current value.
  - Max tokens input (shadcn Input type number): default 4096. Range 256-8192.
- Toggle button to switch to raw text editor (Monaco with yaml language)
- Form changes auto-save with debounce: reconstruct the IDENTITY.md frontmatter string from form values and call `useUpdateIdentity` mutation
- Raw editor mode: shows the full IDENTITY.md file as text, auto-saves with debounce

**markdown-preview.tsx — Rendered markdown preview:**
- Takes `content: string` prop
- Renders markdown using `react-markdown` + `remark-gfm` (same deps as chat markdown)
- Styled for readability: proper typography, spacing, dark mode colors
- Read-only display panel

**routes/bots/$botId/soul.tsx — Soul editor page:**
- File tabs: SOUL.md | IDENTITY.md | USER.md (per user decision: "Supports editing all three files — tabs or dropdown to switch")
- Use shadcn Tabs or ToggleGroup for file selection
- State: `activeFile: 'soul' | 'identity' | 'user'`
- For SOUL.md: split layout — Monaco editor left (flex-1), markdown preview right (flex-1) (per user decision: "Split preview: editor left, rendered markdown preview right")
- For IDENTITY.md: identity-form by default, toggle to raw editor
- For USER.md: split layout same as SOUL.md
- Auto-save wiring:
  - Track `isDirty` state (content changed since last save)
  - On editor change: set dirty, call debounced save (2s delay)
  - Show save status indicator: "Saved", "Saving...", "Unsaved changes"
  - On debounced save: call appropriate mutation (useUpdateSoul for SOUL.md, useUpdateIdentity for IDENTITY.md, useUpdateUserContext for USER.md)
  - For SOUL.md: auto-generate version message "Edited {formatted date}" (per user decision — no commit message prompt)
- Version history panel: placeholder stub for now (right side panel, collapsed by default) — full implementation in Plan 07
- Layout: `flex` row. Editor area takes most space. Preview panel can be toggled. Version history panel placeholder on far right.
  </action>
  <verify>
1. Navigate to `/bots/{botId}/soul` — soul editor loads with SOUL.md content
2. Switch between SOUL.md, IDENTITY.md, USER.md tabs
3. Edit SOUL.md — see live markdown preview on right side
4. Stop typing for 2s — auto-save triggers, toast shows "Soul saved"
5. Switch to IDENTITY.md — form view shows model, temperature, max_tokens
6. Change temperature slider — after 2s, identity auto-saves
7. Toggle to raw IDENTITY.md editor — shows full file content
8. Edit USER.md — same split preview behavior as SOUL.md
  </verify>
  <done>
Soul editor page with three file tabs, Monaco editor, split markdown preview, identity form view with model/temp/tokens, auto-save with 2s debounce, and save status indicator. All edits persist to backend.
  </done>
</task>

</tasks>

<verification>
1. All three files editable: SOUL.md, IDENTITY.md, USER.md
2. Identity form provides structured editing with model dropdown, temperature slider, max_tokens input
3. Auto-save fires 2s after last keystroke
4. Split preview renders markdown in real-time
5. Monaco editor loads without blocking page render (lazy CDN load)
6. Tab navigation on bot detail page works correctly
7. Breadcrumbs show correct path
</verification>

<success_criteria>
- Soul editor matches user decisions: three file tabs, form view for identity, auto-save with debounce, split preview, auto-generated version labels
- Monaco loads efficiently from CDN
- All data persists to backend via API
- Bot detail page has working tab layout (Overview | Chat | Soul | Settings)
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-ui-core-fleet-dashboard/04-06-SUMMARY.md`
</output>
