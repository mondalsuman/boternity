---
phase: 04-web-ui-core-fleet-dashboard
plan: 07
type: execute
wave: 4
depends_on: ["04-06"]
files_modified:
  - apps/web/src/components/soul/version-timeline.tsx
  - apps/web/src/components/soul/diff-viewer.tsx
  - apps/web/src/components/soul/rollback-dialog.tsx
  - apps/web/src/routes/bots/$botId/soul.tsx
autonomous: true

must_haves:
  truths:
    - "User can see version history in a collapsible right side panel with a visual timeline"
    - "Timeline shows vertical dots with connecting lines and auto-generated version labels"
    - "User can select two versions and see a side-by-side diff"
    - "User can rollback to a previous version via confirmation dialog with preview"
  artifacts:
    - path: "apps/web/src/components/soul/version-timeline.tsx"
      provides: "Collapsible version history panel with visual timeline"
      contains: "timeline"
    - path: "apps/web/src/components/soul/diff-viewer.tsx"
      provides: "Side-by-side diff using Monaco DiffEditor"
      contains: "DiffEditor"
    - path: "apps/web/src/components/soul/rollback-dialog.tsx"
      provides: "Rollback confirmation dialog with version preview"
      contains: "useRollbackSoul"
  key_links:
    - from: "apps/web/src/components/soul/version-timeline.tsx"
      to: "/api/v1/bots/{id}/soul/versions"
      via: "useSoulVersions hook"
      pattern: "useSoulVersions"
    - from: "apps/web/src/components/soul/diff-viewer.tsx"
      to: "@monaco-editor/react"
      via: "DiffEditor import"
      pattern: "DiffEditor"
    - from: "apps/web/src/components/soul/rollback-dialog.tsx"
      to: "/api/v1/bots/{id}/soul/rollback"
      via: "useRollbackSoul mutation"
      pattern: "useRollbackSoul"
---

<objective>
Add version history timeline, side-by-side diff viewer, and rollback functionality to the soul editor.

Purpose: Version history lets users see how their bot's personality evolved and safely rollback mistakes. This completes requirement WEBU-03 (soul editor with version history and diff view).
Output: Collapsible version timeline panel, Monaco DiffEditor for comparing versions, and rollback with confirmation.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-RESEARCH.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-CONTEXT.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-06-SUMMARY.md

@apps/web/src/routes/bots/$botId/soul.tsx
@apps/web/src/hooks/use-soul-queries.ts
@apps/web/src/components/soul/soul-editor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Version timeline panel with visual dots and connecting lines</name>
  <files>
    apps/web/src/components/soul/version-timeline.tsx
    apps/web/src/routes/bots/$botId/soul.tsx
  </files>
  <action>
**version-timeline.tsx — Collapsible version history panel (per user decision):**

Per user decision: "Version history in a collapsible right side panel with visual timeline (vertical dots + connecting lines)"

Component structure:
- Uses shadcn `Collapsible` or custom toggle for collapse/expand
- Header: "Version History" title + collapse toggle button (ChevronLeft/ChevronRight icon)
- Width: ~280px when expanded, 0 when collapsed (with smooth transition)
- Content: vertical timeline using custom CSS

Timeline rendering:
- Load versions via `useSoulVersions(botId)` — returns array of versions ordered newest first
- Each version entry shows:
  - A colored dot (circle) on the vertical line — current version gets a filled primary-color dot, older versions get outlined muted dots
  - Auto-generated label: "Edited {date} at {time}" formatted from the version timestamp (per user decision — no commit messages, auto-generated labels)
  - Version number: small badge showing "v{N}"
  - Relative time: "2 hours ago", "yesterday" via date-fns formatDistanceToNow
- The vertical line connects all dots (CSS border-left or custom SVG)

Interactions:
- Click a version: select it for preview (loads version content into a read-only view)
- "Compare" button: select two versions to open diff viewer (show checkboxes or "Compare with..." action)
- "Restore" button on each version: opens rollback confirmation dialog
- Selected version highlighted with background color

CSS for the timeline:
```css
/* Vertical dots + connecting line */
.timeline-item {
  position: relative;
  padding-left: 24px;
}
.timeline-item::before {
  content: '';
  position: absolute;
  left: 7px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: hsl(var(--muted));
}
.timeline-dot {
  position: absolute;
  left: 2px;
  top: 6px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid hsl(var(--primary));
}
```

Or use Tailwind equivalents with pseudo-elements.

Loading state: show 5 skeleton timeline items.

**routes/bots/$botId/soul.tsx updates:**
- Add the version timeline panel to the right side of the soul editor layout
- Layout becomes: editor + preview (left, flex-1) | version timeline (right, collapsible)
- Add a "History" toggle button in the soul editor toolbar/header to show/hide the panel
- When a version is selected in the timeline: optionally show that version's content in a read-only overlay or replace the preview pane with version content
- Default state: collapsed (per user decision: "collapsible right side panel")
  </action>
  <verify>
1. Navigate to soul editor, click "History" button — version timeline panel slides open on right
2. Timeline shows all versions with dots, connecting lines, and auto-generated labels
3. Current version highlighted with filled dot
4. Click a version — it is selected/highlighted
5. Collapse button hides the panel smoothly
6. Loading skeletons show while versions load
  </verify>
  <done>
Collapsible version history panel with visual timeline (dots + connecting lines), auto-generated version labels, relative timestamps, and version selection. Integrates into soul editor layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Side-by-side diff viewer + rollback dialog</name>
  <files>
    apps/web/src/components/soul/diff-viewer.tsx
    apps/web/src/components/soul/rollback-dialog.tsx
    apps/web/src/components/soul/version-timeline.tsx
    apps/web/src/routes/bots/$botId/soul.tsx
  </files>
  <action>
**diff-viewer.tsx — Side-by-side diff using Monaco DiffEditor (per user decision):**

Per user decision: "Side-by-side diff view for comparing versions (read-only)"

Use `DiffEditor` from `@monaco-editor/react` (included in the same package as Editor — no extra install needed).

```typescript
import { DiffEditor } from '@monaco-editor/react';

function DiffViewer({ original, modified, originalLabel, modifiedLabel }) {
  return (
    <div className="flex flex-col h-full">
      <div className="flex justify-between px-4 py-2 border-b text-sm text-muted-foreground">
        <span>{originalLabel}</span>
        <span>{modifiedLabel}</span>
      </div>
      <DiffEditor
        original={original}
        modified={modified}
        language="markdown"
        theme="vs-dark"
        options={{
          readOnly: true,
          renderSideBySide: true,
          minimap: { enabled: false },
          lineNumbers: 'on',
          wordWrap: 'on',
        }}
      />
    </div>
  );
}
```

Props:
- `original: string` — the older version content
- `modified: string` — the newer version content
- `originalLabel: string` — e.g., "Version 3 — Feb 10, 2026"
- `modifiedLabel: string` — e.g., "Version 5 (current) — Feb 12, 2026"

The diff view opens as a modal/overlay or replaces the editor pane when comparing versions. Use shadcn Dialog with full-screen-like dimensions (max-w-6xl h-[80vh]).

**rollback-dialog.tsx — Rollback confirmation (per user decision):**

Per user decision: "Rollback via confirmation dialog: select version -> 'Restore this version?' with preview -> confirm"

Use shadcn `AlertDialog` component:
- Title: "Restore Version {N}?"
- Description: "This will create a new version with the content from version {N}. Your current content will be preserved as the previous version."
- Preview area: show a read-only Monaco editor (or plain text) with the version content being restored
- Buttons: "Cancel" and "Restore" (destructive variant for Restore)
- On confirm: call `useRollbackSoul({ botId, version: N })`
- On success: close dialog, toast "Rolled back to version {N}", timeline refreshes
- Loading state on Restore button while mutation is pending

**version-timeline.tsx updates:**
- Add "Compare with current" action on each version (except current): opens diff viewer comparing selected version with current version
- Add "Compare selected" mode: user selects two versions, compare button opens diff viewer
- Add "Restore" button on each version (except current): opens rollback dialog

**routes/bots/$botId/soul.tsx updates:**
- Wire diff viewer dialog: state for `diffVersions: { original: string, modified: string } | null`
- Wire rollback dialog: state for `rollbackVersion: number | null`
- Pass callbacks to version timeline for "compare" and "restore" actions
- When diff viewer opens, load both version contents via `useSoulVersion` queries
  </action>
  <verify>
1. In version timeline, click "Compare with current" on a past version — diff viewer opens showing side-by-side comparison
2. Diff highlights additions (green) and deletions (red)
3. Diff viewer is read-only (cannot edit)
4. Click "Restore" on a past version — confirmation dialog opens with preview
5. Confirm restore — rollback succeeds, toast shows, current content updates, new version appears in timeline
6. Cancel restore — dialog closes, no changes
  </verify>
  <done>
Side-by-side diff viewer using Monaco DiffEditor for comparing any two versions. Rollback dialog with content preview and confirmation. Full version history workflow: browse versions -> compare -> rollback.
  </done>
</task>

</tasks>

<verification>
1. Version timeline loads and displays all versions with visual dots and lines
2. Diff viewer shows accurate side-by-side comparison
3. Rollback creates a new version (does not delete history)
4. All version labels are auto-generated timestamps (no manual commit messages)
5. Panel is collapsible and doesn't affect editor when collapsed
6. Timeline refreshes after save or rollback
</verification>

<success_criteria>
- Version history matches user decisions: collapsible right panel, visual timeline with dots and lines, auto-generated labels, side-by-side diff, rollback with confirmation
- Monaco DiffEditor provides word-level diff highlighting
- Rollback works end-to-end via the existing `/soul/rollback` API
- Timeline updates reactively after edits and rollbacks
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-ui-core-fleet-dashboard/04-07-SUMMARY.md`
</output>
