---
phase: 04-web-ui-core-fleet-dashboard
plan: 08
type: execute
wave: 5
depends_on: ["04-03", "04-05", "04-07"]
files_modified:
  - apps/web/vite.config.ts
  - apps/web/public/icons/icon-192.png
  - apps/web/public/icons/icon-512.png
  - apps/web/public/offline.html
  - apps/web/src/routes/__root.tsx
  - apps/web/src/components/layout/app-sidebar.tsx
  - apps/web/src/routes/index.tsx
  - apps/web/src/index.css
autonomous: false

must_haves:
  truths:
    - "Web app is installable as a PWA with manifest and service worker"
    - "App works on mobile devices with responsive layout"
    - "Sidebar becomes hamburger-triggered drawer on mobile"
    - "Bot grid adapts from 1 column on mobile to 3-4 columns on desktop"
    - "Create Bot FAB is visible on mobile, header button on desktop"
    - "PWA service worker does NOT cache API routes"
  artifacts:
    - path: "apps/web/vite.config.ts"
      provides: "VitePWA configuration with manifest and workbox"
      contains: "VitePWA"
    - path: "apps/web/public/icons/icon-192.png"
      provides: "PWA icon 192x192"
    - path: "apps/web/public/icons/icon-512.png"
      provides: "PWA icon 512x512"
  key_links:
    - from: "apps/web/vite.config.ts"
      to: "vite-plugin-pwa"
      via: "VitePWA plugin config"
      pattern: "VitePWA"
    - from: "apps/web/vite.config.ts"
      to: "workbox"
      via: "navigateFallbackDenylist"
      pattern: "navigateFallbackDenylist.*api"
---

<objective>
Configure PWA (service worker, manifest, icons, offline page) and polish responsive layout across all pages for mobile devices.

Purpose: This makes the app installable on phones/tablets and ensures the full UI works on smaller screens. Covers requirements WEBU-09 (PWA) and WEBU-10 (responsive/mobile).
Output: An installable PWA with responsive layout across dashboard, chat, and soul editor.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-RESEARCH.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-CONTEXT.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-03-SUMMARY.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-05-SUMMARY.md
@.planning/phases/04-web-ui-core-fleet-dashboard/04-07-SUMMARY.md

@apps/web/vite.config.ts
@apps/web/src/routes/__root.tsx
@apps/web/src/components/layout/app-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: PWA configuration — manifest, service worker, icons, offline page</name>
  <files>
    apps/web/vite.config.ts
    apps/web/public/icons/icon-192.png
    apps/web/public/icons/icon-512.png
    apps/web/public/offline.html
  </files>
  <action>
**vite.config.ts — Configure VitePWA plugin:**

Update the VitePWA configuration in vite.config.ts (currently has minimal `registerType: 'autoUpdate'`):

```typescript
VitePWA({
  registerType: 'autoUpdate',
  includeAssets: ['icons/*.png'],
  manifest: {
    name: 'Boternity',
    short_name: 'Boternity',
    description: 'Bot fleet management and chat',
    theme_color: '#0a0a0a',
    background_color: '#0a0a0a',
    display: 'standalone',
    start_url: '/',
    icons: [
      { src: '/icons/icon-192.png', sizes: '192x192', type: 'image/png' },
      { src: '/icons/icon-512.png', sizes: '512x512', type: 'image/png', purpose: 'any maskable' },
    ],
  },
  workbox: {
    // CRITICAL: Do NOT cache API routes (Pitfall 10)
    navigateFallback: '/index.html',
    navigateFallbackDenylist: [/^\/api\//, /^\/health/],
    globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
    runtimeCaching: [
      {
        // Cache static assets aggressively
        urlPattern: /\.(?:png|jpg|jpeg|svg|gif|woff2?)$/,
        handler: 'CacheFirst',
        options: {
          cacheName: 'static-assets',
          expiration: { maxEntries: 100, maxAgeSeconds: 30 * 24 * 60 * 60 },
        },
      },
    ],
  },
})
```

**PWA icons:**
- Create simple placeholder icons. Use a Node script or canvas-based approach to generate 192x192 and 512x512 PNG icons with "B" letter on dark background (matching theme_color #0a0a0a with white text). Or create SVG icons and convert.
- If programmatic generation is complex, create minimal valid PNG files. The exact icon design is at Claude's discretion per user decisions.
- Place in `apps/web/public/icons/`

**Offline page:**
- Create `apps/web/public/offline.html` — minimal HTML page showing "You're offline. Please check your connection." with Boternity branding. Dark background, centered text. No external dependencies (pure inline CSS).
  </action>
  <verify>
1. Run `pnpm build` in apps/web — service worker generated in dist/
2. Run `pnpm preview` — app loads, check DevTools > Application > Manifest — shows correct manifest
3. DevTools > Application > Service Workers — SW registered
4. DevTools > Application > Cache Storage — static assets cached, no API responses
5. In Chrome: install prompt appears (or use DevTools > Application > Manifest > "Install" button)
  </verify>
  <done>
PWA configured with manifest, service worker (autoUpdate), icons (192+512), and offline fallback. API routes excluded from caching. App is installable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Responsive layout polish across all pages</name>
  <files>
    apps/web/src/routes/__root.tsx
    apps/web/src/components/layout/app-sidebar.tsx
    apps/web/src/routes/index.tsx
    apps/web/src/index.css
  </files>
  <action>
Audit and polish responsive behavior across all UI components. The shadcn Sidebar component handles most mobile behavior automatically, but other layouts need attention.

**Breakpoint strategy (Claude's discretion, per research recommendation):**
- Mobile: `< 640px` (sm) — single column, hamburger sidebar
- Tablet: `640-1024px` (sm-lg) — 2 columns, sidebar rail
- Desktop: `> 1024px` (lg+) — 3-4 columns, full sidebar

**app-sidebar.tsx — Mobile drawer:**
- The shadcn Sidebar with `collapsible="icon"` already handles mobile via Sheet component. Verify it works correctly:
  - On mobile viewports, sidebar should NOT be visible by default
  - A hamburger menu button (SidebarTrigger) should appear in the top-left corner
  - Clicking hamburger opens the sidebar as a drawer/sheet overlay
  - Clicking outside closes it
- If the default behavior doesn't match, configure the Sidebar component's `defaultOpen` based on viewport: `defaultOpen={false}` for mobile, `defaultOpen={true}` for desktop
- Per user decision: "Mobile: sidebar becomes hamburger-triggered drawer"

**__root.tsx — Layout adjustments:**
- Ensure the main content area has proper padding on mobile (px-4 on mobile, px-6 on desktop)
- Breadcrumbs may need to truncate on mobile (show only current page, not full path)
- Command palette: ensure it works on mobile (full-width on small screens)

**Dashboard (routes/index.tsx) — Responsive grid:**
- Bot grid: already `grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4` from Plan 03
- Stats bar: on mobile, stack stats vertically or use 3-column compact layout
- Create Bot: FAB on mobile (already implemented in Plan 03), verify it doesn't overlap content
- Search/sort: on mobile, make search full-width, sort dropdown below search (or in a filter sheet)

**Chat layout:**
- Two-panel (sidebar + messages) on desktop
- On mobile: session sidebar should be a sheet/drawer triggered by a menu button, main area shows messages
- Chat input: full-width on mobile, proper bottom padding for safe area (iPhone notch)
- Add safe area padding: `env(safe-area-inset-bottom)` to chat input container

**Soul editor:**
- Split preview: on mobile, show editor full-width with a toggle to switch between editor and preview (not side-by-side — not enough space)
- Version timeline: on mobile, show as a bottom sheet instead of right panel
- Identity form: fields stack vertically on mobile (already default with flex-col)

**Global CSS (index.css):**
- Add safe area insets for PWA standalone mode:
  ```css
  @supports (padding: env(safe-area-inset-top)) {
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
  }
  ```
- Ensure no horizontal overflow on mobile (overflow-x-hidden on body or main)
- Touch targets: ensure all interactive elements are at least 44x44px on mobile (standard touch target size)

**Testing checklist (use browser DevTools responsive mode):**
- iPhone SE (375px): sidebar as drawer, single column grid, stacked stats, full-width search
- iPad (768px): 2-column grid, sidebar rail, side-by-side chat panels
- Desktop (1440px): 3-4 column grid, full sidebar, three-panel layouts
  </action>
  <verify>
Resize browser to mobile dimensions (375px width):
1. Sidebar is hidden, hamburger button visible
2. Bot grid is single column
3. Chat shows messages full-width, session list in drawer
4. Soul editor is full-width with toggle for preview
5. FAB visible for Create Bot
6. No horizontal scrolling anywhere
7. All touch targets are tappable

Resize to tablet (768px):
1. Bot grid 2 columns
2. Chat has sidebar + messages side-by-side

Desktop (1440px):
1. Bot grid 3-4 columns
2. Full sidebar expanded
3. Three-panel soul editor
  </verify>
  <done>
Responsive layout works across mobile, tablet, and desktop. Sidebar is hamburger drawer on mobile, icon rail on tablet, full on desktop. Bot grid adapts columns. Chat and soul editor layouts optimize for screen size. Safe area insets for PWA standalone mode.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete web UI: fleet dashboard with bot cards/stats, streaming chat with markdown, soul editor with version history/diff, PWA installable, responsive across devices</what-built>
  <how-to-verify>
1. Start the Rust backend: `cargo run -p boternity-api -- serve`
2. Start the web app: `cd apps/web && pnpm dev`
3. Open http://localhost:5173 in Chrome

**Dashboard:**
- Verify stats bar at top with correct counts
- Verify bot cards show emoji, name, status badge, model, activity
- Click a stat to filter the grid
- Search by name, change sort order
- Create a new bot via the button (or FAB on mobile viewport)

**Chat:**
- Navigate to Chat, select or create a session
- Send a message, verify streaming tokens appear with "thinking" indicator first
- Verify markdown renders correctly (send "Write a Python hello world with explanation")
- Verify code block has copy button
- Click Stop during streaming
- Create multiple sessions with same bot

**Soul Editor:**
- Navigate to a bot's Soul tab
- Edit SOUL.md, verify split preview updates live
- Wait 2s — verify auto-save toast appears
- Switch to IDENTITY.md — verify form with model/temp/tokens
- Open version history — verify timeline with dots and labels
- Compare two versions — verify side-by-side diff
- Rollback to a previous version — verify confirmation dialog

**PWA:**
- Open DevTools > Application — verify manifest, service worker
- Resize to mobile width — verify hamburger sidebar, single column grid, FAB

**Mobile (DevTools responsive mode at 375px):**
- Navigate all pages — no horizontal scroll, touch targets adequate
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. PWA manifest valid with correct icons and theme
2. Service worker does NOT cache API responses
3. App installable on desktop and mobile browsers
4. All pages responsive at mobile, tablet, and desktop breakpoints
5. No horizontal overflow on any page at any breakpoint
6. Safe area insets work for PWA standalone mode
</verification>

<success_criteria>
- PWA installable with service worker, manifest, and icons
- Responsive layout works at all specified breakpoints
- Sidebar behavior matches user decisions (hamburger on mobile, rail on tablet, full on desktop)
- All previous features still work after responsive polish
- Human verification confirms the complete web UI works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-ui-core-fleet-dashboard/04-08-SUMMARY.md`
</output>
