---
phase: 05-agent-hierarchy-event-system
plan: 05
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - crates/boternity-infra/src/config.rs
  - crates/boternity-infra/src/lib.rs
  - crates/boternity-infra/src/llm/pricing.rs
  - crates/boternity-infra/src/llm/mod.rs
autonomous: true

must_haves:
  truths:
    - "config.toml at ~/.boternity/config.toml is parsed into GlobalConfig with default_request_budget"
    - "Missing config.toml returns GlobalConfig::default() (500_000 token budget)"
    - "Cost estimation uses hardcoded per-provider pricing with user override from config.toml"
    - "Cost is formatted as ~$0.xx for estimates"
  artifacts:
    - path: "crates/boternity-infra/src/config.rs"
      provides: "load_global_config() and resolve_request_budget()"
      contains: "pub async fn load_global_config"
    - path: "crates/boternity-infra/src/llm/pricing.rs"
      provides: "estimate_cost(), format_cost(), default_pricing_table()"
      contains: "pub fn estimate_cost"
  key_links:
    - from: "crates/boternity-infra/src/config.rs"
      to: "crates/boternity-types/src/config.rs"
      via: "deserializes into GlobalConfig type"
      pattern: "GlobalConfig"
    - from: "crates/boternity-infra/src/llm/pricing.rs"
      to: "crates/boternity-types/src/config.rs"
      via: "uses ProviderPricing for user overrides"
      pattern: "ProviderPricing"
---

<objective>
Implement config.toml loading and cost estimation infrastructure.

Purpose: Budget enforcement needs to know the budget limit (from config.toml or IDENTITY.md). Cost display needs pricing data. Both are infrastructure concerns in boternity-infra.
Output: Config loader and pricing module.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-agent-hierarchy-event-system/05-RESEARCH.md
@.planning/phases/05-agent-hierarchy-event-system/05-01-SUMMARY.md
@crates/boternity-infra/src/lib.rs
@crates/boternity-infra/src/llm/mod.rs
@crates/boternity-infra/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config.toml loader</name>
  <files>
    crates/boternity-infra/src/config.rs
    crates/boternity-infra/src/lib.rs
  </files>
  <action>
**Create `crates/boternity-infra/src/config.rs`:**

```rust
use std::path::Path;
use boternity_types::config::GlobalConfig;
```

Functions:

1. `pub async fn load_global_config(data_dir: &Path) -> GlobalConfig`
   - Reads `{data_dir}/config.toml` (which is `~/.boternity/config.toml` in production)
   - If file doesn't exist: return `GlobalConfig::default()` (500_000 budget)
   - If file exists but fails to parse: log warning, return default
   - If file exists and parses: return the parsed GlobalConfig
   - Uses `tokio::fs::read_to_string()` then `toml::from_str()`

2. `pub fn resolve_request_budget(global_config: &GlobalConfig, identity_override: Option<u32>) -> u32`
   - Per user decision: "Per-request token budgets have system defaults with per-bot override in IDENTITY.md frontmatter (max_request_tokens field)"
   - If `identity_override` is Some, use it (bot-specific override)
   - Otherwise, use `global_config.default_request_budget`
   - Minimum 10_000 tokens (safety floor)

Example config.toml format:
```toml
default_request_budget = 500000

[[provider_pricing]]
provider_name = "anthropic"
model_pattern = "claude-sonnet-*"
input_cost_per_million = 3.0
output_cost_per_million = 15.0

[[provider_pricing]]
provider_name = "openai"
model_pattern = "gpt-4*"
input_cost_per_million = 5.0
output_cost_per_million = 15.0
```

**Update `crates/boternity-infra/src/lib.rs`:**
Add `pub mod config;`

**Tests:**
- load_global_config with missing file returns default (use tempdir)
- load_global_config with valid toml returns parsed values
- load_global_config with invalid toml returns default
- resolve_request_budget with identity override uses override
- resolve_request_budget without override uses global default
- resolve_request_budget enforces minimum 10_000
  </action>
  <verify>Run `cargo test -p boternity-infra -- config` -- all tests pass.</verify>
  <done>Config.toml loader reads ~/.boternity/config.toml into GlobalConfig with graceful fallback to defaults. Budget resolution supports per-bot override from IDENTITY.md frontmatter.</done>
</task>

<task type="auto">
  <name>Task 2: Cost estimation and pricing table</name>
  <files>
    crates/boternity-infra/src/llm/pricing.rs
    crates/boternity-infra/src/llm/mod.rs
  </files>
  <action>
**Create `crates/boternity-infra/src/llm/pricing.rs`:**

Per user decision: "Cost estimation uses hardcoded per-provider pricing with user override capability in provider config."

1. `pub fn default_pricing_table() -> Vec<PricingEntry>` -- hardcoded pricing for known models

PricingEntry struct (private to this module):
```rust
struct PricingEntry {
    provider: &'static str,
    model_pattern: &'static str,
    input_cost_per_million: f64,
    output_cost_per_million: f64,
}
```

Hardcoded entries (approximate as of early 2026):
- anthropic / claude-sonnet-4* -> $3.00 / $15.00
- anthropic / claude-opus-4* -> $15.00 / $75.00
- anthropic / claude-haiku-3* -> $0.25 / $1.25
- openai / gpt-4o* -> $2.50 / $10.00
- openai / gpt-4o-mini* -> $0.15 / $0.60
- google / gemini-2* -> $1.25 / $5.00
- mistral / mistral-large* -> $2.00 / $6.00
- bedrock / * -> same as anthropic (pass-through pricing)

2. `pub fn estimate_cost(input_tokens: u32, output_tokens: u32, model: &str, provider: &str, user_pricing: &[ProviderPricing]) -> f64`
   - First check user_pricing overrides (from config.toml)
   - Then check default_pricing_table
   - Match model against patterns (simple prefix match, not glob)
   - Return estimated cost in dollars
   - If no match found, use conservative fallback ($5.00 / $15.00 per million)

3. `pub fn format_cost(cost: f64) -> String`
   - Per user decision: "Completed requests show estimated cost alongside token count (e.g., ~$0.12 estimated)"
   - Per specific idea: "Cost estimates should be clearly labeled as estimates"
   - If cost < 0.01: format as `~$0.001` (3 decimal places)
   - If cost >= 0.01: format as `~$0.12` (2 decimal places)
   - Always prefix with `~` to indicate estimate

**Update `crates/boternity-infra/src/llm/mod.rs`:**
Add `pub mod pricing;`

**Tests:**
- estimate_cost with known model returns correct value
- estimate_cost with user override takes priority over hardcoded
- estimate_cost with unknown model uses fallback
- format_cost formats small amounts with 3 decimal places
- format_cost formats normal amounts with 2 decimal places
- default_pricing_table covers all major providers
  </action>
  <verify>Run `cargo test -p boternity-infra -- pricing` -- all tests pass. Run `cargo check --workspace` -- compiles.</verify>
  <done>Cost estimation with hardcoded pricing table and user override support. format_cost clearly labels estimates. Workspace compiles.</done>
</task>

</tasks>

<verification>
- `cargo test -p boternity-infra` passes all new tests
- `cargo check --workspace` compiles
- Config loader gracefully handles missing/invalid config.toml
- Cost estimation covers all major providers with user override capability
- Budget resolution supports per-bot override from IDENTITY.md
</verification>

<success_criteria>
Config loading and cost estimation infrastructure is complete. load_global_config() reads config.toml with graceful defaults. estimate_cost() provides cost figures for budget displays. resolve_request_budget() merges global defaults with per-bot overrides.
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-hierarchy-event-system/05-05-SUMMARY.md`
</output>
