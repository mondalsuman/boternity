---
phase: 05-agent-hierarchy-event-system
plan: 08
type: execute
wave: 4
depends_on: ["05-06"]
files_modified:
  - apps/web/src/hooks/use-websocket.ts
  - apps/web/src/hooks/use-agent-tree.ts
  - apps/web/src/stores/agent-store.ts
  - apps/web/src/types/agent.ts
  - apps/web/src/components/chat/agent-block.tsx
  - apps/web/src/components/chat/agent-tree-panel.tsx
  - apps/web/src/components/chat/budget-indicator.tsx
  - apps/web/src/components/chat/ws-status.tsx
  - apps/web/src/components/chat/message-list.tsx
  - apps/web/src/hooks/use-sse-chat.ts
autonomous: true

must_haves:
  truths:
    - "WebSocket connection to /ws/events with exponential backoff reconnection"
    - "Agent tree state managed in Zustand store, updated from WebSocket events"
    - "Sub-agent blocks rendered inline in chat as collapsible components with streaming text"
    - "Agent tree panel shows process-manager style view with per-agent stop buttons"
    - "Budget indicator shows usage bar with cost estimate"
    - "WebSocket connection status indicator visible (Connected / Reconnecting / Disconnected)"
    - "SSE chat hook processes agent_spawned, agent_text_delta, agent_completed events"
  artifacts:
    - path: "apps/web/src/hooks/use-websocket.ts"
      provides: "WebSocket hook with exponential backoff reconnection"
      contains: "export function useAgentWebSocket"
    - path: "apps/web/src/stores/agent-store.ts"
      provides: "Agent tree + budget state management"
      contains: "export const useAgentStore"
    - path: "apps/web/src/components/chat/agent-block.tsx"
      provides: "Collapsible sub-agent block for inline chat display"
      contains: "export function AgentBlock"
    - path: "apps/web/src/components/chat/agent-tree-panel.tsx"
      provides: "Process-manager style tree panel with cancel buttons"
      contains: "export function AgentTreePanel"
    - path: "apps/web/src/components/chat/budget-indicator.tsx"
      provides: "Budget usage bar with cost estimate"
      contains: "export function BudgetIndicator"
    - path: "apps/web/src/components/chat/ws-status.tsx"
      provides: "WebSocket connection status indicator"
      contains: "export function WsStatus"
    - path: "apps/web/src/types/agent.ts"
      provides: "TypeScript types matching Rust AgentEvent enum"
      contains: "AgentEvent"
  key_links:
    - from: "apps/web/src/hooks/use-websocket.ts"
      to: "/ws/events"
      via: "WebSocket connection to backend"
      pattern: "ws/events"
    - from: "apps/web/src/hooks/use-agent-tree.ts"
      to: "apps/web/src/stores/agent-store.ts"
      via: "updates store from WebSocket events"
      pattern: "useAgentStore"
    - from: "apps/web/src/components/chat/agent-block.tsx"
      to: "apps/web/src/stores/agent-store.ts"
      via: "reads agent state from store"
      pattern: "useAgentStore"
---

<objective>
Build the web UI components for agent hierarchy visualization: WebSocket hook, agent tree state, inline sub-agent blocks, tree panel, budget indicator, and connection status.

Purpose: The web UI must show sub-agent activity in real-time. Per user decisions: collapsible blocks inline in chat (like Claude Code's tool use), process-manager tree panel with cancel buttons, budget indicator, and WebSocket status.
Output: Complete frontend agent hierarchy UI.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-agent-hierarchy-event-system/05-RESEARCH.md
@.planning/phases/05-agent-hierarchy-event-system/05-01-SUMMARY.md
@.planning/phases/05-agent-hierarchy-event-system/05-06-SUMMARY.md
@apps/web/src/hooks/use-sse-chat.ts
@apps/web/src/stores/chat-store.ts
@apps/web/src/components/chat/message-list.tsx
@apps/web/src/components/chat/message-bubble.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent types, WebSocket hook, and agent store</name>
  <files>
    apps/web/src/types/agent.ts
    apps/web/src/hooks/use-websocket.ts
    apps/web/src/hooks/use-agent-tree.ts
    apps/web/src/stores/agent-store.ts
  </files>
  <action>
**Create `apps/web/src/types/agent.ts`:**

TypeScript types matching the Rust AgentEvent enum (tagged union via `type` field):

```typescript
export type AgentEvent =
  | { type: "agent_spawned"; agent_id: string; parent_id: string | null; task_description: string; depth: number; index: number; total: number }
  | { type: "agent_text_delta"; agent_id: string; text: string }
  | { type: "agent_completed"; agent_id: string; result_summary: string; tokens_used: number; duration_ms: number }
  | { type: "agent_failed"; agent_id: string; error: string; will_retry: boolean }
  | { type: "agent_cancelled"; agent_id: string; reason: string }
  | { type: "budget_update"; request_id: string; tokens_used: number; budget_total: number; percentage: number }
  | { type: "budget_warning"; request_id: string; tokens_used: number; budget_total: number }
  | { type: "budget_exhausted"; request_id: string; tokens_used: number; budget_total: number; completed_agents: string[]; incomplete_agents: string[] }
  | { type: "depth_limit_reached"; agent_id: string; attempted_depth: number; max_depth: number }
  | { type: "cycle_detected"; agent_id: string; cycle_description: string }
  | { type: "synthesis_started"; request_id: string }
  | { type: "memory_created"; agent_id: string; fact: string }
  | { type: "provider_failover"; from_provider: string; to_provider: string; reason: string };

export type AgentStatus = "pending" | "running" | "completed" | "failed" | "cancelled";

export interface AgentNode {
  agentId: string;
  parentId: string | null;
  task: string;
  depth: number;
  index: number;
  total: number;
  status: AgentStatus;
  streamedText: string;
  tokensUsed: number;
  durationMs: number;
}

export type WsConnectionStatus = "connected" | "reconnecting" | "disconnected";
```

**Create `apps/web/src/hooks/use-websocket.ts`:**

Per Claude's discretion (from research): exponential backoff starting at 1s, doubling to max 30s, with 30% jitter, max 10 attempts.

```typescript
export function useAgentWebSocket(url: string)
```

Implementation:
- Uses native WebSocket API (no npm dep per research decision)
- `useRef` for WebSocket instance, attempt counter
- `useState` for connection status: 'connected' | 'reconnecting' | 'disconnected'
- `connect()` function that creates WebSocket, sets up handlers:
  - `onopen`: reset attempt counter, set status 'connected'
  - `onmessage`: parse JSON, forward to listeners
  - `onclose`: set status 'reconnecting', schedule reconnect with backoff
  - `onerror`: handled by onclose
- Reconnection: `getReconnectDelay(attempt)` = `min(1000 * 2^attempt, 30000)` + jitter
- Max 10 attempts, then 'disconnected'
- `sendCommand(cmd: object)`: sends JSON to server if connected
- `onEvent(fn)`: registers event listener, returns cleanup function
- `useEffect` cleanup: close WebSocket on unmount
- Returns `{ status, sendCommand, onEvent }`

**Create `apps/web/src/stores/agent-store.ts`:**

Zustand store for agent tree state and budget:

```typescript
interface AgentStore {
  // Agent tree
  agents: Map<string, AgentNode>;
  rootAgentIds: string[];

  // Budget
  tokensUsed: number;
  budgetTotal: number;
  budgetPercentage: number;
  budgetWarning: boolean;
  budgetExhausted: boolean;

  // Actions
  handleEvent: (event: AgentEvent) => void;
  reset: () => void;
  getAgentChildren: (agentId: string) => AgentNode[];
  getAgentTree: () => AgentNode[];  // Returns root agents with nested children
}
```

The `handleEvent` reducer processes each AgentEvent type:
- `agent_spawned`: add new AgentNode with status "running"
- `agent_text_delta`: append text to agent's streamedText
- `agent_completed`: update status to "completed", set tokens/duration
- `agent_failed`: update status to "failed"
- `agent_cancelled`: update status to "cancelled"
- `budget_update`: update budget fields
- `budget_warning`: set budgetWarning true
- `budget_exhausted`: set budgetExhausted true
- Others: no-op for store (displayed via toasts or inline)

Use `immer` middleware if available, otherwise plain functional updates with Map spread.

**Create `apps/web/src/hooks/use-agent-tree.ts`:**

Custom hook that connects WebSocket to agent store:

```typescript
export function useAgentTree() {
  const ws = useAgentWebSocket(`ws://${window.location.host}/ws/events`);
  const store = useAgentStore();

  useEffect(() => {
    return ws.onEvent((event: AgentEvent) => {
      store.handleEvent(event);
    });
  }, [ws, store]);

  return {
    agents: store.agents,
    status: ws.status,
    sendCommand: ws.sendCommand,
    budgetInfo: {
      tokensUsed: store.tokensUsed,
      budgetTotal: store.budgetTotal,
      percentage: store.budgetPercentage,
      warning: store.budgetWarning,
      exhausted: store.budgetExhausted,
    },
    cancelAgent: (agentId: string) => {
      ws.sendCommand({ type: "cancel_agent", agent_id: agentId });
    },
    budgetContinue: (requestId: string) => {
      ws.sendCommand({ type: "budget_continue", request_id: requestId });
    },
    budgetStop: (requestId: string) => {
      ws.sendCommand({ type: "budget_stop", request_id: requestId });
    },
    reset: store.reset,
  };
}
```
  </action>
  <verify>Run `cd /Users/smxaz7/Desktop/Suman/Projects/gh/boternity/apps/web && pnpm tsc --noEmit` -- TypeScript compiles without errors.</verify>
  <done>Agent types, WebSocket hook with reconnection, agent store, and agent tree hook are complete. The store processes all AgentEvent types into a tree structure.</done>
</task>

<task type="auto">
  <name>Task 2: Agent UI components and SSE chat hook integration</name>
  <files>
    apps/web/src/components/chat/agent-block.tsx
    apps/web/src/components/chat/agent-tree-panel.tsx
    apps/web/src/components/chat/budget-indicator.tsx
    apps/web/src/components/chat/ws-status.tsx
    apps/web/src/components/chat/message-list.tsx
    apps/web/src/hooks/use-sse-chat.ts
  </files>
  <action>
**Create `apps/web/src/components/chat/agent-block.tsx`:**

Per user decision: "Sub-agent activity shown inline in chat as collapsible blocks (like Claude Code's tool use output)" and "Each sub-agent block streams its response token-by-token (full streaming, not just status)" and "Collapsed sub-agent blocks always show tokens used and duration."

Component `AgentBlock`:
- Props: `agentId: string`
- Reads agent state from `useAgentStore`
- Collapsible via a button (default: expanded while running, collapsed when completed)
- Header: agent label (e.g., "agent-1: Research quantum computing..."), status indicator (spinner for running, checkmark for completed, X for failed)
- Body: streamed text content (markdown rendered if possible, plain text otherwise)
- Footer (always visible, even collapsed): tokens used + duration (e.g., "2,450 tokens | 3.2s")
- Styling: border-l-2 with accent color, slight indent, muted background. Similar to a Details/Summary HTML pattern.
- Colors: border-blue-500 while running, border-green-500 when completed, border-red-500 when failed

**Create `apps/web/src/components/chat/agent-tree-panel.tsx`:**

Per user decision: "Web: agent tree panel (like a process manager) with per-agent stop buttons, always togglable via a button."

Component `AgentTreePanel`:
- Props: none (reads from agent store)
- Togglable panel (button in chat header to show/hide)
- Shows a tree view of all agents with:
  - Agent ID/label
  - Task description (truncated)
  - Status badge (running/completed/failed/cancelled)
  - Tokens used
  - Duration
  - Stop button (red) for running agents -- calls `cancelAgent(agentId)`
- Tree structure uses depth-based indentation (pl-4 per level)
- Empty state when no agents
- Scrollable if many agents

**Create `apps/web/src/components/chat/budget-indicator.tsx`:**

Component `BudgetIndicator`:
- Props: none (reads from agent store)
- Only visible when there are active agents (budget is being tracked)
- Shows a progress bar: green < 50%, yellow 50-80%, red > 80%
- Text: "12,450 / 500,000 tokens (~$0.04)"
- When budgetWarning: show alert with "Continue?" / "Stop" buttons
  - "Continue" calls budgetContinue
  - "Stop" calls budgetStop
- When budgetExhausted: show red alert with token count

**Create `apps/web/src/components/chat/ws-status.tsx`:**

Per user decision: "WebSocket connection status indicator visible in web UI (Connected / Reconnecting)."

Component `WsStatus`:
- Props: `status: WsConnectionStatus`
- Renders a small indicator (dot + text):
  - Connected: green dot, "Connected" text (or just green dot, minimal)
  - Reconnecting: yellow dot, "Reconnecting..." with subtle pulse animation
  - Disconnected: red dot, "Disconnected"
- Positioned in the chat header area (small, non-intrusive)

**Update `apps/web/src/components/chat/message-list.tsx`:**

Modify the message rendering to include AgentBlock components when a message has sub-agent activity:
- After an assistant message that triggered spawning, render AgentBlock components for each agent in the store
- The blocks appear between the "I'll break this down..." pre-spawn message and the synthesis response
- Check if agent store has agents for the current request/session and render them

**Update `apps/web/src/hooks/use-sse-chat.ts`:**

Extend the SSE parser to handle new agent event types from the chat endpoint:
- `agent_spawned`: forward to agent store via `useAgentStore.getState().handleEvent()`
- `agent_text_delta`: forward to agent store
- `agent_completed`: forward to agent store
- `agent_failed`: forward to agent store
- `agent_cancelled`: forward to agent store
- `budget_update`: forward to agent store
- `budget_warning`: forward to agent store
- `budget_exhausted`: forward to agent store
- `synthesis_started`: reset streamed content for synthesis phase
- Existing events (session, text_delta, usage, done, error) continue to work as before

Add `resetAgents` to the cleanup flow: when a new message is sent, reset the agent store.
  </action>
  <verify>Run `cd /Users/smxaz7/Desktop/Suman/Projects/gh/boternity/apps/web && pnpm tsc --noEmit` -- TypeScript compiles. Run `pnpm build` -- Vite builds without errors.</verify>
  <done>All web UI components for agent hierarchy are complete. AgentBlock renders inline collapsible sub-agent blocks with streaming text. AgentTreePanel provides process-manager view. BudgetIndicator shows usage with pause prompt. WsStatus shows connection state. SSE hook processes all agent events.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes in apps/web
- `pnpm build` succeeds in apps/web
- All new components exist and are importable
- Agent store processes all AgentEvent types
- WebSocket hook connects with exponential backoff
- AgentBlock is collapsible with token/duration footer
- AgentTreePanel has stop buttons for running agents
- BudgetIndicator shows Continue/Stop buttons on warning
- WsStatus shows three connection states
- SSE hook handles new agent event types
</verification>

<success_criteria>
The complete web UI for agent hierarchy is built. Users see sub-agent blocks inline in chat (collapsible, streaming, with metadata). The tree panel provides a process-manager view with cancel buttons. Budget indicator tracks usage. WebSocket status is visible. All backed by the agent Zustand store processing real-time events.
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-hierarchy-event-system/05-08-SUMMARY.md`
</output>
