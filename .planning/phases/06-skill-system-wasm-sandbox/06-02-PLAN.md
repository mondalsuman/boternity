---
phase: 06-skill-system-wasm-sandbox
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - crates/boternity-core/src/skill/mod.rs
  - crates/boternity-core/src/skill/manifest.rs
  - crates/boternity-core/src/lib.rs
  - crates/boternity-infra/src/skill/mod.rs
  - crates/boternity-infra/src/skill/skill_store.rs
  - crates/boternity-infra/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "SKILL.md files with YAML frontmatter + markdown body can be parsed into SkillManifest"
    - "Skills can be stored in and loaded from ~/.boternity/skills/ on disk"
    - "Per-bot skill configuration (skills.toml) can be parsed and written"
    - ".boternity-meta.toml files track registry source and checksum for installed skills"
  artifacts:
    - path: "crates/boternity-core/src/skill/manifest.rs"
      provides: "SKILL.md parsing and validation"
      contains: "parse_skill_md"
    - path: "crates/boternity-infra/src/skill/skill_store.rs"
      provides: "Filesystem-based skill storage"
      contains: "SkillStore"
  key_links:
    - from: "crates/boternity-core/src/skill/manifest.rs"
      to: "boternity_types::skill::SkillManifest"
      via: "serde_yaml_ng deserialization"
      pattern: "serde_yaml_ng::from_str"
    - from: "crates/boternity-infra/src/skill/skill_store.rs"
      to: "crates/boternity-core/src/skill/manifest.rs"
      via: "parse_skill_md for loading"
      pattern: "parse_skill_md"
---

<objective>
Implement SKILL.md manifest parsing and filesystem-based skill storage.

Purpose: Before skills can be executed, discovered, or managed, we need to parse their manifest format and store/load them from disk. This plan covers the two foundational infrastructure pieces: the agentskills.io-compatible manifest parser and the skill store at `~/.boternity/skills/`.

Output: Manifest parser in boternity-core, skill store in boternity-infra, per-bot skills.toml support.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-skill-system-wasm-sandbox/06-CONTEXT.md
@.planning/phases/06-skill-system-wasm-sandbox/06-RESEARCH.md
@crates/boternity-types/src/skill.rs
@crates/boternity-core/src/lib.rs
@crates/boternity-infra/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: SKILL.md manifest parser in boternity-core</name>
  <files>crates/boternity-core/src/skill/mod.rs, crates/boternity-core/src/skill/manifest.rs, crates/boternity-core/src/lib.rs</files>
  <action>
Create `crates/boternity-core/src/skill/` module:

**mod.rs:** Re-export submodules. Start with `pub mod manifest;`

**manifest.rs:**
1. `extract_frontmatter(content: &str) -> anyhow::Result<(&str, &str)>` -- splits SKILL.md into YAML frontmatter and markdown body. Content must start with `---`, find closing `\n---`, return (yaml_str, body_str). See research Pattern 3 for the extraction logic.

2. `parse_skill_md(content: &str) -> anyhow::Result<(SkillManifest, String)>` -- calls extract_frontmatter, deserializes YAML via `serde_yaml_ng::from_str`, returns (manifest, body).

3. `validate_manifest(manifest: &SkillManifest) -> anyhow::Result<()>` -- validates:
   - name is non-empty and matches slug pattern (lowercase alphanumeric + hyphens)
   - description is non-empty
   - If metadata.version is Some, it parses as valid semver
   - If metadata.skill_type is Some(Tool), metadata.capabilities should be Some (warn if empty)
   - If metadata.parents is Some, depth <= 3 (warn if more)
   - If metadata.conflicts_with is Some, no self-conflict

4. `parse_bot_skills_config(content: &str) -> anyhow::Result<BotSkillsFile>` -- deserializes per-bot skills.toml using `toml::from_str`.

5. `serialize_bot_skills_config(config: &BotSkillsFile) -> anyhow::Result<String>` -- serializes to TOML string.

Add unit tests:
- Parse a valid SKILL.md with all fields
- Parse a minimal SKILL.md (name + description only)
- Reject SKILL.md without frontmatter
- Validate manifest with invalid name (spaces, uppercase)
- Parse and round-trip a BotSkillsFile

Add `pub mod skill;` to `crates/boternity-core/src/lib.rs`.
  </action>
  <verify>Run `cargo test -p boternity-core -- skill::manifest` -- all tests pass.</verify>
  <done>SKILL.md can be parsed into SkillManifest with frontmatter extraction, YAML deserialization, and validation. Per-bot skills.toml can be parsed and serialized.</done>
</task>

<task type="auto">
  <name>Task 2: Filesystem-based skill store in boternity-infra</name>
  <files>crates/boternity-infra/src/skill/mod.rs, crates/boternity-infra/src/skill/skill_store.rs, crates/boternity-infra/src/lib.rs</files>
  <action>
Create `crates/boternity-infra/src/skill/` module:

**mod.rs:** Re-export submodules. Start with `pub mod skill_store;`

**skill_store.rs:**
Implement `SkillStore` struct that manages skills on disk at `~/.boternity/skills/`.

Storage layout per research:
```
~/.boternity/skills/{skill-name}/
  SKILL.md
  .boternity-meta.toml  (for registry skills)
  skill.wasm            (for tool-based WASM skills)
  scripts/
  references/
  assets/
```

Methods:
1. `new(base_dir: PathBuf) -> Self` -- base_dir is `~/.boternity/skills/`
2. `list_skills() -> anyhow::Result<Vec<InstalledSkill>>` -- scan all subdirectories, parse SKILL.md from each, load .boternity-meta.toml if present
3. `get_skill(name: &str) -> anyhow::Result<InstalledSkill>` -- load a specific skill by name
4. `install_skill(name: &str, content: &str, meta: Option<SkillMeta>, wasm_bytes: Option<&[u8]>) -> anyhow::Result<PathBuf>` -- create directory, write SKILL.md, optionally write .boternity-meta.toml and skill.wasm
5. `remove_skill(name: &str) -> anyhow::Result<()>` -- remove skill directory
6. `skill_exists(name: &str) -> bool` -- check if skill directory exists
7. `get_bot_skills_config(bot_dir: &Path) -> anyhow::Result<BotSkillsFile>` -- read {bot_dir}/skills.toml, return empty BotSkillsFile if not found
8. `save_bot_skills_config(bot_dir: &Path, config: &BotSkillsFile) -> anyhow::Result<()>` -- write skills.toml
9. `resolve_skill_path(name: &str) -> PathBuf` -- returns path to skill directory

Use `boternity_core::skill::manifest::{parse_skill_md, parse_bot_skills_config, serialize_bot_skills_config}` for parsing.

For .boternity-meta.toml, serialize/deserialize SkillMeta using `toml`.

Auto-create parent directories on install (same pattern as LocalFileSystem).

Add `pub mod skill;` to `crates/boternity-infra/src/lib.rs`.

Add unit tests using tempdir:
- Install and list skills round-trip
- Get nonexistent skill returns error
- Remove skill deletes directory
- Bot skills config read/write round-trip
  </action>
  <verify>Run `cargo test -p boternity-infra -- skill::skill_store` -- all tests pass.</verify>
  <done>Skills can be installed to, loaded from, and removed from the filesystem skill store. Per-bot skill configuration is readable and writable.</done>
</task>

</tasks>

<verification>
- `cargo test -p boternity-core -- skill::manifest` passes
- `cargo test -p boternity-infra -- skill::skill_store` passes
- `cargo check --workspace` passes
</verification>

<success_criteria>
SKILL.md files with YAML frontmatter can be parsed into typed SkillManifest structs. Skills can be stored/loaded/removed from `~/.boternity/skills/`. Per-bot skills.toml configuration works.
</success_criteria>

<output>
After completion, create `.planning/phases/06-skill-system-wasm-sandbox/06-02-SUMMARY.md`
</output>
