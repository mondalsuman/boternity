---
phase: 06-skill-system-wasm-sandbox
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - crates/boternity-core/src/skill/permission.rs
  - crates/boternity-core/src/skill/mod.rs
  - crates/boternity-infra/src/skill/audit.rs
  - crates/boternity-infra/src/skill/mod.rs
  - crates/boternity-infra/src/sqlite/skill_audit.rs
  - crates/boternity-infra/src/sqlite/mod.rs
autonomous: true

must_haves:
  truths:
    - "Capability checks validate whether a skill has permission for a specific operation"
    - "Permission violations terminate execution immediately"
    - "Every skill invocation is logged to the audit trail with capabilities used, duration, and success/failure"
    - "Granular revocation of individual capabilities is supported"
  artifacts:
    - path: "crates/boternity-core/src/skill/permission.rs"
      provides: "Permission checking and capability enforcement"
      contains: "CapabilityEnforcer"
    - path: "crates/boternity-infra/src/sqlite/skill_audit.rs"
      provides: "SQLite-backed audit log for skill invocations"
      contains: "SqliteSkillAuditLog"
  key_links:
    - from: "crates/boternity-core/src/skill/permission.rs"
      to: "boternity_types::skill::PermissionGrant"
      via: "permission check against grants"
      pattern: "PermissionGrant"
    - from: "crates/boternity-infra/src/sqlite/skill_audit.rs"
      to: "boternity_types::skill::SkillAuditEntry"
      via: "INSERT into skill_audit_log"
      pattern: "skill_audit_log"
---

<objective>
Implement the permission model and audit logging for skill execution.

Purpose: Before any skill executes, its capabilities must be checked against the user's permission grants. Every invocation must be logged for security auditing. This plan establishes the security foundation that all executors (local and WASM) depend on.

Output: CapabilityEnforcer in boternity-core, SqliteSkillAuditLog in boternity-infra with migration.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-skill-system-wasm-sandbox/06-CONTEXT.md
@.planning/phases/06-skill-system-wasm-sandbox/06-RESEARCH.md
@crates/boternity-types/src/skill.rs
@crates/boternity-infra/src/sqlite/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Permission checker and capability enforcer</name>
  <files>crates/boternity-core/src/skill/permission.rs, crates/boternity-core/src/skill/mod.rs</files>
  <action>
Create `crates/boternity-core/src/skill/permission.rs`:

**CapabilityEnforcer struct:**
- Holds a `HashSet<Capability>` of granted capabilities for a specific skill invocation
- `new(grants: &[PermissionGrant]) -> Self` -- filters to only granted=true, extracts capabilities into HashSet
- `check(&self, capability: &Capability) -> Result<(), PermissionError>` -- returns Ok if capability is in the set, Err(PermissionError::Denied { capability, skill_name }) if not. Per user decision: "Permission violations terminate skill execution immediately (strict enforcement)"
- `check_all(&self, capabilities: &[Capability]) -> Result<(), PermissionError>` -- checks all, returns first failure
- `granted_capabilities(&self) -> &HashSet<Capability>` -- returns reference to granted set
- `has_capability(&self, capability: &Capability) -> bool` -- convenience boolean check

**PermissionError enum** (thiserror):
- `Denied { capability: Capability, skill_name: String }` -- "Skill '{skill_name}' denied capability: {capability}"
- `NoGrants { skill_name: String }` -- "No permission grants found for skill '{skill_name}'"

**Permission management functions:**
- `create_grants_from_manifest(manifest: &SkillManifest, approved: bool) -> Vec<PermissionGrant>` -- for each capability in manifest.metadata.capabilities, create a PermissionGrant with granted=approved
- `revoke_capability(grants: &mut Vec<PermissionGrant>, capability: &Capability)` -- sets granted=false for matching capability
- `grant_capability(grants: &mut Vec<PermissionGrant>, capability: &Capability)` -- sets granted=true, adds new grant if not present
- `merge_inherited_grants(child_grants: &[PermissionGrant], parent_grants: &[PermissionGrant]) -> Vec<PermissionGrant>` -- combines capabilities from child and parent manifests (per user decision: "Child inherits parent's capability permissions -- combined set approved at install")

Add `pub mod permission;` to skill/mod.rs.

Unit tests:
- Enforcer allows granted capability
- Enforcer denies non-granted capability
- Revoke then check returns denied
- Merge inherited grants combines both sets
- Empty grants returns NoGrants error
  </action>
  <verify>Run `cargo test -p boternity-core -- skill::permission` -- all tests pass.</verify>
  <done>Capability enforcement validates permissions before skill execution. Granular revocation and inheritance merging work.</done>
</task>

<task type="auto">
  <name>Task 2: SQLite audit log for skill invocations</name>
  <files>crates/boternity-infra/src/sqlite/skill_audit.rs, crates/boternity-infra/src/sqlite/mod.rs, crates/boternity-infra/src/skill/audit.rs, crates/boternity-infra/src/skill/mod.rs</files>
  <action>
**SQLite migration** -- add to existing migration system (check how other migrations are structured in `crates/boternity-infra/src/sqlite/`):

```sql
CREATE TABLE IF NOT EXISTS skill_audit_log (
    invocation_id TEXT PRIMARY KEY,
    skill_name TEXT NOT NULL,
    skill_version TEXT NOT NULL,
    trust_tier TEXT NOT NULL,
    capabilities_used TEXT NOT NULL, -- JSON array of capability strings
    input_hash TEXT NOT NULL,
    output_hash TEXT NOT NULL,
    fuel_consumed INTEGER,
    memory_peak_bytes INTEGER,
    duration_ms INTEGER NOT NULL,
    success INTEGER NOT NULL, -- 0/1 boolean
    error TEXT,
    timestamp TEXT NOT NULL,
    bot_id TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_skill_audit_bot ON skill_audit_log(bot_id);
CREATE INDEX IF NOT EXISTS idx_skill_audit_skill ON skill_audit_log(skill_name);
CREATE INDEX IF NOT EXISTS idx_skill_audit_timestamp ON skill_audit_log(timestamp);
```

**crates/boternity-infra/src/sqlite/skill_audit.rs:**
- `SqliteSkillAuditLog` struct holding `DatabasePool`
- `new(pool: DatabasePool) -> Self`
- `log_invocation(&self, entry: &SkillAuditEntry) -> anyhow::Result<()>` -- INSERT into skill_audit_log, serialize capabilities_used as JSON array string
- `get_invocations_for_skill(&self, skill_name: &str, limit: usize) -> anyhow::Result<Vec<SkillAuditEntry>>` -- SELECT with ORDER BY timestamp DESC
- `get_invocations_for_bot(&self, bot_id: &Uuid, limit: usize) -> anyhow::Result<Vec<SkillAuditEntry>>` -- SELECT by bot_id
- `count_invocations(&self, skill_name: &str) -> anyhow::Result<u64>` -- COUNT for a skill

Add `pub mod skill_audit;` to `crates/boternity-infra/src/sqlite/mod.rs`.

**crates/boternity-infra/src/skill/audit.rs:**
- Re-export or thin wrapper over SqliteSkillAuditLog if needed for skill module organization
- Add `pub mod audit;` to `crates/boternity-infra/src/skill/mod.rs`

Unit tests:
- Log an invocation and retrieve it
- Query by bot_id returns correct entries
- Count returns correct number
  </action>
  <verify>Run `cargo test -p boternity-infra -- sqlite::skill_audit` -- all tests pass. Run `cargo test -p boternity-infra -- skill::audit` if additional tests exist.</verify>
  <done>Every skill invocation can be logged to SQLite with full context. Audit entries are queryable by skill name, bot ID, and timestamp.</done>
</task>

</tasks>

<verification>
- `cargo test -p boternity-core -- skill::permission` passes
- `cargo test -p boternity-infra -- sqlite::skill_audit` passes
- `cargo check --workspace` passes
- Permission denial returns structured error with skill name and capability
</verification>

<success_criteria>
CapabilityEnforcer validates skill permissions before execution. Permission violations produce clear errors. Audit log records every invocation with capabilities, timing, and success/failure. Granular revocation works.
</success_criteria>

<output>
After completion, create `.planning/phases/06-skill-system-wasm-sandbox/06-03-SUMMARY.md`
</output>
