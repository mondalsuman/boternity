---
phase: 06-skill-system-wasm-sandbox
plan: 06
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - crates/boternity-core/src/skill/executor.rs
  - crates/boternity-core/src/skill/prompt_injector.rs
  - crates/boternity-core/src/skill/mod.rs
  - crates/boternity-infra/src/skill/local_executor.rs
  - crates/boternity-infra/src/skill/mod.rs
autonomous: true

must_haves:
  truths:
    - "Prompt-based skills inject their content into the system prompt using XML tags"
    - "Local tool-based skills execute via process spawning with capability enforcement"
    - "Progressive disclosure loads only metadata at first, full body on activation"
    - "Skill execution respects permission grants and logs to audit trail"
  artifacts:
    - path: "crates/boternity-core/src/skill/executor.rs"
      provides: "SkillExecutor trait for skill execution"
      contains: "SkillExecutor"
    - path: "crates/boternity-core/src/skill/prompt_injector.rs"
      provides: "System prompt injection for prompt-based skills"
      contains: "inject_active_skill_prompts"
    - path: "crates/boternity-infra/src/skill/local_executor.rs"
      provides: "Local skill execution via process spawning"
      contains: "LocalSkillExecutor"
  key_links:
    - from: "crates/boternity-core/src/skill/prompt_injector.rs"
      to: "crates/boternity-core/src/agent/prompt.rs"
      via: "inserts <skills> section after </identity>"
      pattern: "</identity>"
    - from: "crates/boternity-infra/src/skill/local_executor.rs"
      to: "crates/boternity-core/src/skill/permission.rs"
      via: "CapabilityEnforcer check before execution"
      pattern: "CapabilityEnforcer"
---

<objective>
Implement local skill execution for both prompt-based and tool-based skills.

Purpose: Local skills are the first execution path -- they run with full trust on the host. Prompt-based skills inject into the system prompt. Tool-based local skills execute via process spawning (shell access per user decision). This plan also defines the SkillExecutor trait that WASM execution will implement in Plan 07.

Output: SkillExecutor trait, prompt injector (progressive disclosure), and LocalSkillExecutor.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-skill-system-wasm-sandbox/06-CONTEXT.md
@.planning/phases/06-skill-system-wasm-sandbox/06-RESEARCH.md
@crates/boternity-types/src/skill.rs
@crates/boternity-core/src/skill/mod.rs
@crates/boternity-core/src/skill/permission.rs
@crates/boternity-core/src/agent/prompt.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: SkillExecutor trait and prompt injector</name>
  <files>crates/boternity-core/src/skill/executor.rs, crates/boternity-core/src/skill/prompt_injector.rs, crates/boternity-core/src/skill/mod.rs</files>
  <action>
**executor.rs -- SkillExecutor trait:**

```rust
/// Result of executing a tool-based skill
pub struct SkillExecutionResult {
    pub output: String,           // JSON output from tool skill
    pub fuel_consumed: Option<u64>,
    pub memory_peak_bytes: Option<usize>,
    pub duration: std::time::Duration,
}

/// Trait for executing tool-based skills
pub trait SkillExecutor: Send + Sync {
    /// Execute a tool-based skill with the given JSON input
    fn execute(
        &self,
        skill: &InstalledSkill,
        input: &str,
        enforcer: &CapabilityEnforcer,
    ) -> impl std::future::Future<Output = anyhow::Result<SkillExecutionResult>> + Send;
}
```

Note: Uses RPITIT (async fn in traits without dyn dispatch) per project convention from Phase 1 decisions.

**prompt_injector.rs -- Prompt-based skill integration:**

Follows research Pattern 4 (progressive disclosure):

1. `generate_skill_metadata_xml(skills: &[(SkillManifest, PathBuf)]) -> String`
   - Level 1: Only name + description + location per skill (~50-100 tokens each)
   - Wraps in `<available_skills>...<skill>...</skill>...</available_skills>` XML
   - Per research anti-pattern: "Loading full skill content at startup" -- only metadata here

2. `inject_active_skill_prompts(base_prompt: &str, active_skills: &[(SkillManifest, String)]) -> String`
   - Level 2: Full skill body for activated skills only
   - Wraps each in `<skill name="...">body</skill>` inside `<skills>...</skills>` block
   - Inserts AFTER `</identity>` tag in the system prompt (per existing XML tag structure)
   - If `</identity>` not found, prepend to prompt
   - Returns empty prompt unchanged if no active skills

3. `build_skill_enhanced_prompt(base_prompt: &str, all_skills: &[(SkillManifest, PathBuf)], active_skill_bodies: &[(SkillManifest, String)]) -> String`
   - Convenience: adds both metadata XML (for all skills) and active skill prompts
   - Calls generate_skill_metadata_xml + inject_active_skill_prompts

Add `pub mod executor;` and `pub mod prompt_injector;` to skill/mod.rs.

Unit tests for prompt_injector:
- generate_skill_metadata_xml produces valid XML with name and description
- inject_active_skill_prompts inserts after </identity>
- inject_active_skill_prompts with no skills returns base prompt unchanged
- build_skill_enhanced_prompt combines both levels
- Verify token budget: 10 skills metadata < 1000 tokens (estimate at 4 chars/token)
  </action>
  <verify>Run `cargo test -p boternity-core -- skill::prompt_injector` and `cargo test -p boternity-core -- skill::executor` -- all tests pass.</verify>
  <done>SkillExecutor trait is defined. Prompt injection uses progressive disclosure with XML tags. Active skills insert after </identity>.</done>
</task>

<task type="auto">
  <name>Task 2: Local skill executor</name>
  <files>crates/boternity-infra/src/skill/local_executor.rs, crates/boternity-infra/src/skill/mod.rs</files>
  <action>
Create `crates/boternity-infra/src/skill/local_executor.rs`:

**LocalSkillExecutor** implements SkillExecutor for local (full trust) tool-based skills.

Per user decision: "Three trust tiers: local (full trust, shell access)" -- local skills can spawn processes.

```rust
pub struct LocalSkillExecutor;

impl LocalSkillExecutor {
    pub fn new() -> Self { Self }
}
```

Implement SkillExecutor trait:
- `execute(&self, skill, input, enforcer) -> Result<SkillExecutionResult>`:
  1. Check that skill source is Local (error if not)
  2. Check enforcer.check(&Capability::ExecCommand) for process spawning
  3. Look for an executable script in the skill directory:
     - Check `{skill.install_path}/scripts/run.sh` (Unix)
     - Check `{skill.install_path}/scripts/run.py` (Python)
     - If skill has wasm_path, error -- WASM skills use WasmSkillExecutor
  4. Execute the script via `tokio::process::Command::new("sh").arg("-c").arg(script_path)`:
     - Pass input as stdin
     - Set working directory to skill install path
     - Capture stdout as output
     - Capture stderr for error reporting
     - Set timeout based on ResourceLimits::default for Local tier (60s)
  5. Parse stdout as the skill output (tool-based skills return JSON)
  6. Record timing in SkillExecutionResult
  7. On process failure, return error with stderr content

Also add:
- `check_tool_skill_requirements(skill: &InstalledSkill) -> anyhow::Result<()>` -- validates that a local tool skill has the required scripts directory and run script

Add `pub mod local_executor;` to `crates/boternity-infra/src/skill/mod.rs`.

Unit tests:
- Executor rejects non-local skills
- Executor checks exec-command capability
- check_tool_skill_requirements validates script existence (using tempdir)
  </action>
  <verify>Run `cargo test -p boternity-infra -- skill::local_executor` -- all tests pass.</verify>
  <done>Local tool-based skills execute via process spawning with capability enforcement. Scripts are found in the skill's scripts/ directory.</done>
</task>

</tasks>

<verification>
- `cargo test -p boternity-core -- skill::prompt_injector` passes
- `cargo test -p boternity-core -- skill::executor` passes
- `cargo test -p boternity-infra -- skill::local_executor` passes
- `cargo check --workspace` passes
</verification>

<success_criteria>
Prompt-based skills inject into system prompt with progressive disclosure (metadata XML + active skill body). Local tool-based skills execute via process spawning. SkillExecutor trait is ready for WASM implementation.
</success_criteria>

<output>
After completion, create `.planning/phases/06-skill-system-wasm-sandbox/06-06-SUMMARY.md`
</output>
