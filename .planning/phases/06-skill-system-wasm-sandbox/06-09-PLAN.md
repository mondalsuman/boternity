---
phase: 06-skill-system-wasm-sandbox
plan: 09
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - crates/boternity-infra/src/skill/registry_client.rs
  - crates/boternity-infra/src/skill/mod.rs
  - crates/boternity-core/src/skill/registry.rs
  - crates/boternity-core/src/skill/mod.rs
autonomous: true

must_haves:
  truths:
    - "Skills can be discovered from GitHub repositories (owner/repo format)"
    - "skills.sh API is used for popularity data and search"
    - "ComposioHQ/awesome-claude-skills repo can be indexed for community skills"
    - "Discovered skills are cached locally for offline browsing"
    - "Custom registry endpoints can be added by users"
  artifacts:
    - path: "crates/boternity-core/src/skill/registry.rs"
      provides: "SkillRegistry trait for pluggable registries"
      contains: "SkillRegistry"
    - path: "crates/boternity-infra/src/skill/registry_client.rs"
      provides: "GitHub-based skill discovery and installation"
      contains: "GitHubRegistryClient"
  key_links:
    - from: "crates/boternity-infra/src/skill/registry_client.rs"
      to: "api.github.com"
      via: "GitHub Trees API for repo scanning"
      pattern: "api.github.com.*git/trees"
    - from: "crates/boternity-infra/src/skill/registry_client.rs"
      to: "crates/boternity-infra/src/skill/skill_store.rs"
      via: "install_skill for saving discovered skills"
      pattern: "install_skill"
---

<objective>
Implement registry discovery and skill installation from GitHub repositories.

Purpose: Users discover and install skills from pluggable registries. The primary mechanism is GitHub-based (owner/repo format), supplemented by skills.sh for popularity/search data and ComposioHQ for community skills. This plan implements the registry trait and GitHub client that powers `bnity skill install` and the TUI browser.

Output: SkillRegistry trait in boternity-core, GitHubRegistryClient in boternity-infra with discovery, search, and installation.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-skill-system-wasm-sandbox/06-CONTEXT.md
@.planning/phases/06-skill-system-wasm-sandbox/06-RESEARCH.md
@crates/boternity-types/src/skill.rs
@crates/boternity-core/src/skill/manifest.rs
@crates/boternity-infra/src/skill/skill_store.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: SkillRegistry trait and discovery types</name>
  <files>crates/boternity-core/src/skill/registry.rs, crates/boternity-core/src/skill/mod.rs</files>
  <action>
Create `crates/boternity-core/src/skill/registry.rs`:

**Discovery types:**
```rust
/// A skill discovered from a registry (not yet installed)
pub struct DiscoveredSkill {
    pub name: String,
    pub description: String,
    pub source: String,            // "owner/repo" or registry name
    pub path: String,              // path within repo to SKILL.md
    pub manifest: SkillManifest,
    pub install_count: Option<u64>,  // from skills.sh popularity data
    pub categories: Vec<String>,
}

/// Registry configuration
pub struct RegistryConfig {
    pub name: String,
    pub registry_type: RegistryType,
    pub enabled: bool,
}

pub enum RegistryType {
    /// GitHub repository (owner/repo format)
    GitHub { owner: String, repo: String },
    /// skills.sh leaderboard API
    SkillsSh,
    /// Custom .well-known/skills.json endpoint
    Custom { url: String },
}
```

**SkillRegistry trait (RPITIT per project convention):**
```rust
pub trait SkillRegistry: Send + Sync {
    /// Search for skills by keyword
    fn search(
        &self,
        query: &str,
        limit: usize,
    ) -> impl std::future::Future<Output = anyhow::Result<Vec<DiscoveredSkill>>> + Send;

    /// List all skills (paginated)
    fn list(
        &self,
        offset: usize,
        limit: usize,
    ) -> impl std::future::Future<Output = anyhow::Result<Vec<DiscoveredSkill>>> + Send;

    /// Fetch full skill content (SKILL.md + optional WASM) for installation
    fn fetch_skill(
        &self,
        skill: &DiscoveredSkill,
    ) -> impl std::future::Future<Output = anyhow::Result<(String, Option<Vec<u8>>)>> + Send;
    // Returns (skill_md_content, optional_wasm_bytes)

    /// Get the registry name
    fn name(&self) -> &str;
}
```

**Cache types:**
```rust
/// Cached skill index for offline browsing
pub struct SkillIndex {
    pub skills: Vec<DiscoveredSkill>,
    pub last_updated: chrono::DateTime<chrono::Utc>,
    pub source: String,
}
```

Add `pub mod registry;` to skill/mod.rs.
  </action>
  <verify>`cargo check -p boternity-core` passes.</verify>
  <done>SkillRegistry trait is defined with search, list, and fetch operations. Discovery types capture all metadata needed for the TUI browser.</done>
</task>

<task type="auto">
  <name>Task 2: GitHub-based registry client implementation</name>
  <files>crates/boternity-infra/src/skill/registry_client.rs, crates/boternity-infra/src/skill/mod.rs</files>
  <action>
Create `crates/boternity-infra/src/skill/registry_client.rs`:

**GitHubRegistryClient** implements SkillRegistry:
```rust
pub struct GitHubRegistryClient {
    client: reqwest::Client,
    owner: String,
    repo: String,
    github_token: Option<String>,
    cache_dir: PathBuf,  // ~/.boternity/cache/
}
```

Methods:
1. `new(owner: String, repo: String, github_token: Option<String>, cache_dir: PathBuf) -> Self`
   - Create reqwest::Client with User-Agent "boternity"

2. Implement `SkillRegistry::search`:
   - Load cached index if fresh (< 24 hours old)
   - If stale, fetch from GitHub API
   - Filter by case-insensitive substring match on name + description
   - Return up to limit results

3. Implement `SkillRegistry::list`:
   - Load cached index
   - Return paginated slice

4. Implement `SkillRegistry::fetch_skill`:
   - Fetch raw SKILL.md content from `https://raw.githubusercontent.com/{owner}/{repo}/HEAD/{path}`
   - If skill directory contains *.wasm file, fetch that too
   - Return (content, wasm_bytes)

5. `refresh_index(&self) -> anyhow::Result<SkillIndex>`:
   - Call GitHub Trees API: `GET /repos/{owner}/{repo}/git/trees/HEAD?recursive=1` per research Deep Dive 1
   - Filter tree entries for paths ending in `/SKILL.md` or equal to `SKILL.md`
   - For each SKILL.md, fetch content from raw.githubusercontent.com
   - Parse frontmatter to extract name + description
   - Build SkillIndex and cache to `{cache_dir}/{owner}-{repo}-index.json`

**SkillsShClient** (supplementary, for popularity data):
```rust
pub struct SkillsShClient {
    client: reqwest::Client,
    cache_dir: PathBuf,
}
```
- `search(query: &str) -> anyhow::Result<Vec<SkillsShEntry>>` -- POST to `skills.sh/api/skills/search`
- `list_popular() -> anyhow::Result<Vec<SkillsShEntry>>` -- GET `skills.sh/api/skills`
- `SkillsShEntry` struct: name, description, source_repo, install_count

**Default registry configurations:**
```rust
pub fn default_registries(cache_dir: PathBuf, github_token: Option<String>) -> Vec<Box<dyn SkillRegistry>> {
    // Note: uses Box<dyn> here since we need heterogeneous collection
    // The trait itself uses RPITIT but we box for the collection
}
```

Wait -- SkillRegistry uses RPITIT so it is NOT object-safe. Instead, provide:
```rust
pub fn create_github_registry(owner: &str, repo: &str, cache_dir: PathBuf, github_token: Option<String>) -> GitHubRegistryClient
```

And list default registries as configs:
```rust
pub fn default_registry_configs() -> Vec<RegistryConfig> {
    vec![
        RegistryConfig {
            name: "composiohq".to_string(),
            registry_type: RegistryType::GitHub { owner: "ComposioHQ".to_string(), repo: "awesome-claude-skills".to_string() },
            enabled: true,
        },
        RegistryConfig {
            name: "anthropics".to_string(),
            registry_type: RegistryType::GitHub { owner: "anthropics".to_string(), repo: "skills".to_string() },
            enabled: true,
        },
        RegistryConfig {
            name: "skills-sh".to_string(),
            registry_type: RegistryType::SkillsSh,
            enabled: true,
        },
    ]
}
```

Add `pub mod registry_client;` to skill/mod.rs.

Unit tests:
- default_registry_configs returns 3 registries
- SkillsShEntry deserialization from sample JSON
- Cache path resolution
  </action>
  <verify>`cargo check -p boternity-infra` passes. `cargo test -p boternity-infra -- skill::registry_client` passes.</verify>
  <done>Skills can be discovered from GitHub repos, skills.sh, and ComposioHQ. Results are cached locally. Custom registries can be configured.</done>
</task>

</tasks>

<verification>
- `cargo check --workspace` passes
- `cargo test -p boternity-core -- skill::registry` passes
- `cargo test -p boternity-infra -- skill::registry_client` passes
- Default registry configs include ComposioHQ, anthropics, and skills.sh
</verification>

<success_criteria>
Pluggable registry system discovers skills from GitHub repos and skills.sh. Results are cached for offline use. Custom registry endpoints are configurable. Discovery returns name, description, source, categories, and install counts.
</success_criteria>

<output>
After completion, create `.planning/phases/06-skill-system-wasm-sandbox/06-09-SUMMARY.md`
</output>
