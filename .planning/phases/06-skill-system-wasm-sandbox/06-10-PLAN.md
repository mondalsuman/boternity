---
phase: 06-skill-system-wasm-sandbox
plan: 10
type: execute
wave: 4
depends_on: ["06-06", "06-07", "06-04"]
files_modified:
  - crates/boternity-core/src/agent/prompt.rs
  - crates/boternity-core/src/skill/chaining.rs
  - crates/boternity-core/src/skill/mod.rs
  - crates/boternity-api/src/state.rs
autonomous: true

must_haves:
  truths:
    - "SystemPromptBuilder includes skill sections (available_skills metadata + active skill prompts)"
    - "Agent engine can invoke tool-based skills during conversation"
    - "Skill chaining passes output of one skill as input to the next"
    - "AppState includes skill-related services (SkillStore, WasmRuntime, SkillAuditLog)"
  artifacts:
    - path: "crates/boternity-core/src/agent/prompt.rs"
      provides: "Updated SystemPromptBuilder with skill sections"
      contains: "available_skills"
    - path: "crates/boternity-core/src/skill/chaining.rs"
      provides: "Skill chaining orchestration"
      contains: "chain_skills"
    - path: "crates/boternity-api/src/state.rs"
      provides: "AppState with skill services"
      contains: "SkillStore"
  key_links:
    - from: "crates/boternity-core/src/agent/prompt.rs"
      to: "crates/boternity-core/src/skill/prompt_injector.rs"
      via: "calls build_skill_enhanced_prompt"
      pattern: "build_skill_enhanced_prompt"
    - from: "crates/boternity-api/src/state.rs"
      to: "crates/boternity-infra/src/skill/wasm_runtime.rs"
      via: "Arc<WasmRuntime> on AppState"
      pattern: "WasmRuntime"
---

<objective>
Wire skill execution into the agent engine and AppState.

Purpose: Skills need to be integrated into the existing agent flow: prompt-based skills appear in the system prompt, tool-based skills can be invoked by the agent, and the AppState holds all skill infrastructure. This plan connects the skill system to the existing agent architecture.

Output: Updated SystemPromptBuilder, skill chaining logic, and AppState wiring with all skill services.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-skill-system-wasm-sandbox/06-CONTEXT.md
@.planning/phases/06-skill-system-wasm-sandbox/06-RESEARCH.md
@crates/boternity-core/src/agent/prompt.rs
@crates/boternity-core/src/skill/prompt_injector.rs
@crates/boternity-core/src/skill/executor.rs
@crates/boternity-api/src/state.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate skills into SystemPromptBuilder</name>
  <files>crates/boternity-core/src/agent/prompt.rs, crates/boternity-core/src/skill/chaining.rs, crates/boternity-core/src/skill/mod.rs</files>
  <action>
**Update SystemPromptBuilder::build()** in `crates/boternity-core/src/agent/prompt.rs`:

Add optional skill parameters to the build method. To avoid breaking existing callers, add a new method:

```rust
/// Build system prompt with skill integration
pub fn build_with_skills(
    config: &AgentConfig,
    soul: &str,
    identity: &str,
    user: &str,
    memories: &[MemoryEntry],
    recalled_memories: &[RankedMemory],
    all_skills: &[(SkillManifest, PathBuf)],        // All attached skills (metadata only)
    active_skills: &[(SkillManifest, String)],       // Active prompt-based skills (full body)
) -> String
```

This method:
1. Calls the existing `build()` to get the base prompt
2. Uses `prompt_injector::build_skill_enhanced_prompt()` to add skill sections
3. The `<available_skills>` metadata XML goes after `</identity>` (before `<user_context>`)
4. Active skill prompts in `<skills>` block go after `<available_skills>` and before `<user_context>`
5. Returns the enhanced prompt

Keep the existing `build()` unchanged for backward compatibility.

**Create `crates/boternity-core/src/skill/chaining.rs`:**

Per user decision: "Automatic skill chaining at runtime -- agent can invoke multiple skills in sequence, output feeding next input"

```rust
/// Execute a chain of tool-based skills, piping output to next input
pub async fn chain_skills<E: SkillExecutor>(
    executor: &E,
    skills: &[&InstalledSkill],
    initial_input: &str,
    enforcer: &CapabilityEnforcer,
) -> anyhow::Result<SkillExecutionResult>
```

Algorithm:
1. Start with initial_input
2. For each skill in the chain:
   a. Execute the skill with current input
   b. Use the output as the next skill's input
3. Return the final SkillExecutionResult (accumulate fuel + timing)
4. If any skill fails, return the error with context about which skill in the chain failed

Add `pub mod chaining;` to skill/mod.rs.

Unit tests:
- build_with_skills includes `<available_skills>` section
- build_with_skills includes `<skills>` section for active skills
- build_with_skills without skills returns same as build()
  </action>
  <verify>`cargo test -p boternity-core -- agent::prompt` passes (existing + new tests). `cargo check -p boternity-core` passes.</verify>
  <done>SystemPromptBuilder includes skill sections. Skill chaining pipes output between skills.</done>
</task>

<task type="auto">
  <name>Task 2: Wire skill services into AppState</name>
  <files>crates/boternity-api/src/state.rs</files>
  <action>
Update `crates/boternity-api/src/state.rs` to include skill infrastructure:

Add fields to AppState:
```rust
pub skill_store: Arc<SkillStore>,
pub wasm_runtime: Arc<WasmRuntime>,
pub skill_audit_log: Arc<SqliteSkillAuditLog>,
```

Add imports:
```rust
use boternity_infra::skill::skill_store::SkillStore;
use boternity_infra::skill::wasm_runtime::WasmRuntime;
use boternity_infra::sqlite::skill_audit::SqliteSkillAuditLog;
```

In AppState initialization:
1. Create SkillStore with `base_dir.join("skills")` (where base_dir is ~/.boternity/)
2. Create WasmRuntime with `WasmRuntime::new()?`
3. Create SqliteSkillAuditLog with the existing database pool

Wrap each in `Arc` for shared ownership across handlers.

Also add a helper method:
```rust
/// Get the base skills directory
pub fn skills_dir(&self) -> PathBuf {
    self.data_dir.join("skills")
}
```

Ensure the skills directory is created during AppState initialization if it doesn't exist (like other data directories).
  </action>
  <verify>`cargo check -p boternity-api` passes. AppState initializes with skill services.</verify>
  <done>AppState holds SkillStore, WasmRuntime, and SkillAuditLog. Skill infrastructure is available to CLI and HTTP handlers.</done>
</task>

</tasks>

<verification>
- `cargo check --workspace` passes
- `cargo test -p boternity-core -- agent::prompt` passes
- AppState includes skill_store, wasm_runtime, and skill_audit_log fields
- SystemPromptBuilder.build_with_skills() includes skill XML sections
</verification>

<success_criteria>
Skills are integrated into the agent's system prompt. Skill chaining is functional. AppState provides skill infrastructure to all handlers. Existing agent behavior is preserved (backward compatible build() method).
</success_criteria>

<output>
After completion, create `.planning/phases/06-skill-system-wasm-sandbox/06-10-SUMMARY.md`
</output>
