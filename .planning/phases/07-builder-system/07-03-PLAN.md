---
phase: 07-builder-system
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - crates/boternity-infra/src/builder/mod.rs
  - crates/boternity-infra/src/builder/sqlite_draft_store.rs
  - crates/boternity-infra/src/builder/sqlite_memory_store.rs
  - crates/boternity-core/src/builder/draft_store.rs
  - crates/boternity-core/src/builder/memory.rs
  - crates/boternity-core/src/builder/mod.rs
  - crates/boternity-infra/src/sqlite/mod.rs
  - crates/boternity-infra/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Builder drafts can be saved and restored (interrupted sessions resume)"
    - "Builder memory records past session choices for suggestions"
    - "Draft store uses dedicated SQLite tables, NOT bot-scoped KvStore"
    - "Schema versioning on drafts handles future deserialization changes"
  artifacts:
    - path: "crates/boternity-core/src/builder/draft_store.rs"
      provides: "BuilderDraftStore trait"
      contains: "trait BuilderDraftStore"
    - path: "crates/boternity-core/src/builder/memory.rs"
      provides: "BuilderMemoryStore trait"
      contains: "trait BuilderMemoryStore"
    - path: "crates/boternity-infra/src/builder/sqlite_draft_store.rs"
      provides: "SQLite draft persistence"
      contains: "SqliteBuilderDraftStore"
    - path: "crates/boternity-infra/src/builder/sqlite_memory_store.rs"
      provides: "SQLite memory persistence"
      contains: "SqliteBuilderMemoryStore"
  key_links:
    - from: "crates/boternity-infra/src/builder/sqlite_draft_store.rs"
      to: "crates/boternity-core/src/builder/draft_store.rs"
      via: "implements BuilderDraftStore trait"
      pattern: "impl BuilderDraftStore"
    - from: "crates/boternity-infra/src/builder/sqlite_memory_store.rs"
      to: "crates/boternity-core/src/builder/memory.rs"
      via: "implements BuilderMemoryStore trait"
      pattern: "impl BuilderMemoryStore"
---

<objective>
Create builder draft persistence and builder memory storage using dedicated SQLite tables.

Purpose: Enable auto-save of builder progress (interrupted sessions can be resumed) and builder memory (Forge suggests similar choices from past sessions). Research CORRECTION 1 established that KvStore is bot-scoped and cannot be used for pre-bot builder data.
Output: Core traits + SQLite implementations for draft storage and builder memory.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-builder-system/07-RESEARCH.md
@.planning/phases/07-builder-system/07-CONTEXT.md
@.planning/phases/07-builder-system/07-01-SUMMARY.md
@crates/boternity-types/src/builder.rs
@crates/boternity-infra/src/sqlite/pool.rs
@crates/boternity-infra/src/sqlite/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Core traits for draft store and builder memory</name>
  <files>
    crates/boternity-core/src/builder/draft_store.rs
    crates/boternity-core/src/builder/memory.rs
    crates/boternity-core/src/builder/mod.rs
  </files>
  <action>
    1. Create `crates/boternity-core/src/builder/draft_store.rs`:

    **BuilderDraftStore trait** using RPITIT:
    ```rust
    pub trait BuilderDraftStore: Send + Sync {
        fn save_draft(&self, draft: BuilderDraft) -> impl Future<Output = Result<(), RepositoryError>> + Send;
        fn load_draft(&self, session_id: &Uuid) -> impl Future<Output = Result<Option<BuilderDraft>, RepositoryError>> + Send;
        fn list_drafts(&self) -> impl Future<Output = Result<Vec<BuilderDraftSummary>, RepositoryError>> + Send;
        fn delete_draft(&self, session_id: &Uuid) -> impl Future<Output = Result<(), RepositoryError>> + Send;
    }
    ```

    **BuilderDraft** struct: `session_id: Uuid, state_json: String, schema_version: u32, created_at: DateTime<Utc>, updated_at: DateTime<Utc>`. The state_json is the serialized BuilderState. schema_version starts at 1 and enables forward-compatible deserialization per research pitfall 7.

    **BuilderDraftSummary** struct: `session_id: Uuid, initial_description: String, phase: String, updated_at: DateTime<Utc>`. Lightweight listing type.

    2. Create `crates/boternity-core/src/builder/memory.rs`:

    **BuilderMemoryStore trait** using RPITIT:
    ```rust
    pub trait BuilderMemoryStore: Send + Sync {
        fn record_session(&self, memory: BuilderMemoryEntry) -> impl Future<Output = Result<(), RepositoryError>> + Send;
        fn recall_by_category(&self, category: &PurposeCategory, limit: usize) -> impl Future<Output = Result<Vec<BuilderMemoryEntry>, RepositoryError>> + Send;
        fn recall_recent(&self, limit: usize) -> impl Future<Output = Result<Vec<BuilderMemoryEntry>, RepositoryError>> + Send;
    }
    ```

    **BuilderMemoryEntry** struct: `id: Uuid, purpose_category: String, initial_description: String, chosen_tone: Option<String>, chosen_model: Option<String>, chosen_skills: Vec<String>, bot_slug: Option<String>, created_at: DateTime<Utc>`. This powers the "Last time you made a coding bot, you chose formal tone -- same here?" feature.

    3. Update `crates/boternity-core/src/builder/mod.rs` to add `pub mod draft_store; pub mod memory;`.
  </action>
  <verify>
    `cargo check -p boternity-core` compiles.
    No tests needed for trait definitions (tested via implementations in Task 2).
  </verify>
  <done>BuilderDraftStore and BuilderMemoryStore traits exist with RPITIT. BuilderDraft, BuilderDraftSummary, BuilderMemoryEntry types defined.</done>
</task>

<task type="auto">
  <name>Task 2: SQLite implementations for draft and memory stores</name>
  <files>
    crates/boternity-infra/src/builder/mod.rs
    crates/boternity-infra/src/builder/sqlite_draft_store.rs
    crates/boternity-infra/src/builder/sqlite_memory_store.rs
    crates/boternity-infra/src/sqlite/mod.rs
    crates/boternity-infra/src/lib.rs
  </files>
  <action>
    1. Add SQLite migration for builder tables. Add to the existing migration system (check how migrations are applied in `crates/boternity-infra/src/sqlite/pool.rs`):

    ```sql
    CREATE TABLE IF NOT EXISTS builder_drafts (
        session_id TEXT PRIMARY KEY,
        state_json TEXT NOT NULL,
        schema_version INTEGER NOT NULL DEFAULT 1,
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL
    );

    CREATE TABLE IF NOT EXISTS builder_memory (
        id TEXT PRIMARY KEY,
        purpose_category TEXT NOT NULL,
        initial_description TEXT NOT NULL,
        chosen_tone TEXT,
        chosen_model TEXT,
        chosen_skills TEXT NOT NULL DEFAULT '[]',
        bot_slug TEXT,
        created_at TEXT NOT NULL
    );

    CREATE INDEX IF NOT EXISTS idx_builder_memory_category ON builder_memory(purpose_category);
    ```

    2. Create `crates/boternity-infra/src/builder/mod.rs` with `pub mod sqlite_draft_store; pub mod sqlite_memory_store;`.

    3. Create `crates/boternity-infra/src/builder/sqlite_draft_store.rs`:
    **SqliteBuilderDraftStore** struct holding `DatabasePool`.
    - `save_draft`: INSERT OR REPLACE (upsert on session_id)
    - `load_draft`: SELECT by session_id
    - `list_drafts`: SELECT session_id, extract initial_description and phase from state_json (parse just enough for summary)
    - `delete_draft`: DELETE by session_id

    4. Create `crates/boternity-infra/src/builder/sqlite_memory_store.rs`:
    **SqliteBuilderMemoryStore** struct holding `DatabasePool`.
    - `record_session`: INSERT with UUID v7 id, serialize chosen_skills as JSON array
    - `recall_by_category`: SELECT WHERE purpose_category = ? ORDER BY created_at DESC LIMIT ?
    - `recall_recent`: SELECT ORDER BY created_at DESC LIMIT ?
    - Deserialize chosen_skills from JSON array on read

    5. Add `pub mod builder;` to `crates/boternity-infra/src/lib.rs`.
  </action>
  <verify>
    `cargo check -p boternity-infra` compiles.
    Add tests:
    - test save_draft + load_draft roundtrip
    - test list_drafts returns summary
    - test delete_draft removes entry
    - test record_session + recall_by_category returns matching entries
    - test recall_recent returns ordered entries
    Run `cargo test -p boternity-infra builder` -- tests pass.
  </verify>
  <done>SqliteBuilderDraftStore and SqliteBuilderMemoryStore implement their traits with full SQLite persistence. Migrations create builder_drafts and builder_memory tables. Tests verify roundtrip.</done>
</task>

</tasks>

<verification>
- `cargo check --workspace` compiles
- `cargo test -p boternity-infra builder` passes all tests
- builder_drafts and builder_memory tables created by migration
- Draft save/load/list/delete work
- Memory record/recall work with category filtering
</verification>

<success_criteria>
- BuilderDraftStore trait in core with save/load/list/delete methods
- BuilderMemoryStore trait in core with record/recall methods
- SqliteBuilderDraftStore implements draft persistence with upsert
- SqliteBuilderMemoryStore implements memory with category recall
- Schema version on drafts for forward compatibility
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-builder-system/07-03-SUMMARY.md`
</output>
