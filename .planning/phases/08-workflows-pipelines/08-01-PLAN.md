---
phase: 08-workflows-pipelines
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/boternity-types/Cargo.toml
  - crates/boternity-types/src/workflow.rs
  - crates/boternity-types/src/message.rs
  - crates/boternity-types/src/lib.rs
  - crates/boternity-core/Cargo.toml
  - crates/boternity-infra/Cargo.toml
  - crates/boternity-api/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "WorkflowDefinition can be serialized to and deserialized from YAML"
    - "All step types (Agent, Skill, Code, Http, Conditional, Loop, Approval, SubWorkflow) are representable"
    - "BotMessage envelope supports both direct and pub/sub routing"
    - "Trigger configs support cron, webhook, event, file_watch, and manual types"
    - "New workspace dependencies compile successfully"
  artifacts:
    - path: "crates/boternity-types/src/workflow.rs"
      provides: "WorkflowDefinition, StepDefinition, StepType, StepConfig, TriggerConfig, RetryConfig, WorkflowRun, WorkflowStepLog"
      min_lines: 200
    - path: "crates/boternity-types/src/message.rs"
      provides: "BotMessage, MessageRecipient, Channel, MessageKind"
      min_lines: 60
  key_links:
    - from: "crates/boternity-types/src/workflow.rs"
      to: "serde_yaml_ng"
      via: "Serialize + Deserialize derives"
      pattern: "Serialize.*Deserialize"
    - from: "crates/boternity-types/src/message.rs"
      to: "serde_json"
      via: "Serialize + Deserialize for JSON envelope"
      pattern: "serde_json::Value"
---

<objective>
Define all Phase 8 domain types for workflows, pipelines, and bot-to-bot messaging, and add new workspace dependencies.

Purpose: Every subsequent plan in Phase 8 depends on these types. This is the foundation layer.
Output: `workflow.rs` and `message.rs` in boternity-types, updated workspace Cargo.toml with new dependencies.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflows-pipelines/08-RESEARCH.md
@crates/boternity-types/src/lib.rs
@crates/boternity-types/src/event.rs
@crates/boternity-types/Cargo.toml
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 8 workspace dependencies</name>
  <files>Cargo.toml, crates/boternity-types/Cargo.toml, crates/boternity-core/Cargo.toml, crates/boternity-infra/Cargo.toml, crates/boternity-api/Cargo.toml</files>
  <action>
Add to workspace `[workspace.dependencies]` in root Cargo.toml:
- `tokio-cron-scheduler = { version = "0.15", features = ["english"] }`
- `jexl-eval = "0.4"`
- `notify = "8.2"`
- `notify-debouncer-mini = "0.5"`
- `hmac = "0.12"`
(serde_yaml_ng, petgraph, sha2, reqwest already present)

Add to boternity-types Cargo.toml: `serde_yaml_ng` (already likely present as workspace dep).
Add to boternity-core Cargo.toml: `tokio-cron-scheduler`, `jexl-eval`, `petgraph` (already present), `notify`, `notify-debouncer-mini`.
Add to boternity-infra Cargo.toml: `hmac` (sha2 already present), `notify`, `notify-debouncer-mini`.
Add to boternity-api Cargo.toml: no new deps needed (uses workspace re-exports).

Verify all crates compile with `cargo check --workspace`.
  </action>
  <verify>`cargo check --workspace` compiles without errors</verify>
  <done>All new workspace dependencies added and compile successfully</done>
</task>

<task type="auto">
  <name>Task 2: Create workflow and message domain types</name>
  <files>crates/boternity-types/src/workflow.rs, crates/boternity-types/src/message.rs, crates/boternity-types/src/lib.rs</files>
  <action>
Create `crates/boternity-types/src/workflow.rs` with these types (all derive Debug, Clone, Serialize, Deserialize):

**WorkflowDefinition** (canonical intermediate representation -- YAML, visual, SDK all convert to/from this):
- `id: Uuid` (UUIDv7, assigned on save)
- `name: String`
- `description: Option<String>`
- `version: String` (semver string)
- `owner: WorkflowOwner` enum { Bot { bot_id: Uuid, slug: String }, Global }
- `concurrency: Option<u32>` (max parallel instances, default unlimited)
- `timeout_secs: Option<u64>` (per-workflow timeout override)
- `triggers: Vec<TriggerConfig>`
- `steps: Vec<StepDefinition>`
- `metadata: HashMap<String, serde_json::Value>` (extensible)

**StepDefinition**:
- `id: String` (user-defined step ID, e.g., "gather-news")
- `name: String`
- `step_type: StepType` (serde rename "type")
- `depends_on: Vec<String>` (step IDs this depends on, default empty)
- `condition: Option<String>` (JEXL expression for conditional execution)
- `timeout_secs: Option<u64>` (step-level timeout, default 300)
- `retry: Option<RetryConfig>`
- `config: StepConfig`
- `ui: Option<StepUiMetadata>` (skip_serializing_if Option::is_none, visual builder data)

**StepType** enum (serde rename_all = "snake_case"):
Agent, Skill, Code, Http, Conditional, Loop, Approval, SubWorkflow

**StepConfig** enum (serde tag = "type", rename_all = "snake_case"):
- Agent { bot: String, prompt: String, model: Option<String> }
- Skill { skill: String, input: Option<String> }
- Code { language: CodeLanguage, source: String }
- Http { method: String, url: String, headers: Option<HashMap<String, String>>, body: Option<String> }
- Conditional { condition: String, then_steps: Vec<String>, else_steps: Vec<String> }
- Loop { condition: String, max_iterations: Option<u32>, body_steps: Vec<String> }
- Approval { prompt: String, timeout_secs: Option<u64> }
- SubWorkflow { workflow_name: String, input: Option<serde_json::Value> }

**CodeLanguage** enum: TypeScript, Wasm

**RetryConfig**:
- `max_attempts: u32` (default 3)
- `strategy: RetryStrategy`

**RetryStrategy** enum: Simple, LlmSelfCorrect

**TriggerConfig** enum (serde tag = "type", rename_all = "snake_case"):
- Manual { }
- Cron { schedule: String, timezone: Option<String> }
- Webhook { path: String, auth: Option<WebhookAuth>, when: Option<String> }
- Event { source: String, event_type: String, when: Option<String> }
- FileWatch { paths: Vec<String>, patterns: Option<Vec<String>>, when: Option<String> }

**WebhookAuth** enum (serde tag = "type", rename_all = "snake_case"):
- HmacSha256 { secret_name: String }
- BearerToken { secret_name: String }

**StepUiMetadata**:
- `position: Option<UiPosition>` (x, y coordinates)
- `group: Option<String>` (group node ID)
- `collapsed: Option<bool>`

**UiPosition**: `x: f64, y: f64`

**WorkflowRunStatus** enum (serde rename_all = "snake_case"):
Pending, Running, Paused, Completed, Failed, Crashed, Cancelled

**WorkflowStepStatus** enum (serde rename_all = "snake_case"):
Pending, Running, Completed, Failed, Skipped, WaitingApproval

**WorkflowRun** (for query results):
- id: Uuid, workflow_id: Uuid, workflow_name: String
- status: WorkflowRunStatus, trigger_type: String
- trigger_payload: Option<serde_json::Value>
- context: serde_json::Value (workflow context JSON)
- started_at: DateTime<Utc>, completed_at: Option<DateTime<Utc>>
- error: Option<String>, concurrency_key: Option<String>

**WorkflowStepLog** (for query results):
- id: Uuid, run_id: Uuid, step_id: String, step_name: String
- status: WorkflowStepStatus, attempt: u32
- idempotency_key: Option<String>
- input: Option<serde_json::Value>, output: Option<serde_json::Value>
- error: Option<String>
- started_at: Option<DateTime<Utc>>, completed_at: Option<DateTime<Utc>>

Create `crates/boternity-types/src/message.rs` with:

**BotMessage**:
- `id: Uuid`
- `sender_bot_id: Uuid`
- `sender_bot_name: String`
- `recipient: MessageRecipient`
- `message_type: String` (user-defined type tag, e.g., "question", "delegation")
- `body: serde_json::Value` (flexible JSON body)
- `timestamp: DateTime<Utc>`
- `reply_to: Option<Uuid>` (conversation threading)

**MessageRecipient** enum (serde tag = "type", rename_all = "snake_case"):
- Direct { bot_id: Uuid }
- Channel { name: String }

**Channel**:
- `name: String`
- `created_at: DateTime<Utc>`
- `created_by_bot_id: Uuid`

**BotSubscription**:
- `bot_id: Uuid`
- `channel_name: String`
- `subscribed_at: DateTime<Utc>`

Add `pub mod workflow;` and `pub mod message;` to `crates/boternity-types/src/lib.rs`.

Include serde roundtrip tests for:
- WorkflowDefinition YAML serialization/deserialization (use serde_yaml_ng)
- BotMessage JSON roundtrip
- StepConfig all variants
- TriggerConfig all variants
  </action>
  <verify>`cargo test -p boternity-types -- workflow message` passes all serde roundtrip tests</verify>
  <done>All workflow and message types defined with serde derives, YAML and JSON roundtrip tests pass</done>
</task>

</tasks>

<verification>
- `cargo check --workspace` compiles
- `cargo test -p boternity-types` passes
- WorkflowDefinition can roundtrip through serde_yaml_ng
- BotMessage can roundtrip through serde_json
- All 8 StepType variants and 5 TriggerConfig variants are representable
</verification>

<success_criteria>
- All Phase 8 domain types exist in boternity-types with Serialize/Deserialize
- New workspace dependencies (tokio-cron-scheduler, jexl-eval, notify, hmac) added and compile
- Serde roundtrip tests verify YAML and JSON correctness
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflows-pipelines/08-01-SUMMARY.md`
</output>
