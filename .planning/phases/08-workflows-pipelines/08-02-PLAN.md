---
phase: 08-workflows-pipelines
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - crates/boternity-infra/src/sqlite/workflow.rs
  - crates/boternity-infra/src/sqlite/message.rs
  - crates/boternity-infra/src/sqlite/mod.rs
  - crates/boternity-core/src/repository/workflow.rs
  - crates/boternity-core/src/repository/message.rs
  - crates/boternity-core/src/repository/mod.rs
autonomous: true

must_haves:
  truths:
    - "Workflow definitions can be saved, loaded, listed, and deleted from SQLite"
    - "Workflow runs and step logs are persisted with all required status fields"
    - "Bot-to-bot messages are persisted with audit trail queryable by bot pair or channel"
    - "Channel subscriptions are persisted and recoverable on restart"
  artifacts:
    - path: "crates/boternity-core/src/repository/workflow.rs"
      provides: "WorkflowRepository trait (CRUD + run/step queries)"
      min_lines: 60
    - path: "crates/boternity-core/src/repository/message.rs"
      provides: "MessageRepository trait (send, query, channel, subscription)"
      min_lines: 40
    - path: "crates/boternity-infra/src/sqlite/workflow.rs"
      provides: "SqliteWorkflowRepository with migrations"
      min_lines: 200
    - path: "crates/boternity-infra/src/sqlite/message.rs"
      provides: "SqliteMessageRepository with migrations"
      min_lines: 120
  key_links:
    - from: "crates/boternity-infra/src/sqlite/workflow.rs"
      to: "crates/boternity-types/src/workflow.rs"
      via: "uses WorkflowRun, WorkflowStepLog, WorkflowRunStatus types"
      pattern: "WorkflowRun|WorkflowStepLog|WorkflowRunStatus"
    - from: "crates/boternity-infra/src/sqlite/message.rs"
      to: "crates/boternity-types/src/message.rs"
      via: "uses BotMessage, Channel, BotSubscription types"
      pattern: "BotMessage|Channel|BotSubscription"
---

<objective>
Create SQLite persistence for workflow definitions, execution runs, step logs, bot-to-bot messages, channels, and subscriptions.

Purpose: The workflow executor and message bus need durable storage. Workflow runs checkpoint to SQLite for crash recovery. All bot-to-bot messages are audited.
Output: Repository traits in boternity-core, SQLite implementations with migrations in boternity-infra.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-workflows-pipelines/08-RESEARCH.md
@crates/boternity-core/src/repository/mod.rs
@crates/boternity-infra/src/sqlite/mod.rs
@crates/boternity-infra/src/sqlite/bot.rs
@crates/boternity-infra/src/sqlite/pool.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define workflow and message repository traits</name>
  <files>crates/boternity-core/src/repository/workflow.rs, crates/boternity-core/src/repository/message.rs, crates/boternity-core/src/repository/mod.rs</files>
  <action>
Create `crates/boternity-core/src/repository/workflow.rs` with `WorkflowRepository` trait (RPITIT, consistent with project pattern):

Methods:
- `save_definition(&self, def: &WorkflowDefinition) -> Result<(), RepositoryError>` (upsert by id)
- `get_definition(&self, id: &Uuid) -> Result<Option<WorkflowDefinition>, RepositoryError>`
- `get_definition_by_name(&self, name: &str, owner: &WorkflowOwner) -> Result<Option<WorkflowDefinition>, RepositoryError>`
- `list_definitions(&self, owner: Option<&WorkflowOwner>) -> Result<Vec<WorkflowDefinition>, RepositoryError>`
- `delete_definition(&self, id: &Uuid) -> Result<bool, RepositoryError>`
- `create_run(&self, run: &WorkflowRun) -> Result<(), RepositoryError>`
- `update_run_status(&self, run_id: &Uuid, status: WorkflowRunStatus, error: Option<&str>, context: Option<&serde_json::Value>) -> Result<(), RepositoryError>`
- `get_run(&self, run_id: &Uuid) -> Result<Option<WorkflowRun>, RepositoryError>`
- `list_runs(&self, workflow_id: &Uuid, limit: u32) -> Result<Vec<WorkflowRun>, RepositoryError>`
- `list_crashed_runs(&self) -> Result<Vec<WorkflowRun>, RepositoryError>` (status = 'running' at startup = crashed)
- `create_step_log(&self, step: &WorkflowStepLog) -> Result<(), RepositoryError>`
- `update_step_status(&self, step_id: &Uuid, status: WorkflowStepStatus, output: Option<&serde_json::Value>, error: Option<&str>) -> Result<(), RepositoryError>`
- `list_step_logs(&self, run_id: &Uuid) -> Result<Vec<WorkflowStepLog>, RepositoryError>`
- `get_completed_step_ids(&self, run_id: &Uuid) -> Result<Vec<String>, RepositoryError>`

Create `crates/boternity-core/src/repository/message.rs` with `MessageRepository` trait:

Methods:
- `save_message(&self, msg: &BotMessage) -> Result<(), RepositoryError>`
- `get_messages_between(&self, bot_a: &Uuid, bot_b: &Uuid, limit: u32) -> Result<Vec<BotMessage>, RepositoryError>`
- `get_channel_messages(&self, channel: &str, limit: u32) -> Result<Vec<BotMessage>, RepositoryError>`
- `list_channels(&self) -> Result<Vec<Channel>, RepositoryError>`
- `create_channel(&self, channel: &Channel) -> Result<(), RepositoryError>`
- `subscribe(&self, sub: &BotSubscription) -> Result<(), RepositoryError>`
- `unsubscribe(&self, bot_id: &Uuid, channel_name: &str) -> Result<bool, RepositoryError>`
- `get_subscriptions(&self, bot_id: &Uuid) -> Result<Vec<BotSubscription>, RepositoryError>`
- `get_channel_subscribers(&self, channel_name: &str) -> Result<Vec<Uuid>, RepositoryError>`

Add `pub mod workflow;` and `pub mod message;` to repository mod.rs.
  </action>
  <verify>`cargo check -p boternity-core` compiles</verify>
  <done>WorkflowRepository and MessageRepository traits defined with RPITIT</done>
</task>

<task type="auto">
  <name>Task 2: Implement SQLite workflow and message repositories with migrations</name>
  <files>crates/boternity-infra/src/sqlite/workflow.rs, crates/boternity-infra/src/sqlite/message.rs, crates/boternity-infra/src/sqlite/mod.rs</files>
  <action>
Create SQLite migration (date prefix 20260216 to follow existing pattern) with tables:

**workflows** table:
- id TEXT PRIMARY KEY (UUIDv7)
- name TEXT NOT NULL
- owner_type TEXT NOT NULL ('bot' or 'global')
- owner_bot_id TEXT (nullable, FK to bots.id when owner_type='bot')
- definition TEXT NOT NULL (full WorkflowDefinition as JSON -- roundtrips through serde_json, stored as JSON not YAML for query flexibility)
- created_at TEXT NOT NULL
- updated_at TEXT NOT NULL
- UNIQUE(name, owner_type, COALESCE(owner_bot_id, ''))

**workflow_runs** table:
- id TEXT PRIMARY KEY (UUIDv7)
- workflow_id TEXT NOT NULL REFERENCES workflows(id)
- workflow_name TEXT NOT NULL
- status TEXT NOT NULL CHECK(status IN ('pending','running','paused','completed','failed','crashed','cancelled'))
- trigger_type TEXT NOT NULL
- trigger_payload TEXT (JSON)
- context TEXT NOT NULL DEFAULT '{}'
- started_at TEXT NOT NULL
- completed_at TEXT
- error TEXT
- concurrency_key TEXT
- CREATE INDEX idx_workflow_runs_workflow_id ON workflow_runs(workflow_id)
- CREATE INDEX idx_workflow_runs_status ON workflow_runs(status)

**workflow_steps** table:
- id TEXT PRIMARY KEY (UUIDv7)
- run_id TEXT NOT NULL REFERENCES workflow_runs(id) ON DELETE CASCADE
- step_id TEXT NOT NULL (matches StepDefinition.id)
- step_name TEXT NOT NULL
- status TEXT NOT NULL CHECK(status IN ('pending','running','completed','failed','skipped','waiting_approval'))
- attempt INTEGER NOT NULL DEFAULT 1
- idempotency_key TEXT
- input TEXT (JSON)
- output TEXT (JSON)
- error TEXT
- started_at TEXT
- completed_at TEXT
- CREATE INDEX idx_workflow_steps_run_id ON workflow_steps(run_id)

**bot_messages** table:
- id TEXT PRIMARY KEY (UUIDv7)
- sender_bot_id TEXT NOT NULL
- sender_bot_name TEXT NOT NULL
- recipient_type TEXT NOT NULL ('direct' or 'channel')
- recipient_bot_id TEXT (nullable, for direct messages)
- recipient_channel TEXT (nullable, for channel messages)
- message_type TEXT NOT NULL
- body TEXT NOT NULL (JSON)
- reply_to TEXT (nullable, UUIDv7 of parent message)
- timestamp TEXT NOT NULL
- CREATE INDEX idx_bot_messages_pair ON bot_messages(sender_bot_id, recipient_bot_id)
- CREATE INDEX idx_bot_messages_channel ON bot_messages(recipient_channel)
- CREATE INDEX idx_bot_messages_timestamp ON bot_messages(timestamp)

**bot_channels** table:
- name TEXT PRIMARY KEY
- created_at TEXT NOT NULL
- created_by_bot_id TEXT NOT NULL

**bot_subscriptions** table:
- bot_id TEXT NOT NULL
- channel_name TEXT NOT NULL REFERENCES bot_channels(name) ON DELETE CASCADE
- subscribed_at TEXT NOT NULL
- PRIMARY KEY (bot_id, channel_name)

Also add `session_type TEXT NOT NULL DEFAULT 'user'` and `peer_bot_id TEXT` columns to chat_sessions table via ALTER TABLE (per research recommendation for bot-to-bot sessions).

Implement `SqliteWorkflowRepository` with all WorkflowRepository trait methods. Store WorkflowDefinition as JSON in `definition` column using serde_json::to_string/from_str. Use `synchronous=FULL` pragma for checkpoint writes (run_status updates and step_status updates).

Implement `SqliteMessageRepository` with all MessageRepository trait methods. For `get_messages_between`, query where (sender=A AND recipient_bot_id=B) OR (sender=B AND recipient_bot_id=A) ordered by timestamp DESC.

Add `pub mod workflow;` and `pub mod message;` to sqlite/mod.rs.

Follow existing patterns: private Row structs for SQLite-to-domain mapping (consistent with BotRow pattern from 01-02), DatabasePool clone for constructor.
  </action>
  <verify>`cargo check -p boternity-infra` compiles and `cargo test -p boternity-infra -- sqlite::workflow sqlite::message` passes</verify>
  <done>SQLite repositories implement all workflow and message persistence with migrations, synchronous=FULL for checkpoints</done>
</task>

</tasks>

<verification>
- `cargo check --workspace` compiles
- Workflow definitions can be saved and loaded from SQLite
- Workflow runs and step logs track all 7/6 status states
- Bot messages are queryable by pair and by channel
- Subscriptions are persisted and queryable
</verification>

<success_criteria>
- WorkflowRepository and MessageRepository traits exist in boternity-core
- SqliteWorkflowRepository and SqliteMessageRepository exist in boternity-infra
- All CRUD + query operations implemented
- Migrations create the 5 new tables + chat_sessions columns
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflows-pipelines/08-02-SUMMARY.md`
</output>
