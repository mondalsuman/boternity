---
phase: 08-workflows-pipelines
plan: 10
type: execute
wave: 6
depends_on: ["08-09"]
files_modified:
  - apps/web/package.json
  - apps/web/src/routes/workflows/index.tsx
  - apps/web/src/routes/workflows/$workflowId.tsx
  - apps/web/src/routes/workflows/builder/$workflowId.tsx
  - apps/web/src/components/workflow/WorkflowCanvas.tsx
  - apps/web/src/components/workflow/nodes/AgentNode.tsx
  - apps/web/src/components/workflow/nodes/SkillNode.tsx
  - apps/web/src/components/workflow/nodes/CodeNode.tsx
  - apps/web/src/components/workflow/nodes/HttpNode.tsx
  - apps/web/src/components/workflow/nodes/ConditionalNode.tsx
  - apps/web/src/components/workflow/nodes/LoopNode.tsx
  - apps/web/src/components/workflow/nodes/ApprovalNode.tsx
  - apps/web/src/components/workflow/nodes/SubWorkflowNode.tsx
  - apps/web/src/components/workflow/edges/TypedEdge.tsx
  - apps/web/src/lib/api/workflows.ts
  - apps/web/src/stores/workflow-store.ts
autonomous: true

must_haves:
  truths:
    - "User can see a list of all workflows in the web UI"
    - "User can view workflow detail with run history"
    - "User can open the visual builder with a React Flow canvas"
    - "Custom nodes render for all 8 step types with rich previews"
    - "Typed edges show data type with color coding"
    - "Canvas supports drag, pan, zoom, and minimap navigation"
  artifacts:
    - path: "apps/web/src/components/workflow/WorkflowCanvas.tsx"
      provides: "React Flow canvas with custom nodes, minimap, controls"
      min_lines: 100
    - path: "apps/web/src/components/workflow/nodes/AgentNode.tsx"
      provides: "Agent step custom node with bot name, prompt preview, status indicator"
      min_lines: 30
    - path: "apps/web/src/components/workflow/edges/TypedEdge.tsx"
      provides: "Color-coded edge by data type (text/JSON/file)"
      min_lines: 30
    - path: "apps/web/src/lib/api/workflows.ts"
      provides: "API client for workflow CRUD, trigger, runs"
      min_lines: 60
  key_links:
    - from: "apps/web/src/components/workflow/WorkflowCanvas.tsx"
      to: "@xyflow/react"
      via: "ReactFlow component with custom nodeTypes"
      pattern: "ReactFlow|@xyflow/react"
    - from: "apps/web/src/lib/api/workflows.ts"
      to: "/api/v1/workflows"
      via: "fetch API calls"
      pattern: "api/v1/workflows"
    - from: "apps/web/src/stores/workflow-store.ts"
      to: "zustand"
      via: "Zustand store for canvas state"
      pattern: "create.*zustand"
---

<objective>
Build the web UI workflow pages and React Flow visual builder canvas with custom nodes for all step types.

Purpose: Users need to manage workflows visually. The React Flow canvas is the core of the visual builder experience (WEBU-05, WKFL-02).
Output: Workflow list page, detail page, visual builder canvas with 8 custom node types, typed edges, and API client.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-workflows-pipelines/08-RESEARCH.md
@apps/web/src/routes/__root.tsx
@apps/web/src/routes/index.tsx
@apps/web/src/components
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, API client, store, and workflow list/detail pages</name>
  <files>apps/web/package.json, apps/web/src/lib/api/workflows.ts, apps/web/src/stores/workflow-store.ts, apps/web/src/routes/workflows/index.tsx, apps/web/src/routes/workflows/$workflowId.tsx</files>
  <action>
**Install dependencies:**
```bash
cd apps/web && pnpm add @xyflow/react @dagrejs/dagre && pnpm add -D @types/dagre
```

**Create API client** `apps/web/src/lib/api/workflows.ts`:
- `fetchWorkflows(botSlug?: string): Promise<WorkflowSummary[]>` -- GET /api/v1/workflows
- `fetchWorkflow(id: string): Promise<WorkflowDefinition>` -- GET /api/v1/workflows/:id
- `createWorkflow(def: WorkflowDefinition): Promise<{ id: string }>` -- POST /api/v1/workflows
- `updateWorkflow(id: string, def: WorkflowDefinition): Promise<void>` -- PUT /api/v1/workflows/:id
- `deleteWorkflow(id: string): Promise<void>` -- DELETE /api/v1/workflows/:id
- `triggerWorkflow(id: string, payload?: unknown): Promise<{ run_id: string }>` -- POST /api/v1/workflows/:id/trigger
- `fetchRuns(workflowId: string, limit?: number): Promise<WorkflowRun[]>` -- GET /api/v1/workflows/:id/runs
- `fetchRunDetail(runId: string): Promise<{ run: WorkflowRun, steps: WorkflowStepLog[] }>` -- GET /api/v1/runs/:run_id
- `approveRun(runId: string): Promise<void>` -- POST /api/v1/runs/:run_id/approve
- `cancelRun(runId: string): Promise<void>` -- POST /api/v1/runs/:run_id/cancel

Define TypeScript types matching Rust types: WorkflowDefinition, StepDefinition, StepType, StepConfig, TriggerConfig, WorkflowRun, WorkflowStepLog, WorkflowRunStatus, WorkflowStepStatus.

**Create Zustand store** `apps/web/src/stores/workflow-store.ts`:
- State: selectedWorkflowId, selectedRunId, isBuilderOpen
- Actions: setSelectedWorkflow, setSelectedRun, openBuilder, closeBuilder

**Create workflow list page** `apps/web/src/routes/workflows/index.tsx`:
- TanStack Query for fetching workflows
- Table/card grid display: Name | Owner | Steps | Triggers | Last Run | Status
- "Create Workflow" button (opens file upload dialog for YAML or navigates to builder)
- "Open Builder" button per workflow
- "Trigger" button per workflow
- Delete with AlertDialog confirmation
- Search/filter by name

**Create workflow detail page** `apps/web/src/routes/workflows/$workflowId.tsx`:
- Header: workflow name, description, owner
- Trigger badges (cron icon, webhook icon, etc.)
- Tabs: "Runs" (default) | "Definition" (YAML view) | "Builder" (link to visual builder)
- Runs tab: table of recent runs with status badges, duration, trigger type
- Click run to expand step detail inline
- Step detail: step name, status badge, duration, attempt count, output preview, error if failed
- "Trigger Now" button, "Delete" button

Add routes to TanStack Router. Add "Workflows" link to sidebar navigation (consistent with existing Fleet, Chat, Builder nav items).
  </action>
  <verify>`cd apps/web && pnpm build` compiles successfully, workflow routes registered</verify>
  <done>Workflow list and detail pages render with API integration, @xyflow/react installed</done>
</task>

<task type="auto">
  <name>Task 2: React Flow canvas with custom nodes and typed edges</name>
  <files>apps/web/src/routes/workflows/builder/$workflowId.tsx, apps/web/src/components/workflow/WorkflowCanvas.tsx, apps/web/src/components/workflow/nodes/AgentNode.tsx, apps/web/src/components/workflow/nodes/SkillNode.tsx, apps/web/src/components/workflow/nodes/CodeNode.tsx, apps/web/src/components/workflow/nodes/HttpNode.tsx, apps/web/src/components/workflow/nodes/ConditionalNode.tsx, apps/web/src/components/workflow/nodes/LoopNode.tsx, apps/web/src/components/workflow/nodes/ApprovalNode.tsx, apps/web/src/components/workflow/nodes/SubWorkflowNode.tsx, apps/web/src/components/workflow/edges/TypedEdge.tsx</files>
  <action>
**Create WorkflowCanvas component** `apps/web/src/components/workflow/WorkflowCanvas.tsx`:
- Import `@xyflow/react` CSS: `import '@xyflow/react/dist/style.css';`
- Use `ReactFlow` component with:
  - `nodeTypes` mapping all 8 custom node types
  - `edgeTypes` mapping TypedEdge
  - `MiniMap` (bottom-right, per Claude's discretion)
  - `Controls` (zoom buttons)
  - `Background` (dots grid)
  - `fitView` on initial load
  - Event handlers: onNodesChange, onEdgesChange, onConnect
- State: nodes: Node[], edges: Edge[] managed via React Flow's useNodesState, useEdgesState hooks
- `onConnect`: creates typed edge between source and target handles
- `onDrop`: accepts drag from palette (NodePalette wired in Plan 11)
- Auto-layout via dagre on initial load and "Auto Layout" button:
  ```typescript
  import dagre from '@dagrejs/dagre';
  function getLayoutedElements(nodes, edges, direction = 'TB') {
    const g = new dagre.graphlib.Graph();
    g.setDefaultEdgeLabel(() => ({}));
    g.setGraph({ rankdir: direction, nodesep: 50, ranksep: 100 });
    nodes.forEach(n => g.setNode(n.id, { width: 250, height: 80 }));
    edges.forEach(e => g.setEdge(e.source, e.target));
    dagre.layout(g);
    return nodes.map(n => ({ ...n, position: { x: g.node(n.id).x, y: g.node(n.id).y } }));
  }
  ```

**Create all 8 custom node components** in `apps/web/src/components/workflow/nodes/`:

Each node follows the same pattern (per research code example):
- Rounded border card with step type icon and label
- Handle type="target" at Position.Top (input)
- Handle type="source" at Position.Bottom (output)
- Status color background: idle=muted, running=yellow pulse, completed=green, failed=red
- Rich preview content specific to step type

Node-specific content:
1. **AgentNode**: Bot icon, bot name, first line of prompt, "Agent" badge
2. **SkillNode**: Zap icon, skill name, input preview, "Skill" badge
3. **CodeNode**: Code icon, language badge (TS/WASM), first line of source, "Code" badge
4. **HttpNode**: Globe icon, method badge (GET/POST/etc), URL, "HTTP" badge
5. **ConditionalNode**: GitBranch icon, condition preview, two source handles (then/else at bottom-left and bottom-right)
6. **LoopNode**: Repeat icon, condition, max iterations, source handle loops back
7. **ApprovalNode**: UserCheck icon, prompt preview, "Approval Gate" badge, yellow accent border
8. **SubWorkflowNode**: Layers icon, workflow name, "Sub-Workflow" badge

**Create TypedEdge** `apps/web/src/components/workflow/edges/TypedEdge.tsx`:
- Custom edge component with color coding by data type (per Claude's discretion):
  - text: blue (#3b82f6)
  - json: green (#22c55e)
  - file: orange (#f97316)
  - default: gray (#94a3b8)
- Animated dashed line during execution (via CSS animation)
- Label showing data type on hover

**Create builder page** `apps/web/src/routes/workflows/builder/$workflowId.tsx`:
- Full-viewport canvas (height: calc(100vh - header))
- Load workflow definition from API
- Convert WorkflowDefinition to React Flow nodes/edges using definitionToFlow() helper
- Convert back on save using flowToDefinition() helper (per research Pattern 5)
- Save button -> PUT /api/v1/workflows/:id
- "Back" link to workflow detail

Register custom nodes via `nodeTypes` constant object (not inline, to avoid React re-renders).
  </action>
  <verify>`cd apps/web && pnpm build` compiles and builder route loads React Flow canvas</verify>
  <done>Visual builder renders React Flow canvas with 8 custom node types, typed edges, minimap, and auto-layout</done>
</task>

</tasks>

<verification>
- `cd apps/web && pnpm build` compiles without errors
- Workflow list page fetches and displays workflows
- Workflow detail page shows runs with step logs
- Builder page renders React Flow canvas
- All 8 node types render with correct icons and content
- Typed edges show color-coded connections
- Minimap shows bird's-eye view
- Dagre auto-layout arranges nodes
</verification>

<success_criteria>
- WEBU-05: Visual workflow builder with drag-and-drop React Flow canvas
- All 8 step types have custom node components with rich previews
- Typed edges with color coding by data type
- Minimap and controls for navigation
- Auto-layout via dagre
- API client fully wired for workflow operations
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflows-pipelines/08-10-SUMMARY.md`
</output>
