---
phase: 08-workflows-pipelines
plan: 11
type: execute
wave: 7
depends_on: ["08-10"]
files_modified:
  - apps/web/src/components/workflow/panels/StepConfigPanel.tsx
  - apps/web/src/components/workflow/panels/NodePalette.tsx
  - apps/web/src/components/workflow/YamlEditor.tsx
  - apps/web/src/components/workflow/WorkflowTemplates.tsx
  - apps/web/src/components/workflow/WorkflowCanvas.tsx
  - apps/web/src/hooks/use-undo-redo.ts
  - apps/web/src/routes/workflows/builder/$workflowId.tsx
autonomous: true

must_haves:
  truths:
    - "User can click a node to open the step configuration panel on the right"
    - "User can drag step types from the sidebar palette onto the canvas"
    - "User can toggle between visual canvas and YAML editor with bidirectional sync"
    - "User can undo/redo canvas operations with Ctrl+Z/Ctrl+Y"
    - "User can start from built-in workflow templates"
    - "User can group/ungroup selected nodes"
  artifacts:
    - path: "apps/web/src/components/workflow/panels/StepConfigPanel.tsx"
      provides: "Side panel for editing step configuration"
      min_lines: 100
    - path: "apps/web/src/components/workflow/panels/NodePalette.tsx"
      provides: "Categorized sidebar palette with drag-to-add and search"
      min_lines: 80
    - path: "apps/web/src/components/workflow/YamlEditor.tsx"
      provides: "Monaco YAML editor with bidirectional sync"
      min_lines: 60
    - path: "apps/web/src/hooks/use-undo-redo.ts"
      provides: "Snapshot-based undo/redo for canvas operations"
      min_lines: 40
  key_links:
    - from: "apps/web/src/components/workflow/panels/NodePalette.tsx"
      to: "apps/web/src/components/workflow/WorkflowCanvas.tsx"
      via: "onDragStart -> onDrop creates new node"
      pattern: "onDragStart|onDrop|dataTransfer"
    - from: "apps/web/src/components/workflow/YamlEditor.tsx"
      to: "apps/web/src/components/workflow/WorkflowCanvas.tsx"
      via: "bidirectional sync through activeEditor flag"
      pattern: "activeEditor|flowToDefinition|definitionToFlow"
---

<objective>
Build the visual builder panels, YAML editor toggle, undo/redo, templates, and node grouping for a complete n8n-like builder experience.

Purpose: The canvas from Plan 10 needs interactive controls: configuration panel, step palette, YAML editor toggle, undo/redo, and templates. This completes the visual builder.
Output: StepConfigPanel, NodePalette, YamlEditor, WorkflowTemplates, undo/redo hook.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-workflows-pipelines/08-RESEARCH.md
@apps/web/src/components/workflow/WorkflowCanvas.tsx
@apps/web/src/routes/workflows/builder/$workflowId.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Step config panel, node palette, and undo/redo</name>
  <files>apps/web/src/components/workflow/panels/StepConfigPanel.tsx, apps/web/src/components/workflow/panels/NodePalette.tsx, apps/web/src/hooks/use-undo-redo.ts, apps/web/src/components/workflow/WorkflowCanvas.tsx</files>
  <action>
**Create StepConfigPanel** `apps/web/src/components/workflow/panels/StepConfigPanel.tsx`:
- Right-side sliding panel (w-80, border-l) that opens when a node is selected
- Props: selectedNode: Node | null, onUpdate: (nodeId, data) => void, onClose: () => void
- Dynamic form fields based on step type:
  - Agent: bot select (dropdown), prompt textarea, model select (optional)
  - Skill: skill name input, input textarea
  - Code: language toggle (TS/WASM), Monaco code editor (small)
  - HTTP: method select (GET/POST/PUT/DELETE), URL input, headers key-value pairs, body textarea
  - Conditional: condition expression input, then_steps/else_steps multi-select
  - Loop: condition input, max_iterations number input, body_steps multi-select
  - Approval: prompt textarea, timeout number input
  - SubWorkflow: workflow name select, input JSON textarea
- Common fields for all types: step name, timeout, retry config (max_attempts, strategy)
- depends_on multi-select (list of other step IDs)
- Condition expression input (JEXL)
- Changes immediately update the node data (controlled component pattern)

**Create NodePalette** `apps/web/src/components/workflow/panels/NodePalette.tsx`:
- Left-side sidebar panel (w-60) with categorized step types
- Categories (per Claude's discretion):
  - "AI" category: Agent, Skill
  - "Logic" category: Conditional, Loop
  - "Integration" category: HTTP, Code, SubWorkflow
  - "Control" category: Approval
- Each item: icon + label, draggable
- Drag uses HTML5 drag-and-drop: `onDragStart` sets `dataTransfer` with step type
- Search input at top: filters items by name (Notion-style quick add per user decision)
- Compact design: icons are small, labels fit in sidebar width

**Update WorkflowCanvas** to:
- Handle `onDrop` event: read step type from dataTransfer, create new node at drop position with default config, add to nodes array
- Handle node selection: set selectedNodeId -> opens StepConfigPanel
- Handle keyboard shortcuts: Ctrl+Z (undo), Ctrl+Y (redo)
- Integrate NodePalette on left, StepConfigPanel on right
- Layout: palette | canvas | config panel (flex row)

**Create undo/redo hook** `apps/web/src/hooks/use-undo-redo.ts`:
- Per research code example: past/future ref arrays of { nodes, edges } snapshots
- `takeSnapshot(nodes, edges)` -- push current state to past, clear future
- `undo(currentNodes, currentEdges)` -- pop past, push current to future, return prev
- `redo(currentNodes, currentEdges)` -- pop future, push current to past, return next
- `canUndo()`, `canRedo()` -- boolean checks
- Max history: 50 entries
- Uses structuredClone for deep copies

Wire undo/redo into WorkflowCanvas: call takeSnapshot before node/edge mutations, Ctrl+Z calls undo and sets nodes/edges, Ctrl+Y calls redo.
  </action>
  <verify>`cd apps/web && pnpm build` compiles, palette and config panel render</verify>
  <done>Step config panel, node palette with drag-and-drop, and undo/redo with keyboard shortcuts all functional</done>
</task>

<task type="auto">
  <name>Task 2: YAML editor toggle, templates, and node grouping</name>
  <files>apps/web/src/components/workflow/YamlEditor.tsx, apps/web/src/components/workflow/WorkflowTemplates.tsx, apps/web/src/routes/workflows/builder/$workflowId.tsx</files>
  <action>
**Create YamlEditor** `apps/web/src/components/workflow/YamlEditor.tsx`:
- Uses Monaco editor (already in web app for soul editor) with YAML language mode
- Props: value: string, onChange: (yaml: string) => void, readOnly?: boolean
- Full-height editor panel that replaces the canvas when active
- Debounced onChange (500ms) to avoid excessive re-parsing
- Syntax validation: try parsing YAML, show inline error decorations if invalid
- Line numbers, word wrap, minimap off (editor minimap, not canvas minimap)

**Update builder page** with toggle between canvas and YAML:
- `activeEditor: 'canvas' | 'yaml'` state flag (per research pitfall 5 -- prevents sync loop)
- Toggle button in toolbar: "Canvas" / "YAML" tabs
- When switching from canvas to yaml: flowToDefinition() -> serialize to YAML string -> set as editor value
- When switching from yaml to canvas: parse YAML -> validate -> definitionToFlow() -> set nodes/edges
- Only sync FROM the active editor TO the inactive one (never bidirectional simultaneously)
- Show validation errors inline when YAML is invalid

**Create WorkflowTemplates** `apps/web/src/components/workflow/WorkflowTemplates.tsx`:
- Dialog/modal that shows template categories (per Claude's discretion):
  - "Data Pipeline": sequential agent -> skill -> HTTP notification
  - "Approval Flow": agent -> approval gate -> notification
  - "Multi-Bot Collaboration": parallel agents -> synthesis agent
  - "Scheduled Report": cron trigger -> agent -> format -> notify
- Each template: name, description, preview thumbnail (small canvas snapshot or icon)
- "Use Template" button: loads template WorkflowDefinition, converts to nodes/edges, sets on canvas
- Templates are hardcoded constants (not fetched from API)

**Add node grouping** to WorkflowCanvas:
- "Group Selected" button in toolbar: takes selected nodes, creates a group node (type='group') as parent
- Group node uses React Flow's `parentId` API on child nodes
- "Ungroup" context menu on group nodes
- Collapsible groups: click group header to toggle expanded/collapsed (collapsed shows single summary node)

**Update builder toolbar:**
- Save button (persist to API)
- Canvas/YAML toggle
- Auto-layout button (dagre)
- Undo/Redo buttons (with Ctrl+Z/Y shortcuts)
- Group selected button
- "Templates" button (opens dialog)
- "Test Step" button (sends selected step config to API for single-step dry run -- placeholder, wired in Plan 13)
- "Run Workflow" button (dry-run -- placeholder, wired in Plan 13)
  </action>
  <verify>`cd apps/web && pnpm build` compiles, YAML editor toggles correctly, templates load</verify>
  <done>YAML editor with bidirectional sync, workflow templates, and node grouping complete the visual builder</done>
</task>

</tasks>

<verification>
- `cd apps/web && pnpm build` compiles without errors
- Clicking a node opens the config panel with correct fields
- Dragging from palette creates a new node on canvas
- Ctrl+Z/Ctrl+Y undo/redo canvas operations
- Canvas <-> YAML toggle syncs correctly (no infinite loop)
- Templates load predefined workflows onto canvas
- Node grouping creates collapsible group nodes
</verification>

<success_criteria>
- Side panel configures all 8 step types with appropriate form fields
- Categorized palette enables drag-and-drop step creation
- Bidirectional YAML <-> canvas sync via activeEditor flag (no sync loops)
- Full undo/redo history (50 entries)
- Built-in templates for common workflow patterns
- Node grouping with collapse/expand
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflows-pipelines/08-11-SUMMARY.md`
</output>
