---
phase: 09-mcp-integration
plan: 09
type: execute
wave: 5
depends_on: ["09-04", "09-06", "09-07"]
files_modified:
  - crates/boternity-api/src/cli/mcp.rs
  - crates/boternity-api/src/cli/mod.rs
autonomous: true

must_haves:
  truths:
    - "User can add/remove/list/status MCP servers via CLI"
    - "User can connect/disconnect MCP servers at runtime"
    - "User can start MCP server via 'bnity mcp serve'"
    - "User can test MCP tool calls outside chat via 'bnity mcp test-tool'"
    - "Global and per-bot MCP server management works"
  artifacts:
    - path: "crates/boternity-api/src/cli/mcp.rs"
      provides: "Full MCP CLI command surface"
      min_lines: 200
      contains: "McpCommand"
  key_links:
    - from: "crates/boternity-api/src/cli/mcp.rs"
      to: "crates/boternity-infra/src/mcp/config_store.rs"
      via: "JsonMcpConfigStore for add/remove"
      pattern: "JsonMcpConfigStore"
    - from: "crates/boternity-api/src/cli/mcp.rs"
      to: "crates/boternity-infra/src/mcp/server_transport.rs"
      via: "start_mcp_http_server for serve"
      pattern: "start_mcp"
---

<objective>
Implement the full CLI command surface for MCP management: add/remove/list/status/connect/disconnect/serve/test-tool.

Purpose: Per locked decision, the CLI provides `bnity mcp add/remove/list/status/connect/disconnect` plus `bnity mcp serve` (dedicated subcommand, not integrated into existing `bnity serve`) and `bnity mcp test-tool`. Same `add` command for global (no --bot) and per-bot (--bot slug) connections.
Output: Complete MCP CLI module with all 8 subcommands.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mcp-integration/09-RESEARCH.md
@crates/boternity-api/src/cli/mod.rs
@crates/boternity-infra/src/mcp/config_store.rs
@crates/boternity-infra/src/mcp/server_transport.rs
@crates/boternity-infra/src/mcp/client_manager.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP CLI command definitions</name>
  <files>crates/boternity-api/src/cli/mcp.rs, crates/boternity-api/src/cli/mod.rs</files>
  <action>
Create `crates/boternity-api/src/cli/mcp.rs` and add `pub mod mcp;` to cli/mod.rs.

Add `Mcp` variant to the main `Commands` enum in mod.rs:
```rust
/// Manage MCP server connections and start MCP server.
Mcp {
    #[command(subcommand)]
    action: mcp::McpCommand,
},
```

**McpCommand enum with subcommands:**

```rust
#[derive(Subcommand)]
pub enum McpCommand {
    /// Add an MCP server connection.
    Add {
        /// Server name (unique identifier).
        name: String,
        /// Bot slug for per-bot scoping (omit for global).
        #[arg(long)]
        bot: Option<String>,
        /// Transport type: stdio, http, sse.
        #[arg(long, default_value = "stdio")]
        transport: String,
        /// Command for stdio transport.
        #[arg(long)]
        command: Option<String>,
        /// Arguments for stdio command.
        #[arg(long, num_args = 0..)]
        args: Vec<String>,
        /// URL for HTTP/SSE transport.
        #[arg(long)]
        url: Option<String>,
        /// Credential key name (stored in MCP keystore).
        #[arg(long)]
        credential: Option<String>,
        /// Use a built-in preset (filesystem, github, slack, memory, brave-search).
        #[arg(long)]
        preset: Option<String>,
        /// Sampling token budget for this server.
        #[arg(long)]
        sampling_budget: Option<u64>,
    },

    /// Remove an MCP server connection.
    Remove {
        /// Server name to remove.
        name: String,
    },

    /// List configured MCP servers.
    List {
        /// Filter by bot slug (omit for all).
        #[arg(long)]
        bot: Option<String>,
    },

    /// Show status of MCP server connections.
    Status {
        /// Specific server name (omit for all).
        name: Option<String>,
    },

    /// Connect to an MCP server (start session).
    Connect {
        /// Server name to connect to.
        name: String,
    },

    /// Disconnect from an MCP server.
    Disconnect {
        /// Server name to disconnect from.
        name: String,
    },

    /// Start the Boternity MCP server.
    Serve {
        /// Port to listen on.
        #[arg(short, long, default_value = "3001")]
        port: u16,
        /// Host to bind to.
        #[arg(long, default_value = "127.0.0.1")]
        host: String,
        /// Use stdio transport instead of HTTP.
        #[arg(long)]
        stdio: bool,
    },

    /// Test an MCP tool call outside of chat.
    TestTool {
        /// Server name.
        server: String,
        /// Tool name.
        tool: String,
        /// Tool arguments as JSON string.
        #[arg(long, default_value = "{}")]
        input: String,
    },

    /// Set a credential for an MCP server.
    SetCredential {
        /// Credential key name.
        key: String,
        /// Credential value (prompted securely if omitted).
        #[arg(long)]
        value: Option<String>,
    },

    /// List available presets.
    Presets,
}
```

**Handler implementations:**

- `handle_add`: If --preset provided, load preset and merge with overrides. Build McpServerConfig, add via config_store. If --bot provided, add to bot_overrides. Print success with server details.
- `handle_remove`: Remove via config_store, print confirmation.
- `handle_list`: Load config, display table (name, transport, status, tool count). If --bot, show effective servers.
- `handle_status`: Show connection metadata from SQLite (status, last ping, tools/resources/prompts count, error if any). Use comfy-table for display.
- `handle_connect`: Load config for server, create client_manager, call connect(), show discovered tools count.
- `handle_disconnect`: Call client_manager.disconnect(), update status.
- `handle_serve`: If --stdio, call `start_mcp_stdio_server`. Otherwise call `start_mcp_http_server` with generated auth token. Print "MCP server listening on {host}:{port}" and auth token for client use.
- `handle_test_tool`: Parse JSON input, connect to server if not connected, call tool, display result with syntax highlighting. Use `syntect` for JSON highlighting if available, otherwise pretty-print.
- `handle_set_credential`: If value not provided, use `dialoguer::Password` to prompt securely. Save to MCP keystore.
- `handle_presets`: List all builtin presets with name, description, transport type.

Use same CLI patterns as existing commands (comfy-table, console colors, dialoguer for input).
  </action>
  <verify>`cargo check -p boternity-api` compiles the MCP CLI module</verify>
  <done>All 10 MCP CLI subcommands defined and implemented with consistent CLI patterns</done>
</task>

<task type="auto">
  <name>Task 2: Wire MCP command dispatch in main CLI</name>
  <files>crates/boternity-api/src/cli/mod.rs</files>
  <action>
Wire the MCP command dispatch in the main CLI match arm.

In the main command dispatcher (wherever Commands are matched), add:
```rust
Commands::Mcp { action } => mcp::handle_mcp_command(action, &data_dir, &db_pool).await,
```

Or follow the existing dispatch pattern used by other subcommands (Workflow, Message, etc.).

The handler function:
```rust
pub async fn handle_mcp_command(
    command: McpCommand,
    data_dir: &Path,
    db_pool: &DatabasePool,
) -> anyhow::Result<()>
```

Dispatches to individual handle_* functions based on the McpCommand variant.

Ensure the MCP CLI follows the same pattern as existing subcommands for:
- Error display (anyhow error chain)
- JSON output mode (--json flag)
- Quiet mode (--quiet flag)
  </action>
  <verify>`cargo check -p boternity-api` compiles with MCP dispatch wired</verify>
  <done>MCP CLI commands are accessible via `bnity mcp {subcommand}` and dispatched correctly</done>
</task>

</tasks>

<verification>
- `cargo check -p boternity-api` passes
- `bnity mcp --help` shows all subcommands
- `bnity mcp presets` lists available presets
- `bnity mcp add`, `remove`, `list`, `status`, `connect`, `disconnect`, `serve`, `test-tool`, `set-credential` all have defined handlers
</verification>

<success_criteria>
Complete MCP CLI surface: users can add/remove/list servers (global and per-bot), check status, connect/disconnect at runtime, start the MCP server (HTTP or stdio), test tool calls, manage credentials, and browse presets. All commands follow existing CLI conventions.
</success_criteria>

<output>
After completion, create `.planning/phases/09-mcp-integration/09-09-SUMMARY.md`
</output>
