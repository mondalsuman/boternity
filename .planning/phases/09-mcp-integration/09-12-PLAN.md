---
phase: 09-mcp-integration
plan: 12
type: execute
wave: 6
depends_on: ["09-10", "09-11"]
files_modified:
  - apps/web/src/lib/api/mcp.ts
  - apps/web/src/types/mcp.ts
  - apps/web/src/routes/bots/$botId/mcp.tsx
  - apps/web/src/components/mcp/server-list.tsx
  - apps/web/src/components/mcp/tool-inventory.tsx
  - apps/web/src/components/mcp/audit-log.tsx
  - apps/web/src/routes/bots/$botId/route.tsx
autonomous: true

must_haves:
  truths:
    - "Web UI has a dedicated MCP tab per bot"
    - "User can see connected servers, available tools, and connection status"
    - "User can browse tool inventory with descriptions and input schemas"
    - "Audit log is visible in the MCP tab"
    - "User can connect/disconnect servers from the web UI"
  artifacts:
    - path: "apps/web/src/routes/bots/$botId/mcp.tsx"
      provides: "MCP tab page"
      min_lines: 50
      contains: "McpPage"
    - path: "apps/web/src/lib/api/mcp.ts"
      provides: "API client for MCP endpoints"
      contains: "listMcpServers"
    - path: "apps/web/src/types/mcp.ts"
      provides: "TypeScript MCP types"
      contains: "McpServerConfig"
  key_links:
    - from: "apps/web/src/routes/bots/$botId/mcp.tsx"
      to: "apps/web/src/lib/api/mcp.ts"
      via: "TanStack Query hooks"
      pattern: "useQuery"
    - from: "apps/web/src/routes/bots/$botId/route.tsx"
      to: "apps/web/src/routes/bots/$botId/mcp.tsx"
      via: "tab navigation"
      pattern: "mcp"
---

<objective>
Build the web UI MCP management page: dedicated MCP tab per bot showing connected servers, tool inventory, connection status, and audit log.

Purpose: Per locked decision, the web UI has a "dedicated MCP tab per bot showing connected servers, available tools, connection status" and a "browsable tool inventory." This is the user-facing interface for managing MCP connections alongside the CLI.
Output: MCP tab page with server list, tool inventory, and audit log components.
</objective>

<execution_context>
@/Users/smxaz7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/smxaz7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mcp-integration/09-RESEARCH.md
@apps/web/src/routes/bots/$botId/route.tsx
@apps/web/src/routes/bots/$botId/skills.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types and API client</name>
  <files>apps/web/src/types/mcp.ts, apps/web/src/lib/api/mcp.ts</files>
  <action>
**types/mcp.ts -- TypeScript types mirroring Rust serde representation:**

```typescript
export type McpTransportType = 'stdio' | 'streamable_http' | 'sse';
export type McpConnectionStatus = 'connected' | 'disconnected' | 'error' | 'connecting';
export type McpAuditDirection = 'client' | 'server';

export interface McpServerConfig {
  name: string;
  transport: McpTransportType;
  command?: string;
  args: string[];
  url?: string;
  credential_key?: string;
  enabled: boolean;
  preset?: string;
  allowed_tools: string[];
  denied_tools: string[];
  sampling_budget_tokens?: number;
}

export interface McpConnection {
  id: string;
  server_name: string;
  transport_type: McpTransportType;
  status: McpConnectionStatus;
  bot_id?: string;
  connected_at?: string;
  disconnected_at?: string;
  last_health_ping?: string;
  error_message?: string;
  tool_count: number;
  resource_count: number;
  prompt_count: number;
}

export interface McpToolInfo {
  name: string;
  description: string;
  server_name: string;
  input_schema: Record<string, unknown>;
  original_description_hash: string;
}

export interface McpAuditEntry {
  id: string;
  direction: McpAuditDirection;
  event_type: string;
  server_name?: string;
  bot_id?: string;
  tool_name?: string;
  duration_ms?: number;
  success: boolean;
  error?: string;
  sanitized: boolean;
  token_usage?: number;
  timestamp: string;
}

export interface McpServerPreset {
  name: string;
  display_name: string;
  description: string;
  transport: McpTransportType;
  requires_credential: boolean;
}

export interface McpBotOverride {
  additional_servers: string[];
  removed_servers: string[];
  tool_permissions: Record<string, { allowed: string[]; denied: string[] }>;
}
```

**lib/api/mcp.ts -- API client functions:**

```typescript
export async function listMcpServers(botSlug?: string): Promise<McpServerConfig[]>
export async function addMcpServer(config: McpServerConfig): Promise<McpServerConfig>
export async function removeMcpServer(name: string): Promise<void>
export async function listMcpConnections(botId?: string): Promise<McpConnection[]>
export async function connectMcpServer(name: string): Promise<{ tools: number }>
export async function disconnectMcpServer(name: string): Promise<void>
export async function listMcpTools(botId?: string): Promise<McpToolInfo[]>
export async function callMcpTool(server: string, tool: string, args: Record<string, unknown>): Promise<unknown>
export async function queryMcpAudit(params: { server?: string; bot_id?: string; direction?: string; limit?: number }): Promise<McpAuditEntry[]>
export async function listMcpPresets(): Promise<McpServerPreset[]>
export async function getBotMcpOverrides(botId: string): Promise<McpBotOverride>
export async function setBotMcpOverrides(botId: string, overrides: McpBotOverride): Promise<void>
```

Follow the existing API client pattern (use fetch, handle errors, parse JSON envelope).
  </action>
  <verify>`cd /Users/smxaz7/Desktop/Suman/Projects/gh/boternity/apps/web && npx tsc --noEmit 2>&1 | head -20` -- types compile</verify>
  <done>TypeScript MCP types and API client functions cover all REST endpoints</done>
</task>

<task type="auto">
  <name>Task 2: MCP tab page and components</name>
  <files>apps/web/src/routes/bots/$botId/mcp.tsx, apps/web/src/components/mcp/server-list.tsx, apps/web/src/components/mcp/tool-inventory.tsx, apps/web/src/components/mcp/audit-log.tsx, apps/web/src/routes/bots/$botId/route.tsx</files>
  <action>
**Add MCP tab to bot detail navigation (route.tsx):**

Update the tab navigation in the bot detail layout route to include an "MCP" tab:
```tsx
{ label: "MCP", path: "mcp" }
```
Following the same pattern as existing tabs (Chat, Soul, Skills, Settings).

Register the route in TanStack Router (add to route tree if needed).

**mcp.tsx -- Main MCP tab page:**

Three-section layout:
1. **Connected Servers** section (top) -- ServerList component
2. **Tool Inventory** section (middle) -- ToolInventory component
3. **Audit Log** section (bottom, collapsible) -- AuditLog component

Plus action buttons:
- "Add Server" button opening a dialog (with preset quick-add buttons)
- "Connect All" / "Disconnect All" buttons

Use TanStack Query for data fetching with auto-refresh (staleTime: 10s for connections).

**server-list.tsx component:**
- Card grid showing each configured server
- Each card shows: name, transport type, status badge (green/red/yellow), tool count, last ping time
- Actions per card: Connect/Disconnect button, Remove button with confirmation
- Status badge colors: connected=green, disconnected=gray, error=red, connecting=yellow
- Connection metadata displayed on hover or click

**tool-inventory.tsx component:**
- Grouped by server name (collapsible sections)
- Each tool shows: name, description (sanitized), input schema (collapsible JSON)
- Search/filter bar to find tools by name
- "Test" button per tool opens a dialog to send test input and see result
- Badge showing if description was sanitized

**audit-log.tsx component:**
- Sortable table with columns: time, direction, event_type, server, tool, duration, status
- Filter by direction (client/server), status (success/error), server
- Paginated (default 50 entries)
- Auto-refresh option (toggle)

Use shadcn/ui components: Card, Badge, Table, Dialog, Button, Input, Collapsible, Select.
Use Tailwind for layout. Follow existing component patterns from skills.tsx and settings.tsx.
  </action>
  <verify>`cd /Users/smxaz7/Desktop/Suman/Projects/gh/boternity/apps/web && npx tsc --noEmit 2>&1 | head -20` -- no type errors in MCP components</verify>
  <done>Web UI MCP tab shows servers, tools, and audit log with interactive management</done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- MCP tab appears in bot detail navigation
- Server list shows configured servers with status
- Tool inventory is browsable with search
- Audit log displays recent MCP activity
- Connect/disconnect actions work via API
</verification>

<success_criteria>
Web UI has a fully functional MCP tab per bot: server cards with status badges, browsable tool inventory with search and test capability, audit log table with filtering, and add server dialog with preset quick-add. All data fetched via TanStack Query with auto-refresh.
</success_criteria>

<output>
After completion, create `.planning/phases/09-mcp-integration/09-12-SUMMARY.md`
</output>
